<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>종수술 등급 + KCD 코드 통합 검색</title>
<style>
  :root{
    --bg:#f6f8ff; --card:#ffffff; --ink:#14203a; --muted:#66759a; --line:#e6ecf7;
    --g1:#5b8cff; --g2:#22d3ee; --accent:#00c2a8; --radius:18px; --shadow:0 12px 36px rgba(20,32,58,.08);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:
      radial-gradient(900px 500px at 10% -10%, #eaf1ff 0%, transparent 60%),
      radial-gradient(900px 500px at 120% 0%, #f2fffb 0%, transparent 60%),
      var(--bg);
    color:var(--ink);font:15px/1.6 "Pretendard",ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Arial;
    padding:28px;display:flex;justify-content:center;align-items:flex-start
  }
  .wrap{width:min(1100px,100%)}
  .title{margin:0 0 10px;text-align:center;font-weight:900;letter-spacing:.3px;font-size:clamp(22px,3.4vw,34px)}
  .subtitle{margin:0 0 18px;text-align:center;color:var(--muted)}
  .panel{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
  .searchrow{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
  .searchbox{position:relative}
  .searchbox input{width:100%;height:58px;border:1px solid var(--line);border-radius:14px;padding:0 56px 0 16px;font-size:16px;outline:none;background:#fff;color:var(--ink)}
  .searchbox input:focus{border-color:#7aa2ff;box-shadow:0 0 0 5px #e8eeff}
  .btn{height:58px;padding:0 22px;border:0;border-radius:14px;font-weight:900;letter-spacing:.2px;cursor:pointer;
       background:linear-gradient(135deg,var(--g1),var(--g2));color:#fff;box-shadow:0 10px 24px rgba(91,140,255,.28)}
  .status{margin-top:8px;font-size:12px;color:var(--muted);text-align:right}
  /* autocomplete */
  .ac{position:absolute;left:0;right:0;top:62px;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);overflow:hidden;z-index:10;display:none}
  .ac.open{display:block}
  .ac ul{list-style:none;margin:0;padding:6px;max-height:360px;overflow:auto}
  .ac li{padding:10px 12px;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;gap:10px}
  .ac li:hover{background:#f6f9ff}
  .ac .code{font:12px/1.2 ui-monospace,Consolas,Menlo;color:#2f5bff;background:#eef3ff;border:1px solid #d8e2ff;padding:2px 6px;border-radius:6px}
  .ac .desc{font-size:12px;color:#6b7aa6}

  /* result blocks */
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px}
  .card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
  .card h3{
    margin:0;padding:14px 16px;font-size:16px;letter-spacing:.3px;color:#fff;
    background:linear-gradient(135deg,var(--g1),var(--g2));text-align:center
  }
  .card .body{padding:24px 16px;display:flex;align-items:center;justify-content:center;min-height:140px}
  .big{font-size:56px;font-weight:900;line-height:1}
  .muted{color:var(--muted)}
  /* KCD list */
  .kcd{margin-top:14px}
  .kcd h3{margin:0;padding:14px 16px;font-size:16px;letter-spacing:.3px;color:#fff;background:linear-gradient(135deg,var(--g1),var(--g2));text-align:center;border-radius:12px 12px 0 0}
  .kcd .body{border:1px solid var(--line);border-top:0;background:#fff;border-radius:0 0 12px 12px;padding:12px}
  .kcd ul{margin:0;padding-left:20px}
  .kcd li{padding:6px 0;border-bottom:1px dashed var(--line)}
  .kcd li:last-child{border-bottom:0}
  .error{color:#c0392b}
</style>
</head>
<body>
  <main class="wrap">
    <h1 class="title">종수술 등급 + KCD 코드 통합 검색</h1>
    <p class="subtitle">수술명을 치면 등급(1~3, 1~5)을 즉시 표시하고, KCD 코드/명칭을 함께 보여줍니다. KCD 엑셀은 <code>/assets/KCD-9.xlsx</code>만 사용합니다.</p>

    <section class="panel">
      <div class="searchrow">
        <div class="searchbox">
          <input id="q" type="text" placeholder="예: 대장용종절제술 / K63.5 / 결장의 용종…" aria-label="검색" autocomplete="off" />
          <div class="ac" id="ac"><ul id="acList"></ul></div>
        </div>
        <button id="btn" class="btn">검색</button>
      </div>
      <div class="status" id="status">KCD 로딩 대기…</div>

      <div class="grid2">
        <div class="card">
          <h3>1~3종 수술비</h3>
          <div class="body" id="rA"><span class="muted">검색 후 표시</span></div>
        </div>
        <div class="card">
          <h3>1~5종 수술비</h3>
          <div class="body" id="rB"><span class="muted">검색 후 표시</span></div>
        </div>
      </div>

      <div class="kcd">
        <h3>KCD 결과</h3>
        <div class="body"><ul id="kcdList"><li class="muted">검색 후 표시</li></ul></div>
      </div>
    </section>
  </main>

  <script>
  /* ======================================================
     0) KCD 엑셀 위치 (공백 포함 파일명은 %20 인코딩도 시도)
  ====================================================== */
  const KCD_XLSX_CANDIDATES = [
    "/assets/KCD-9.xlsx",
    "/assets/KCD-9%20.xlsx" // 혹시 모를 공백 대응(무시돼도 OK)
  ];

  /* ===== 기본 DOM ===== */
  const elQ = document.getElementById('q');
  const elBtn = document.getElementById('btn');
  const elAC = document.getElementById('ac');
  const elACList = document.getElementById('acList');
  const elStatus = document.getElementById('status');
  const elRA = document.getElementById('rA');
  const elRB = document.getElementById('rB');
  const elK = document.getElementById('kcdList');

  const nz = v => (v ?? '').toString();
  const nkey = s => nz(s).replace(/\s+/g,'').trim();
  const isKcdCode = s => /^[A-TV-Z]\d{2}(\.\d+)?$/i.test(nz(s).trim());
  const normalizeCode = c => nz(c).trim().toUpperCase().replace(/\s+/g,'');

  /* ===== xlsx.js 로드 ===== */
  (function ensureXLSX(){
    if(window.XLSX) return;
    const s=document.createElement('script');
    s.src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js";
    document.head.appendChild(s);
  })();

  /* ===== KCD 저장소 ===== */
  let READY=false;
  let KCD_BY_CODE = new Map();   // 'K63.5' 또는 'K635' → '결장의 용종'
  let KCD_NAME_IDX = [];         // [{code,name}] 자동완성용

  function addKcdRow(code, name){
    const c = normalizeCode(code);
    const n = nz(name).trim();
    if(!isKcdCode(c) || !n) return;
    const cNoDot = c.replace('.','');
    if(!KCD_BY_CODE.has(c)){ KCD_BY_CODE.set(c,n); KCD_NAME_IDX.push({code:c,name:n}); }
    if(cNoDot!==c && !KCD_BY_CODE.has(cNoDot)) KCD_BY_CODE.set(cNoDot,n);
  }

  function parseTwoCols(sheet){
    const rows = XLSX.utils.sheet_to_json(sheet, {header:1, defval:"", raw:false, blankrows:false});
    for(const r of rows){
      const code = nz(r[0]).trim();
      const name = nz(r[1]).trim();
      if(isKcdCode(code) && name) addKcdRow(code, name);
    }
  }

  async function fetchAB(url){
    const res = await fetch(url, {cache:"no-cache"});
    if(!res.ok) throw new Error(`HTTP ${res.status} @ ${url}`);
    return await res.arrayBuffer();
  }

  async function loadKCD(){
    elStatus.textContent = "KCD 로딩 중…";
    const errors=[];
    for(const url of KCD_XLSX_CANDIDATES){
      try{
        const ab = await fetchAB(url);
        const wb = XLSX.read(ab, {type:'array'});
        const sh = wb.Sheets[wb.SheetNames[0]];
        parseTwoCols(sh);
        elStatus.textContent = `KCD 로드 완료 (${KCD_BY_CODE.size}개)`;
        return true;
      }catch(e){ errors.push(e.message); }
    }
    elStatus.innerHTML = `<span class="error">KCD XLSX 로드 실패</span>`;
    elK.innerHTML = `<li class="error">엑셀을 /assets/KCD-9.xlsx 로 올렸는지 확인하세요.<br>${errors.join(' | ')}</li>`;
    return false;
  }

  /* ===== 수술 RAW =====
     네가 쓰던 ‘앞 2글자(숫자/X) + (괄호설명,선택) + 수술명’ 포맷을
     그대로 붙여넣으면 됨. (예시는 짧게) */
  const RAW_DATA = String.raw`
12(내시경적) 위용종제거술
12결장용종절제술
23담낭절제술(개복 또는 복강경)
23갑상선 전절제술
12충수절제술
  `;

  function parseOps(text){
    const out=[], seen=new Set();
    const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean).filter(s=>!s.startsWith('//'));
    const re = /^\s*([0-9X])([0-9X])\s*(?:\(([^)]+)\))?\s*(.+?)\s*$/;
    for(const line of lines){
      const m=line.match(re); if(!m) continue;
      const aTier=(m[1]>='1'&&m[1]<='3')?Number(m[1]):null;
      const bTier=(m[2]>='1'&&m[2]<='5')?Number(m[2]):null;
      const hint=m[3]||''; const name=m[4];
      const id=`${name}||${hint}||${aTier??'NA'}||${bTier??'NA'}`;
      if(seen.has(id)) continue; seen.add(id);
      out.push({name, aTier, bTier, kcdHint:hint});
    }
    return out;
  }
  const OP_DB = parseOps(RAW_DATA);

  /* ===== 렌더 ===== */
  const renderTier = (el, tier, hint) => {
    el.innerHTML = (tier!=null)
      ? `<div class="big">${tier}종</div>${hint?`<div class="muted" style="margin-top:6px">${hint}</div>`:''}`
      : `<span class="muted">해당 없음</span>`;
  };
  function renderKcdList(pairs){
    if(!pairs.length){ elK.innerHTML = `<li class="muted">관련 KCD 없음</li>`; return; }
    elK.innerHTML = pairs.map(p=> `<li><b>${p.code}</b> — ${p.name||''}</li>`).join('');
  }

  /* ===== 매칭 ===== */
  function normalizeQueryName(s){
    let t = nz(s);
    t = t.replace(/[()\[\]]/g,' ');
    t = t.replace(/내시경|복강경|수술|절제술|제거술|지혈술|봉합술|성형술|고주파|레이저|치환술|조성술|문합술|이식술/g,' ');
    t = t.replace(/대장/g,'결장'); // 용어 정규화
    t = t.replace(/맹장/g,'충수');
    return t.replace(/\s+/g,' ').trim();
  }
  function kcdFromName(keyword, limit=20){
    const norm = normalizeQueryName(keyword);
    const tokens = norm.split(/\s+/).filter(Boolean);
    const out=[];
    outer: for(const r of KCD_NAME_IDX){
      const key = nkey(r.name);
      for(const t of tokens){ if(!key.includes(nkey(t))) continue outer; }
      out.push({code:r.code, name:r.name});
      if(out.length>=limit) break;
    }
    if(!out.length){ // 토큰 매칭이 없으면 포함검색
      for(const r of KCD_NAME_IDX){
        if(nkey(r.name).includes(nkey(norm))){
          out.push({code:r.code, name:r.name});
          if(out.length>=limit) break;
        }
      }
    }
    return out;
  }

  function showByOp(opName){
    const rec = OP_DB.find(x=>x.name===opName) || OP_DB.find(x=> nkey(x.name)===nkey(opName) );
    if(!rec){ renderTier(elRA,null,''); renderTier(elRB,null,''); renderKcdList([]); return; }
    renderTier(elRA, rec.aTier, '1~3종 결과');
    renderTier(elRB, rec.bTier, '1~5종 결과');
    // 1) 힌트가 KCD 코드처럼 생겼다면 우선 노출
    let pairs=[];
    if(rec.kcdHint && isKcdCode(rec.kcdHint)){
      const code = normalizeCode(rec.kcdHint);
      const name = KCD_BY_CODE.get(code) || KCD_BY_CODE.get(code.replace('.',''));
      if(name) pairs.push({code, name});
    }
    // 2) 수술명으로 검색
    const found = kcdFromName(rec.name, 20);
    pairs = pairs.concat(found.filter(p=> !pairs.some(x=>x.code===p.code)));
    renderKcdList(pairs);
  }

  function showByCode(codeInput){
    const code = normalizeCode(codeInput);
    const name = KCD_BY_CODE.get(code) || KCD_BY_CODE.get(code.replace('.',''));
    renderTier(elRA,null,''); renderTier(elRB,null,'');
    renderKcdList(name ? [{code, name}] : []);
  }

  /* ===== 자동완성 ===== */
  function suggest(q){
    const k = nkey(q); if(!k || !READY) return [];
    const out=[];
    if(isKcdCode(q)){
      const code = normalizeCode(q);
      const name = KCD_BY_CODE.get(code) || KCD_BY_CODE.get(code.replace('.',''));
      if(name) out.push({type:'code', code, label:name});
    }
    for(const r of OP_DB){
      if(nkey(r.name).includes(k)){ out.push({type:'op', label:r.name}); if(out.length>=30) break; }
    }
    for(const r of KCD_NAME_IDX){
      if(nkey(r.name).includes(k)){ out.push({type:'kcd', label:r.name, code:r.code}); if(out.length>=30) break; }
    }
    return out.slice(0,30);
  }
  function openAC(items){
    if(!items.length){ elAC.classList.remove('open'); elACList.innerHTML=''; return; }
    elACList.innerHTML = items.map((it,i)=>{
      if(it.type==='op')   return `<li data-i="${i}" data-t="op"><span>${it.label}</span><span class="desc">수술 · 등급 표시</span></li>`;
      if(it.type==='code') return `<li data-i="${i}" data-t="code"><span>${it.label}</span><span class="code">${it.code}</span></li>`;
      return `<li data-i="${i}" data-t="kcd"><span>${it.label}</span><span class="code">${it.code}</span></li>`;
    }).join('');
    elAC.classList.add('open');
  }
  const closeAC = ()=> elAC.classList.remove('open');

  /* ===== 검색 ===== */
  function doSearch(){
    const q = elQ.value.trim(); if(!q || !READY) return;
    if(isKcdCode(q)) { showByCode(q); return; }
    const ops = OP_DB.filter(r=> nkey(r.name).includes(nkey(q))).sort((a,b)=>a.name.length-b.name.length);
    if(ops.length){ showByOp(ops[0].name); return; }
    // 수술명이 아니면 KCD 명칭으로 직접 검색해 노출
    renderTier(elRA,null,''); renderTier(elRB,null,'');
    renderKcdList( kcdFromName(q, 20) );
  }

  /* ===== 이벤트 ===== */
  elBtn.addEventListener('click', doSearch);
  elQ.addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); });
  elQ.addEventListener('input', ()=> READY && openAC(suggest(elQ.value)));
  elQ.addEventListener('focus', ()=> READY && openAC(suggest(elQ.value)));
  elQ.addEventListener('blur', ()=> setTimeout(closeAC,120));
  elACList.addEventListener('click', (e)=>{
    const li = e.target.closest('li'); if(!li) return;
    const idx = Number(li.dataset.i);
    const items = suggest(elQ.value);
    const it = items[idx]; if(!it) return;
    if(it.type==='op'){ elQ.value = it.label; showByOp(it.label); }
    else if(it.type==='code'){ elQ.value = it.code; showByCode(it.code); }
    else { elQ.value = it.label; renderTier(elRA,null,''); renderTier(elRB,null,''); renderKcdList([{code:it.code, name:it.label}]); }
    closeAC();
  });

  /* ===== 부팅: KCD가 성공해야 검색 활성화 ===== */
  (async()=>{
    // xlsx 로딩 대기
    await new Promise(r=>{
      if(window.XLSX) return r();
      const t=setInterval(()=>{ if(window.XLSX){ clearInterval(t); r(); } },50);
    });
    const ok = await loadKCD();
    if(!ok){ elQ.disabled=true; elBtn.disabled=true; return; }
    READY=true; elQ.disabled=false; elBtn.disabled=false;
    elStatus.textContent += " · 검색 가능";
  })();
  </script>
</body>
</html>
