<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>질병 종수술 분류표 · KCD 매핑</title>
<style>
:root{
  --bg:#f7f9ff; --card:#fff; --ink:#182340; --muted:#5b6b8c; --line:#e6ecf7;
  --brand:#3a64ff; --accent:#00c2a8; --radius:16px; --shadow:0 10px 30px rgba(15,25,55,.08);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:
    radial-gradient(900px 500px at 10% -10%, #ebf2ff 0%, transparent 60%),
    radial-gradient(900px 500px at 120% 0%, #f2fffb 0%, transparent 60%),
    var(--bg);
  color:var(--ink);font:14px/1.65 Pretendard,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Arial;
  padding:28px;display:flex;justify-content:center;align-items:flex-start
}
.wrap{width:min(1200px,100%)}
.title{margin:0 0 8px;font-weight:900;font-size:clamp(22px,3.4vw,34px);text-align:center}
.subtitle{margin:0 0 14px;color:var(--muted);text-align:center}

.panel{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
.controls{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
.searchbox input{width:100%;height:52px;border:1px solid var(--line);border-radius:14px;padding:0 56px 0 16px;font-size:16px;background:#fff}
.searchbox input:focus{border-color:var(--brand);box-shadow:0 0 0 4px #e8eeff;outline:0}
.btn{height:52px;padding:0 18px;border:0;border-radius:14px;font-weight:900;cursor:pointer;color:#fff;
     background:linear-gradient(135deg,var(--brand),#2e53d9);box-shadow:0 8px 20px rgba(58,100,255,.25)}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 0}
.tbtn{border:1px solid #dbe3ff;background:#eef3ff;color:#3047c8;border-radius:10px;padding:8px 10px;font-weight:800;cursor:pointer}
.tbtn.primary{border:0;color:#fff;background:linear-gradient(135deg,#00c2a8,#3a64ff)}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
.card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
.card .hd{
  padding:14px 16px;border-bottom:1px solid var(--line);font-size:16px;font-weight:900;text-align:center;
  background:linear-gradient(135deg,#00c2a8,#3a64ff);color:#fff
}
.tierbar{display:flex;gap:8px;justify-content:center;padding:10px;border-bottom:1px solid var(--line);background:#fafcff}
.seg{padding:8px 12px;border-radius:10px;border:0;color:#fff;font-weight:800;cursor:pointer;
     background:linear-gradient(135deg,#8fe3d6,#00b3a3)}
.list{padding:10px 14px}
.item{padding:8px 0;border-bottom:1px dashed var(--line)}
.row{display:flex;justify-content:space-between;gap:10px;align-items:center}
.name{font-weight:700}
.meta{color:#60709a}
.code{font-family:ui-monospace,Consolas,Menlo,monospace;background:#eef3ff;border:1px solid #d9e2ff;
      padding:2px 8px;border-radius:999px;color:#2f5bff;margin-left:6px}
.chips{margin-top:6px}
.kcdbtn{margin-left:8px}
.note{color:var(--muted);font-size:12px}
.hide{display:none!important}

/* KCD picker */
.kcdpanel{position:fixed;right:16px;bottom:16px;left:16px;background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow);padding:12px;max-width:1200px;margin:auto}
.kcdrow{display:grid;grid-template-columns:1fr 160px;gap:8px;margin:6px 0}
.kcdrow input{height:44px;border:1px solid var(--line);border-radius:10px;padding:0 12px}
.kcdrow .sel{height:44px;border-radius:10px;border:1px solid var(--line);background:#fff}
.suggestions{margin-top:6px;border:1px solid var(--line);border-radius:10px;max-height:180px;overflow:auto}
.suggestions div{padding:8px 10px;border-bottom:1px dashed #edf1fb;cursor:pointer}
.suggestions div:hover{background:#f6f9ff}
.badge{display:inline-flex;align-items:center;gap:6px;margin-right:6px;margin-top:6px;padding:4px 8px;border-radius:999px;background:#eef6ff;border:1px solid #cfe2ff}
.badge b{font-family:ui-monospace}
.badge .x{cursor:pointer;color:#567}
</style>
</head>
<body>
<main class="wrap">
  <h1 class="title">질병 종수술 분류표</h1>
  <p class="subtitle">특정 등급만 표시 · KCD 다중 입력/자동완성 · 저장/내보내기</p>

  <section class="panel">
    <div class="controls">
      <div class="searchbox"><input id="q" placeholder="예: 용종, 담낭절제, 갑상선, 충수…" aria-label="검색"/></div>
      <button id="btnSearch" class="btn">검색</button>
    </div>
    <div class="toolbar">
      <button id="btnImport" class="tbtn">CSV/JSON 불러오기</button>
      <button id="btnExport" class="tbtn">매핑 JSON 내보내기</button>
      <button id="btnSave" class="tbtn primary">로컬 저장</button>
      <button id="btnLoad" class="tbtn">로컬 불러오기</button>
      <input id="fileIO" type="file" accept=".csv,.json" class="hide"/>
      <span class="note">CSV 헤더: code,ko,eng (KCD 사전) / 또는 “매핑 JSON” 재불러오기</span>
    </div>

    <div class="grid">
      <div class="card">
        <div class="hd">1~3종 수술비</div>
        <div class="tierbar" id="barA"></div>
        <div class="list" id="listA"></div>
      </div>
      <div class="card">
        <div class="hd">1~5종 수술비</div>
        <div class="tierbar" id="barB"></div>
        <div class="list" id="listB"></div>
      </div>
    </div>
  </section>
</main>

<!-- KCD 매핑 패널 -->
<div id="panelKCD" class="kcdpanel hide">
  <div class="kcdrow">
    <input id="fieldProc" readonly />
    <div style="display:flex;gap:8px">
      <button id="btnClose" class="tbtn" style="width:100%">닫기</button>
    </div>
  </div>
  <div class="kcdrow">
    <input id="fieldSearch" placeholder="KCD 코드 또는 병명 (예: K35.9, 충수염)"/>
    <select id="fieldPick" class="sel"><option value="">선택</option></select>
  </div>
  <div id="boxSugg" class="suggestions hide"></div>
  <div class="kcdrow">
    <input id="fieldChosen" placeholder="선택된 코드" />
    <div style="display:flex;gap:8px">
      <button id="btnAdd" class="tbtn primary" style="width:100%">코드 추가</button>
    </div>
  </div>
  <div id="chipBox" style="padding:8px 0"></div>
</div>

<script>
/* 0) 예시 KCD 사전(필요시 CSV/JSON으로 대체 로드) */
let KCD_DB = [
  {code:"K31.7", ko:"위의 폴립(용종)"},{code:"K63.5", ko:"대장의 폴립(용종)"},
  {code:"K62.1", ko:"직장의 폴립(용종)"},{code:"K92.2", ko:"위장관 출혈, 상세불명"},
  {code:"K80.1", ko:"담낭의 담석증, 담낭염 동반"},{code:"K81.1", ko:"만성 담낭염"},
  {code:"K80.3", ko:"담관의 담석"},{code:"K35.9", ko:"급성 충수염, 상세불명"},
  {code:"C73", ko:"갑상선의 악성 신생물"},{code:"D34.0", ko:"갑상선의 양성 신생물"},
  {code:"H25.9", ko:"노인성 백내장, 상세불명"},{code:"H26.4", ko:"후발성 백내장"},
  {code:"H40.1", ko:"원발개방각 녹내장"},{code:"H33.0", ko:"망막박리"},
  {code:"I74.3", ko:"하지의 동맥색전/혈전"},{code:"N20.0", ko:"신장의 결석"},
  {code:"N40", ko:"전립선 비대증"},{code:"I86.1", ko:"정계정맥류"},
  {code:"N43.0", ko:"음낭수종"},{code:"C50.9", ko:"유방의 악성 신생물"},
  {code:"D24.9", ko:"유방의 양성 신생물"},{code:"M51.2", ko:"추간판 탈출"},
  {code:"K25.1", ko:"위궤양, 출혈 동반"},{code:"I84.3", ko:"치핵, 혈전성"},
  {code:"K60.3", ko:"치루"},{code:"K40.9", ko:"서혜부 탈장, 상세불명"},
  {code:"K42.9", ko:"제대 탈장, 상세불명"},{code:"K43.2", ko:"반흔 탈장, 폐쇄 또는 괴저 없음"},
  /* 샘플 스샷에서 본 다중 매핑용 그룹 */
  {code:"C18", ko:"결장의 악성 신생물"},{code:"C19", ko:"직장구불결장 이행부의 악성 신생물"},
  {code:"C20", ko:"직장의 악성 신생물"},{code:"C21", ko:"항문 및 항문관의 악성 신생물"},
  {code:"D01", ko:"상피내 암종 - 기타 및 상세불명 소화기관"},
  {code:"D12", ko:"결장, 직장, 항문의 양성 신생물"},{code:"D13", ko:"기타 및 상세불명 소화기관의 양성 신생물"},
  {code:"D37", ko:"소화기관의 행동양식 불명 또는 미상의 신생물"},
  {code:"K62", ko:"항문 및 항문관의 기타 질환"},{code:"K63", ko:"장의 기타 질환"},
  {code:"H25", ko:"노인성 백내장"},{code:"H26", ko:"기타 백내장"},
  {code:"H27", ko:"수정체의 기타 장애"},{code:"H28", ko:"다른 질환에서의 수정체 장애"}
];

/* 1) 원자료 (여기에 사용자의 전체 목록을 붙여넣어도 됨) */
const RAW_DATA = String.raw`
12(내시경적) 위용종제거술
12(내시경적) 위출혈지혈술
12결장용종절제술
23담낭절제술(개복 또는 복강경)
12충수절제술
23갑상선 전절제술
21수정체 초음파유화흡입술(백내장)
`;

/* 2) 파싱 */
function norm(s){return s.replace(/\s+/g,' ').trim();}
function keyNoSpace(s){return s.replace(/\s+/g,'').trim();}
function parseProcedures(text){
  const out=[]; const seen=new Set();
  const re=/^\s*([0-9X])([0-9X])\s*(?:\(([^)]+)\))?\s*(.+?)\s*$/;
  for(const line of text.split(/\r?\n/)){
    const t=line.trim(); if(!t) continue;
    const m=t.match(re); if(!m) continue;
    const a=m[1], b=m[2], desc=m[3]?norm(m[3]):"", name=norm(m[4]);
    const aTier=(a>='1'&&a<='3')?Number(a):null;
    const bTier=(b>='1'&&b<='5')?Number(b):null;
    const id=`${name}||${desc}||${aTier??'NA'}||${bTier??'NA'}`;
    if(seen.has(id)) continue; seen.add(id);
    out.push({name,desc,aTier,bTier});
  }
  return out;
}
let DB = parseProcedures(RAW_DATA);

/* 3) 저장/불러오기 */
const STORAGE_KEY="kcd_map_v2";
function saveLocal(m){ localStorage.setItem(STORAGE_KEY, JSON.stringify(m)); }
function loadLocal(){ try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||"{}");}catch(e){return {};} }

/* 4) CSV/JSON 불러오기 */
const elFile=document.getElementById('fileIO');
document.getElementById('btnImport').onclick=()=> elFile.click();
elFile.addEventListener('change', async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  const text=await f.text();
  if(f.name.endsWith('.json')){
    try{
      // 매핑 JSON 또는 KCD 사전(JSON) 모두 지원
      const obj=JSON.parse(text);
      if(Array.isArray(obj)){ // KCD 사전
        KCD_DB = obj.map(v=>({code:v.code, ko:v.ko||v.name||v.label||""})).filter(v=>v.code);
        alert(`KCD 사전 ${KCD_DB.length}건 로드됨`);
      }else{ // 매핑 JSON
        saveLocal(obj); alert(`매핑 ${Object.keys(obj).length}건 로드됨`); doSearch();
      }
    }catch(err){ alert('JSON 파싱 오류'); }
  }else{
    // KCD 사전 CSV
    const lines=text.split(/\r?\n/).filter(Boolean);
    const hdr=lines.shift().split(',').map(s=>s.trim());
    const idxCode=hdr.findIndex(h=>/^code$/i.test(h));
    const idxKo=hdr.findIndex(h=>/^ko|name|label$/i.test(h));
    KCD_DB = lines.map(s=>{
      const cols=s.split(','); return {code:(cols[idxCode]||"").trim(), ko:(cols[idxKo]||"").trim()};
    }).filter(v=>v.code);
    alert(`KCD 사전 ${KCD_DB.length}건 로드됨`);
  }
});

/* 5) UI 렌더 */
const elQ=document.getElementById('q');
const elBtn=document.getElementById('btnSearch');
const elBarA=document.getElementById('barA');
const elBarB=document.getElementById('barB');
const elListA=document.getElementById('listA');
const elListB=document.getElementById('listB');

function group(rows,mode){
  const max=(mode==='A')?3:5; const key=(mode==='A')?'aTier':'bTier';
  const out={}; for(let i=1;i<=max;i++) out[i]=[];
  rows.forEach(r=>{ const t=r[key]; if(t!=null && out[t]) out[t].push(r); });
  return out;
}
function renderTierButtons(bar, max, cb){
  bar.innerHTML='';
  for(let i=1;i<=max;i++){
    const b=document.createElement('button'); b.className='seg'; b.textContent=`${i}종만 보기`;
    b.onclick=()=>cb(i); bar.appendChild(b);
  }
}
function renderList(container, rows){
  const map=loadLocal();
  const html=rows.map(r=>{
    const key=r.desc?`${r.name} (${r.desc})`:r.name;
    const codes=(map[key]||[]);
    return `<div class="item">
      <div class="row">
        <div><span class="name">${r.name}</span>${r.desc?` <span class="meta">(${r.desc})</span>`:""}</div>
        <div>
          <button class="tbtn kcdbtn" data-key="${encodeURIComponent(key)}">KCD 입력/수정</button>
        </div>
      </div>
      <div class="chips">${codes.map(c=>`<span class="badge"><b>${c}</b><span class="x" data-del="${encodeURIComponent(key)}::${c}">×</span></span>`).join('')}</div>
    </div>`;
  }).join('') || `<div class="note">표시할 항목이 없습니다.</div>`;
  container.innerHTML=html;
}

/* 6) 검색 */
function doSearch(){
  const k=keyNoSpace(elQ.value||"");
  const hit=DB.filter(r=> keyNoSpace(r.name).includes(k));
  const ga=group(hit,'A'); const gb=group(hit,'B');
  renderTierButtons(elBarA,3,(sel)=> renderList(elListA, ga[sel]));
  renderTierButtons(elBarB,5,(sel)=> renderList(elListB, gb[sel]));
  elListA.innerHTML='<div class="note">왼쪽 버튼으로 등급을 선택하세요.</div>';
  elListB.innerHTML='<div class="note">오른쪽 버튼으로 등급을 선택하세요.</div>';
}
elBtn.onclick=doSearch;
elQ.addEventListener('keydown',e=>{ if(e.key==='Enter') doSearch(); });

/* 7) KCD 선택 패널 */
const elPanel=document.getElementById('panelKCD');
const elProc=document.getElementById('fieldProc');
const elSch=document.getElementById('fieldSearch');
const elPick=document.getElementById('fieldPick');
const elChosen=document.getElementById('fieldChosen');
const elSugg=document.getElementById('boxSugg');
const elAdd=document.getElementById('btnAdd');
const elClose=document.getElementById('btnClose');
const elChipBox=document.getElementById('chipBox');

let currentKey=null;

function openPicker(key){
  currentKey=key; elProc.value=decodeURIComponent(key);
  elSch.value=''; elChosen.value=''; elPick.innerHTML='<option value="">선택</option>';
  elSugg.classList.add('hide'); elChipBox.innerHTML='';
  // 현재 부착 코드 칩 표시
  const map=loadLocal(); const arr=(map[decodeURIComponent(key)]||[]);
  elChipBox.innerHTML = arr.map(c=>`<span class="badge"><b>${c}</b><span class="x" data-delp="${encodeURIComponent(key)}::${c}">×</span></span>`).join('');
  elPanel.classList.remove('hide'); elSch.focus();
}
function closePicker(){ elPanel.classList.add('hide'); }

function searchKCD(q){
  const s=q.trim().toLowerCase();
  if(!s) return [];
  return KCD_DB.filter(rec=>{
    return (rec.code||'').toLowerCase().includes(s) || (rec.ko||'').toLowerCase().includes(s);
  }).slice(0,100);
}
function renderSugg(list){
  if(!list.length){ elSugg.classList.add('hide'); elPick.innerHTML='<option value="">선택</option>'; return; }
  elSugg.classList.remove('hide');
  elSugg.innerHTML=list.map(rec=>`<div data-c="${rec.code}">${rec.code} · ${rec.ko||''}</div>`).join('');
  elPick.innerHTML=['<option value="">선택</option>'].concat(list.map(rec=>`<option value="${rec.code}">${rec.code} · ${rec.ko||''}</option>`)).join('');
}
elSch.addEventListener('input',()=> renderSugg(searchKCD(elSch.value)));
elSugg.addEventListener('click',(e)=>{
  const d=e.target.closest('div'); if(!d) return;
  elChosen.value=d.dataset.c; elPick.value=d.dataset.c; elSugg.classList.add('hide');
});
elPick.addEventListener('change',()=>{ elChosen.value=elPick.value; });

elAdd.onclick=()=>{
  if(!currentKey || !elChosen.value) return;
  const k=decodeURIComponent(currentKey);
  const map=loadLocal(); const arr=new Set(map[k]||[]);
  arr.add(elChosen.value.trim()); map[k]=[...arr]; saveLocal(map);
  // 칩 즉시 갱신
  elChipBox.innerHTML = map[k].map(c=>`<span class="badge"><b>${c}</b><span class="x" data-delp="${encodeURIComponent(currentKey)}::${c}">×</span></span>`).join('');
};

elClose.onclick=closePicker;

/* 칩 삭제(리스트/패널 공통) */
document.body.addEventListener('click',(e)=>{
  const btn=e.target.closest('.tbtn.kcdbtn');
  if(btn && btn.dataset.key){ openPicker(btn.dataset.key); return; }

  const del=e.target.closest('.x');
  if(del){
    const value=del.dataset.del || del.dataset.delp; if(!value) return;
    const [encKey, code]=value.split("::");
    const key=decodeURIComponent(encKey);
    const map=loadLocal(); map[key]=(map[key]||[]).filter(c=>c!==code);
    saveLocal(map);
    if(del.dataset.del){ doSearch(); } else { openPicker(encKey); }
  }
});

/* 8) 저장/내보내기 */
document.getElementById('btnSave').onclick=()=>{ saveLocal(loadLocal()); alert("저장 완료"); };
document.getElementById('btnLoad').onclick=()=>{ alert(`저장 항목: ${Object.keys(loadLocal()).length}건`); doSearch(); };
document.getElementById('btnExport').onclick=()=>{
  const blob=new Blob([JSON.stringify(loadLocal(),null,2)],{type:"application/json"});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='kcd_mapping.json'; a.click();
};

/* 초기 */
doSearch();
</script>
</body>
</html>
