<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>질병 종수술 분류표 | 텍스트 파서 · 자동완성 · 요약카드</title>
  <style>
    :root{
      --bg:#f7f9ff; --card:#ffffff; --ink:#182340; --muted:#5b6b8c; --line:#e6ecf7;
      --brand:#3a64ff; --brand-soft:#e8eeff; --accent:#00c2a8; --radius:16px; --shadow:0 10px 30px rgba(15,25,55,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:
        radial-gradient(900px 500px at 10% -10%, #ebf2ff 0%, transparent 60%),
        radial-gradient(900px 500px at 120% 0%, #f2fffb 0%, transparent 60%),
        var(--bg);
      color:var(--ink);font:14px/1.65 "Pretendard",ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Arial;
      padding:34px;display:flex;align-items:flex-start;justify-content:center
    }
    .wrap{width:min(1200px,100%)}
    .title{margin:0 0 8px;font-weight:900;letter-spacing:.2px;font-size:clamp(22px,3.4vw,34px);text-align:center}
    .subtitle{margin:0 0 12px;color:var(--muted);text-align:center}

    .panel{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
    .controls{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center}
    .searchbox{position:relative}
    .searchbox input{width:100%;height:56px;border:1px solid var(--line);border-radius:14px;padding:0 56px 0 18px;font-size:16px;outline:none;background:#fff;color:var(--ink);box-shadow:inset 0 1px 0 rgba(0,0,0,.02)}
    .searchbox input:focus{border-color:var(--brand);box-shadow:0 0 0 4px var(--brand-soft)}
    .search-btn{height:56px;padding:0 20px;border:0;border-radius:14px;font-weight:800;letter-spacing:.2px;cursor:pointer;background:linear-gradient(180deg,var(--brand),#2e53d9);color:#fff;box-shadow:0 8px 20px rgba(58,100,255,.25)}

    .ac{position:absolute;left:0;right:0;top:60px;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);overflow:hidden;z-index:20;display:none}
    .ac.open{display:block}
    .ac ul{list-style:none;margin:0;padding:6px}
    .ac li{padding:10px 12px;border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:10px}
    .ac li:hover,.ac li.active{background:#f6f9ff}
    .ac .code{font:12px/1.2 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono";color:#2f5bff;background:#eef3ff;border:1px solid #d8e2ff;padding:2px 6px;border-radius:6px}

    .summary-card{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px 14px;background:linear-gradient(180deg,#ffffff,#fbfdff);border:1px solid var(--line);border-radius:var(--radius);padding:14px;align-items:stretch;margin-top:14px}
    .pill{display:flex;flex-direction:column;justify-content:center;align-items:flex-start;gap:6px;background:#fff;border:1px solid var(--line);padding:10px 14px;border-radius:12px;font-weight:800;min-height:64px;word-break:keep-all;overflow-wrap:anywhere}
    .pill b{font-size:12px;color:#60709a;letter-spacing:.2px}

    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    .card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .card h3{margin:0;padding:14px 16px;font-size:16px;letter-spacing:.3px;border-bottom:1px solid var(--line)}
    table{width:100%;border-collapse:collapse;font-size:14px}
    thead th{text-align:center;background:#f7faff;color:#3a4a7a;border-bottom:1px solid var(--line);padding:10px}
    tbody td{padding:12px 10px;border-bottom:1px dashed var(--line)}
    tbody tr:hover{background:#fbfcff}
    .center{text-align:center}
    .muted{color:#60709a}
    .note{color:var(--muted);font-size:12px;margin-top:10px}
    .raw-toggle{margin:10px 0 0;text-align:right}
    .raw-area{width:100%;height:160px;border:1px solid var(--line);border-radius:10px;padding:10px;font-family:ui-monospace,Consolas,Menlo,monospace;display:none}
    .raw-area.show{display:block}
    .chips{margin-top:10px;display:flex;flex-wrap:wrap;gap:8px}
    .chip{background:var(--brand-soft);color:#2a47b8;border:1px solid #d7e0ff;padding:8px 12px;border-radius:999px;font-weight:700;cursor:pointer}
  </style>
</head>
<body>
  <main class="wrap">
    <h1 class="title">질병 종수술 분류표</h1>
    <p class="subtitle">업로드한 텍스트(예: <code>12(내시경적) 위용종제거술</code>)를 파싱하여 <b>3종표(1~3)</b>와 <b>5종표(1~5)</b> 분류를 함께 보여줍니다.</p>

    <section class="panel">
      <div class="controls">
        <div class="searchbox">
          <input id="q" type="text" placeholder="예: 위용종, 용종절제, 맹장, 담낭절제, 혈전제거" aria-label="수술명 검색" />
          <div class="ac" id="ac"><ul id="acList"></ul></div>
        </div>
        <button id="searchBtn" class="search-btn">검색</button>
      </div>

      <div class="chips" aria-label="빠른검색">
        <button class="chip" data-k="용종">용종</button>
        <button class="chip" data-k="담낭">담낭</button>
        <button class="chip" data-k="갑상선">갑상선</button>
        <button class="chip" data-k="혈전">혈전</button>
        <button class="chip" data-k="자궁">자궁</button>
      </div>

      <div class="raw-toggle">
        <button id="toggleRaw" class="chip" style="padding:6px 10px">원문 보기/수정</button>
      </div>
      <textarea id="raw" class="raw-area" spellcheck="false"></textarea>

      <div id="summary" class="summary-card" style="display:none"></div>

      <div class="card" style="margin-top:14px">
        <h3>검색 결과</h3>
        <table>
          <thead>
            <tr>
              <th style="width:36%">수술명</th>
              <th style="width:16%">설명(괄호)</th>
              <th style="width:14%">3종표(1~3)</th>
              <th style="width:14%">5종표(1~5)</th>
              <th>비고</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <p class="note">
        해석 규칙: 맨 앞 두 글자(숫자 또는 X)를 기준으로 분류합니다. 예) <b>12(내시경적) 위용종제거술</b> → 3종표 <b>1종</b>, 5종표 <b>2종</b>.<br/>
        ‘X’는 해당없음(—)으로 표시합니다(예: X1, 1X, XX). 3종표는 1~3만 유효하므로 그 외(예: 4,5)는 ‘—’ 처리합니다.
      </p>
    </section>
  </main>

  <script>
    // 1) 여기에 텍스트 파일(질병종수술분류.txt) 전체를 그대로 붙여넣으세요.
    //    줄바꿈을 포함해 RAW_DATA 내용만 교체하면 됩니다.
    const RAW_DATA = String.raw`
12(내시경적) 위용종제거술
12(내시경적) 위출혈지혈술
11andrew method
11bassini repair
11halsted's operation
21IVS 수술
11Lichtenstein tension free hernioplasty
11lucas championniere's op.
11marcy's simple ringclosure
11mcvay repair
21MMK 수술
11shouldice hernioplasty
11TAPP laparoscopic hernia  repair
23Y-자 인공혈관 우회술
35Y-자 인공혈관 우회술
12가관절수술
...
`; // ← 실제 사용 시 '...'를 지우고 파일의 모든 줄을 넣으세요.

    // ======================================================================
    // 파싱 규칙
    // line = ^\s*([0-9X])([0-9X])\s*(?:\(([^)]+)\))?\s*(.+?)\s*$
    // g1=3종표 키(1~3 또는 X), g2=5종표 키(1~5 또는 X), g3=설명/괄호(옵션), g4=수술명
    // ======================================================================
    const elQ = document.getElementById('q');
    const elBtn = document.getElementById('searchBtn');
    const elBody = document.getElementById('tbody');
    const elAC = document.getElementById('ac');
    const elACList = document.getElementById('acList');
    const elSummary = document.getElementById('summary');
    const elRaw = document.getElementById('raw');
    const elToggleRaw = document.getElementById('toggleRaw');

    function normalizeSpaces(s){ return s.replace(/\s+/g,' ').trim(); }

    function parseRaw(text){
      const out = [];
      const seen = new Set();
      const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const re = /^\s*([0-9X])([0-9X])\s*(?:\(([^)]+)\))?\s*(.+?)\s*$/;
      for(const line of lines){
        const m = line.match(re);
        if(!m) continue;
        const aKey = m[1]; // 3종표
        const bKey = m[2]; // 5종표
        const desc = m[3] ? normalizeSpaces(m[3]) : '';
        const name = normalizeSpaces(m[4]);
        const aTier = (aKey>='1' && aKey<='3') ? Number(aKey) : null;
        const bTier = (bKey>='1' && bKey<='5') ? Number(bKey) : null;
        const id = `${name}||${desc}||${aTier??'NA'}||${bTier??'NA'}`;
        if(seen.has(id)) continue;
        seen.add(id);
        out.push({ name, desc, aKey, bKey, aTier, bTier, raw: line });
      }
      return out;
    }

    // 초기 데이터 세팅
    elRaw.value = RAW_DATA.trim();
    let DB = parseRaw(elRaw.value);

    // 자동완성 후보 만들기 (수술명 사전)
    function buildIndex(rows){
      const dict = new Map(); // key: normalized name -> display name
      for(const r of rows){
        const key = r.name.replace(/\s+/g,'');
        if(!dict.has(key)) dict.set(key, r.name);
      }
      return dict;
    }
    let NAME_INDEX = buildIndex(DB);

    // 자동완성
    function suggest(q){
      const key = q.replace(/\s+/g,'');
      if(!key) return [];
      const seen = new Set();
      const out = [];
      for(const r of DB){
        const nkey = r.name.replace(/\s+/g,'');
        if(nkey.includes(key) && !seen.has(nkey)){
          out.push(r.name); seen.add(nkey);
          if(out.length>=12) break;
        }
      }
      return out;
    }
    function openAC(items){
      if(!items.length){ elAC.classList.remove('open'); return; }
      elACList.innerHTML = items.map((name,i)=> `<li data-i="${i}"><strong>${name}</strong> <span class="code">제안</span></li>`).join('');
      elAC.classList.add('open');
    }
    function closeAC(){ elAC.classList.remove('open'); }

    // 렌더 보조
    const fmt3 = v => (v==null ? '—' : `${v}종`);
    const fmt5 = v => (v==null ? '—' : `${v}종`);
    const pill = (label, value, hint="") => `<span class="pill"><b>${label}</b> ${value}${hint?` <span class="muted">${hint}</span>`:""}</span>`;

    function renderSummary(query, rows){
      const total = rows.length;
      const aVals = rows.map(r=>r.aTier).filter(v=>v!=null);
      const bVals = rows.map(r=>r.bTier).filter(v=>v!=null);
      const aMin = aVals.length ? Math.min(...aVals) : null;
      const aMax = aVals.length ? Math.max(...aVals) : null;
      const bMin = bVals.length ? Math.min(...bVals) : null;
      const bMax = bVals.length ? Math.max(...bVals) : null;

      elSummary.innerHTML = [
        pill('검색어', query || '—'),
        pill('결과 수', String(total)),
        pill('3종표 범위', aMin==null?'—':`${aMin}~${aMax}종`),
        pill('5종표 범위', bMin==null?'—':`${bMin}~${bMax}종`),
        pill('참고', '앞자리=3종표, 뒷자리=5종표', 'X=해당없음')
      ].join('');
      elSummary.style.display = 'grid';
    }

    function renderTable(rows){
      if(!rows.length){
        elBody.innerHTML = `<tr><td class="center" colspan="5">검색 결과가 없습니다. 다른 표현으로 시도해 주세요.</td></tr>`;
        return;
      }
      const html = rows.map(r=>{
        return `<tr>
          <td><b>${r.name}</b></td>
          <td class="center">${r.desc||'—'}</td>
          <td class="center">${fmt3(r.aTier)}</td>
          <td class="center">${fmt5(r.bTier)}</td>
          <td class="muted">${r.aKey}${r.bKey} · 원문: ${r.raw}</td>
        </tr>`;
      }).join('');
      elBody.innerHTML = html;
    }

    function doSearch(){
      const q = elQ.value.trim();
      if(!q){ elBody.innerHTML=''; elSummary.style.display='none'; return; }
      const key = q.replace(/\s+/g,'');
      const rows = DB.filter(r=> r.name.replace(/\s+/g,'').includes(key));
      // 같은 수술명이 너무 많으면 상위 200까지만 출력(중복 방지용)
      const limited = rows.slice(0, 200);
      renderSummary(q, rows);
      renderTable(limited);
      closeAC();
    }

    // 이벤트
    elQ.addEventListener('input', ()=>{ openAC(suggest(elQ.value)); });
    elQ.addEventListener('focus', ()=>{ openAC(suggest(elQ.value)); });
    elQ.addEventListener('blur', ()=>{ setTimeout(closeAC,150); });
    elACList.addEventListener('click', (e)=>{
      const li = e.target.closest('li'); if(!li) return;
      const idx = Number(li.dataset.i);
      const items = suggest(elQ.value);
      const name = items[idx];
      if(name){ elQ.value = name; doSearch(); }
    });

    document.querySelectorAll('.chip').forEach(ch=> ch.addEventListener('click', ()=>{
      elQ.value = ch.dataset.k; doSearch();
    }));
    elBtn.addEventListener('click', doSearch);
    elQ.addEventListener('keydown', (e)=>{ if(e.key==='Enter') doSearch(); });

    // 원문 보기/수정 토글
    elToggleRaw.addEventListener('click', ()=>{
      elRaw.classList.toggle('show');
    });

    // 원문이 바뀌면 즉시 재파싱
    elRaw.addEventListener('input', ()=>{
      DB = parseRaw(elRaw.value);
      NAME_INDEX = buildIndex(DB);
      if(elQ.value.trim()) doSearch();
    });

    // 초기 렌더(빈)
    elBody.innerHTML = '';
  </script>
</body>
</html>
