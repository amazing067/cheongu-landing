<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>질병 종수술 분류 + KCD 코드</title>
<style>
  :root{
    --bg:#f6f8ff; --ink:#172036; --muted:#6b7898; --line:#e6eaf6;
    --brand1:#6a8dff; --brand2:#3a64ff; --brand3:#00c2a8; --card:#fff;
    --radius:16px; --shadow:0 12px 30px rgba(20,35,80,.10);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:
    radial-gradient(1200px 600px at -10% -10%, #edf2ff 0%, transparent 60%),
    radial-gradient(1000px 600px at 110% 0%, #f1fffb 0%, transparent 60%),
    var(--bg);
    color:var(--ink);font:15px/1.65 "Pretendard",ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",Arial;
    padding:34px;display:flex;justify-content:center}
  .wrap{width:min(1100px,100%)}
  .title{margin:0 0 8px;text-align:center;font-weight:900;letter-spacing:.2px;
    font-size:clamp(22px,3.2vw,32px)}
  .panel{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
  .controls{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center}
  .searchbox{position:relative}
  .searchbox input{width:100%;height:58px;border:1px solid var(--line);border-radius:14px;padding:0 58px 0 18px;font-size:16px;outline:none;background:#fff;color:var(--ink);box-shadow:inset 0 1px 0 rgba(0,0,0,.02)}
  .searchbox input:focus{border-color:#cfe1ff;box-shadow:0 0 0 5px #eaf1ff}
  .btn{height:58px;padding:0 22px;border:0;border-radius:14px;font-weight:900;letter-spacing:.2px;cursor:pointer;color:#fff;
    background:linear-gradient(135deg,var(--brand1),var(--brand2));box-shadow:0 12px 25px rgba(58,100,255,.28)}
  .ac{position:absolute;left:0;right:0;top:62px;background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow);overflow:hidden;z-index:20;display:none;max-height:380px;overflow:auto}
  .ac.open{display:block}
  .ac ul{list-style:none;margin:0;padding:8px}
  .ac li{padding:10px 12px;border-radius:10px;cursor:pointer;display:flex;align-items:center;gap:10px}
  .ac li:hover,.ac li.active{background:#f6f9ff}
  .badge{font:11px/1.2 ui-monospace,Consolas,Menlo,monospace;padding:3px 8px;border-radius:999px;border:1px solid #dbe4ff;background:#eef3ff;color:#2f5bff}
  .badge.kcd{border-color:#cfeee7;background:#edfdf9;color:#0b806f}

  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
  .card{background:linear-gradient(180deg,#ffffff 0%, #fbfdff 100%);border:1px solid var(--line);border-radius:20px;box-shadow:var(--shadow);overflow:hidden}
  .card h3{margin:0;padding:14px 16px;font-size:16px;letter-spacing:.3px;border-bottom:1px solid var(--line);text-align:center;background:linear-gradient(135deg,#ffffff,#f6f8ff)}
  .only{padding:12px 16px 16px}
  .pill{display:flex;gap:10px;align-items:flex-start;margin:8px 0;padding:10px 12px;border:1px dashed #e3e9f7;border-radius:12px;background:#fff}
  .pill b{font-size:14px}
  .muted{color:var(--muted)}
  .center{text-align:center}
  .kcd{margin-top:18px;border-top:1px solid var(--line);padding:12px 16px}
  .kcd h4{margin:0 0 6px;font-size:14px}
  .kcd ul{margin:0;padding-left:18px}
  .kcd li{margin:4px 0}
  .foot{margin-top:10px;text-align:center;color:#98a3c4;font-size:12px}
</style>
</head>
<body>
  <main class="wrap">
    <h1 class="title">질병 종수술 분류 + KCD 코드</h1>

    <section class="panel">
      <div class="controls">
        <div class="searchbox">
          <input id="q" type="text" placeholder="예: 대장용종절제술, 갑상선, 담낭, 용종…" aria-label="검색"/>
          <div class="ac" id="ac"><ul id="acList"></ul></div>
        </div>
        <button id="searchBtn" class="btn">검색</button>
      </div>

      <div class="grid" style="margin-top:18px">
        <article class="card">
          <h3>1~3종 수술비</h3>
          <div class="only" id="colA">
            <div class="pill muted">검색 결과가 여기에 표시됩니다.</div>
          </div>
        </article>
        <article class="card">
          <h3>1~5종 수술비</h3>
          <div class="only" id="colB">
            <div class="pill muted">검색 결과가 여기에 표시됩니다.</div>
          </div>
        </article>
      </div>

      <article class="card kcd">
        <h4>관련 KCD 코드</h4>
        <ul id="kcdList"><li class="muted">검색어와 일치하는 상병명이 여기에 표시됩니다.</li></ul>
      </article>

      <p class="foot">앞자리=1~3종, 뒷자리=1~5종 (X는 해당없음)</p>
    </section>
  </main>

<script>
/* ===== 1) 수술 분류 RAW (앞자리=3종, 뒷자리=5종) ===== */
const RAW_DATA = String.raw`12(내시경적) 위용종제거술
12(내시경적) 위출혈지혈술
12대장용종절제술
23갑상선 전절제술
11유방 양성종양적출술
...`;
// ↑ 실제 배포 시, 네가 가진 전체 텍스트(질병종수술분류.txt)를 그대로 붙여넣기.

/* ===== 2) KCD CSV 경로(네 사이트에 올린 파일로 변경) ===== */
const KCD_CSV_URL = "/assets/건강보험심사평가원_상병마스터_20240131.csv"; // 예시 경로

/* ===== 파서: 수술 RAW → 구조화 ===== */
function normalizeSpaces(s){ return s.replace(/\s+/g,' ').trim(); }
function parseRaw(text){
  const out=[], seen=new Set();
  const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const re = /^\s*([0-9X])([0-9X])\s*(?:\(([^)]+)\))?\s*(.+?)\s*$/;
  for(const line of lines){
    const m = line.match(re); if(!m) continue;
    const aKey=m[1], bKey=m[2], desc=m[3]?normalizeSpaces(m[3]):"", name=normalizeSpaces(m[4]);
    const aTier=(aKey>='1'&&aKey<='3')?Number(aKey):null;
    const bTier=(bKey>='1'&&bKey<='5')?Number(bKey):null;
    const id = name+"||"+desc+"||"+(aTier??'NA')+"||"+(bTier??'NA');
    if(seen.has(id)) continue; seen.add(id);
    out.push({name, desc, aKey, bKey, aTier, bTier});
  }
  return out;
}
let DB = parseRaw(RAW_DATA);

/* ===== 인덱스 & 자동완성(수술명) ===== */
function buildSurgeryIndex(rows){
  const set=new Set(); const list=[];
  for(const r of rows){
    const key=r.name.replace(/\s+/g,'');
    if(!set.has(key)){ set.add(key); list.push({type:"op", label:r.name}); }
  }
  return list;
}
let SURG_SUGG = buildSurgeryIndex(DB);

/* ===== KCD 로더 & 인덱스 =====
   CSV 포맷(심평원 상병마스터): 열에 'KCD' 코드와 '상병명'이 포함되어 있다고 가정.
   구분자 자동 감지(탭/콤마 둘 다 지원) */
let KCD = []; // {code, name}
function parseKCD(csv){
  const delim = csv.indexOf('\t')>-1 ? '\t' : ',';
  const lines = csv.split(/\r?\n/).filter(Boolean);
  if(lines.length===0) return;
  const header = lines[0].split(delim).map(h=>h.trim());
  const idxCode = header.findIndex(h=>/^(KCD|상병코드)/i.test(h));
  const idxName = header.findIndex(h=>/(상병명|질병명)/.test(h));
  for(let i=1;i<lines.length;i++){
    const cols = lines[i].split(delim);
    const code = (cols[idxCode]||"").trim();
    const name = (cols[idxName]||"").trim();
    if(code && name) KCD.push({code,name});
  }
}
function buildKcdSugg(){
  return KCD.slice(0,300000).map(r=>({type:"kcd", label:r.name, code:r.code}));
}
let KCD_SUGG = [];

/* ===== 공통 자동완성(수술+KCD) ===== */
const elQ = document.getElementById('q');
const elAC = document.getElementById('ac');
const elACList = document.getElementById('acList');

function openAC(items){
  if(!items.length){ elAC.classList.remove('open'); return; }
  elACList.innerHTML = items.slice(0,20).map((it,i)=>{
    const badge = it.type==="op" ? '<span class="badge">수술</span>' :
                                   '<span class="badge kcd">KCD</span>';
    return `<li data-i="${i}" data-t="${it.type}">
      ${badge} <strong>${it.label}</strong>${it.code?` <span class="muted">(${it.code})</span>`:''}
    </li>`;
  }).join('');
  elAC.classList.add('open');
}
function closeAC(){ elAC.classList.remove('open'); }
function suggAll(q){
  const key = q.replace(/\s+/g,''); if(!key) return [];
  const fromOp = SURG_SUGG.filter(s => s.label.replace(/\s+/g,'').includes(key));
  const fromKcd = KCD_SUGG.filter(s => s.label.replace(/\s+/g,'').includes(key));
  // 우선 수술 10개, 상병 10개
  return [...fromOp.slice(0,10), ...fromKcd.slice(0,10)];
}

/* ===== 렌더 ===== */
const elA = document.getElementById('colA');
const elB = document.getElementById('colB');
const elK = document.getElementById('kcdList');

function renderTier(col, titleTier, items){
  if(!items.length){
    col.innerHTML = `<div class="pill muted">일치 수술이 없습니다.</div>`;
    return;
  }
  // 같은 수술명이 여러 줄이면 그룹화
  const first = items[0];
  col.innerHTML = `<div class="pill"><b>${titleTier}종</b><span>${first.name}${first.desc?` <span class="muted">(${first.desc})</span>`:''}</span></div>`;
}

function doSearch(){
  const q = elQ.value.trim();
  const key = q.replace(/\s+/g,''); if(!key){ elA.innerHTML=elB.innerHTML=`<div class="pill muted">검색어를 입력하세요.</div>`; elK.innerHTML='<li class="muted">상병 코드가 여기 표시됩니다.</li>'; return; }

  // 1) 수술 매칭
  const rows = DB.filter(r => r.name.replace(/\s+/g,'').includes(key));
  // 가장 이름이 짧은(정확도 높은) 것으로 우선 선택
  rows.sort((a,b)=>a.name.length - b.name.length);

  const aOnly = rows.filter(r => r.aTier!=null);
  const bOnly = rows.filter(r => r.bTier!=null);

  if(aOnly.length){ renderTier(elA, aOnly[0].aTier, [aOnly[0]]); }
  else { elA.innerHTML = `<div class="pill muted">1~3종 등급 정보 없음</div>`; }

  if(bOnly.length){ renderTier(elB, bOnly[0].bTier, [bOnly[0]]); }
  else { elB.innerHTML = `<div class="pill muted">1~5종 등급 정보 없음</div>`; }

  // 2) KCD 매칭(상병명에 검색어 포함)
  const k = KCD.filter(r => r.name.replace(/\s+/g,'').includes(key)).slice(0,12);
  if(!k.length){
    elK.innerHTML = `<li class="muted">일치하는 상병명이 없습니다.</li>`;
  }else{
    elK.innerHTML = k.map(r=>`<li><b>${r.code}</b> — ${r.name}</li>`).join('');
  }
  closeAC();
}

/* ===== 이벤트 ===== */
document.getElementById('searchBtn').addEventListener('click', doSearch);
elQ.addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); });
elQ.addEventListener('input', ()=> openAC(suggAll(elQ.value)));
elQ.addEventListener('focus', ()=> openAC(suggAll(elQ.value)));
elQ.addEventListener('blur', ()=> setTimeout(closeAC,120));
elACList.addEventListener('click', (e)=>{
  const li = e.target.closest('li'); if(!li) return;
  const idx = Number(li.dataset.i);
  const items = suggAll(elQ.value);
  const it = items[idx];
  if(it){ elQ.value = it.label; doSearch(); }
});

/* ===== KCD CSV 로드 ===== */
fetch(KCD_CSV_URL)
  .then(r=>r.text())
  .then(txt=>{
    parseKCD(txt);
    KCD_SUGG = buildKcdSugg();
  })
  .catch(()=>{ /* KCD 미로딩 시에도 수술 검색은 동작 */ });

</script>
</body>
</html>
