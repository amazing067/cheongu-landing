<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ë³´í—˜ê¸ˆ ì²­êµ¬ì„œ ìë™ê¸°ì… PDF ìƒì„± (íŒ©ìŠ¤ ì „ì†¡ í¬í•¨)</title>
<meta name="format-detection" content="telephone=no" />
<style>
  /* ... (ìŠ¤íƒ€ì¼ì€ ì´ì „ê³¼ ë™ì¼í•©ë‹ˆë‹¤) ... */
  :root{--bg:#f6f8fb;--card:#fff;--ink:#111827;--muted:#6b7280;--brand:#3a64ff;--line:#e5e7eb;--radius:16px;--shadow:0 10px 30px rgba(17,24,39,.08)}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:900px;margin:24px auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px 24px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input,select{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;font-size:14px;transition:border-color .2s, box-shadow .2s}
  input:focus, select:focus {border-color:var(--brand);box-shadow:0 0 0 3px rgba(58,100,255,.2);outline:none}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:12px 16px;border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:600;transition:all .2s}
  .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
  .btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 4px 10px rgba(0,0,0,.05)}
  .btn.primary:hover:not(:disabled){box-shadow:0 4px 12px rgba(58,100,255,.2)}
  .btn:disabled{background:#f6f8fb;color:var(--muted);border-color:var(--line);cursor:not-allowed;opacity:0.7}
  .muted{color:var(--muted);font-size:12px}
  h2{margin:0 0 12px 0}
  h3{margin:0 0 16px 0;padding-bottom:10px;border-bottom:1px solid var(--line)}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .seg{display:grid;gap:0;align-items:center}
  .seg-rrn{grid-template-columns:1fr 14px 1fr}
  .seg-phone{grid-template-columns:72px 14px 84px 14px 84px}
  .seg input{text-align:center;letter-spacing:1px}
  .dash{color:var(--muted);text-align:center}
  .addr-line{display:grid;grid-template-columns:100px 1fr;gap:8px;margin-bottom: 8px;}
  .addr-line #addr_detail{grid-column:1 / -1}
  .check-group {display:flex;flex-wrap:wrap;gap:10px}
  .check-group label {display:inline-flex;align-items:center;gap:6px;font-size:14px;color:var(--ink);margin:0;padding:10px 12px;border:1px solid var(--line);border-radius:12px;cursor:pointer;transition:all .2s}
  .check-group input[type="radio"], .check-group input[type="checkbox"] {width:auto;accent-color:var(--brand);}
  .check-group label:has(:checked) {background:rgba(58,100,255,.05);border-color:var(--brand);box-shadow:0 0 0 2px rgba(58,100,255,.1)}
  .data-actions{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:16px 20px;margin-bottom:16px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .data-actions input {width:240px}
  .step-nav {display:flex;gap:8px;margin-bottom:12px}
  .step-nav-item {flex:1;text-align:center;padding:10px;border-radius:12px;background:var(--bg);color:var(--muted);border:1px solid var(--line);font-size:14px;font-weight:600}
  .step-nav-item.active {background:var(--brand);color:#fff;border-color:var(--brand)}
  .step {display:none}
  .step.active {display:block}
  .step-footer {margin-top:20px;display:flex;justify-content:space-between;align-items:center}
  .template-list { max-height: 250px; overflow-y: auto; border: 1px solid var(--line); border-radius: 12px; padding: 8px; background: var(--bg); }
  .template-item { display: flex; align-items: center; padding: 12px; background: var(--card); border-radius: 8px; margin-bottom: 8px; }
  .template-item label { display: flex; align-items: center; gap: 10px; font-size: 14px; color: var(--ink); margin: 0; flex: 1; cursor: pointer; }
  .template-item input[type="checkbox"] { width: auto; }
  .template-item .fax { font-size: 12px; color: var(--muted); margin-left: auto; margin-right: 12px; }
  .template-item .view-link { font-size: 12px; }
  .signature-pad-wrapper { position:relative; border:2px dashed var(--line); border-radius:12px; margin-top:12px; height: 200px; background: #fff; }
  .signature-pad-wrapper canvas { width:100%; height:100%; border-radius:12px; cursor:crosshair; }
  #clear_signature { position:absolute; top:8px; right:8px; z-index: 10; font-size:12px; padding:6px 10px; }
  .signature-confirm {margin-top:16px;padding:14px;background:var(--bg);border-radius:8px}
  .signature-confirm label {display:flex;align-items:center;gap:10px;font-size:14px;color:var(--ink);cursor:pointer}
  .signature-confirm input[type="checkbox"] {width:auto;flex-shrink:0}
  #postcode-layer{display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:9999;width:360px;height:480px;border:1px solid var(--line);border-radius:12px;box-shadow:0 12px 30px rgba(0,0,0,.12);background:#fff;overflow:hidden}
  /* ... (ì¤‘ëµ) ... */
</style>
<script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script src="https://unpkg.com/@pdf-lib/fontkit@1.1.1/dist/fontkit.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
<div class="wrap">
  <h2 style="margin-bottom:4px">ë³´í—˜ê¸ˆ ì²­êµ¬ì„œ ìë™ê¸°ì…</h2>
  <p class="muted" style="margin:0 0 16px 0">ìƒˆë¡œê³ ì¹¨ ì‹œ ì…ë ¥ê°’ì€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤. (ì •ë³´ ì•”í˜¸í™” ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ê°€ëŠ¥)</p>

  <div class="data-actions">
    </div>

  <div class="step-nav">
    <div id="step-nav-1" class="step-nav-item active">1. ì²­êµ¬ì ì •ë³´</div>
    <div id="step-nav-2" class="step-nav-item">2. ì‚¬ê³ /ì§ˆë³‘ ì •ë³´</div>
    <div id="step-nav-3" class="step-nav-item">3. ì„œëª… ë° ìƒì„±</div>
  </div>

  <div class="card">
    
    <div id="step-1" class="step active">
      </div>

    <div id="step-2" class="step">
      </div>

    <div id="step-3" class="step">
      <h3>3. ì„œëª… ë° ìƒì„±</h3>

      <label>ì²­êµ¬í•  ë³´í—˜ì‚¬ (ì¤‘ë³µ ì„ íƒ ê°€ëŠ¥)</label>
      <div id="template-list-container" class="template-list">
        </div>
      
      <div style="margin-top:12px">
        <label>ì²­êµ¬ì¼ (ì˜¤ëŠ˜ ë‚ ì§œ)</label>
        <input type="date" id="claim_date_today" />
      </div>

      <label style="margin-top:16px;font-weight:600">ì„œëª… (ì²­êµ¬ì)</label>
      <div class="signature-pad-wrapper">
        <canvas id="signature-canvas"></canvas>
        <button class="btn" id="clear_signature" type="button">ì§€ìš°ê¸°</button>
      </div>

      <div class="signature-confirm">
        <label>
          <input type="checkbox" id="signature_confirm" />
          <span>ë³¸ì¸ì€ ìœ„ ì²­êµ¬ì„œ ë‚´ìš©ê³¼ ìƒê¸° ì„œëª…ì„ í™•ì¸í•˜ì˜€ìœ¼ë©°, ì´ëŠ” ë²•ì  ì„œëª…ê³¼ ë™ì¼í•œ íš¨ë ¥ì„ ê°€ì§ì— ë™ì˜í•©ë‹ˆë‹¤. (í•„ìˆ˜)</span>
        </label>
      </div>

      <div style="margin-top:16px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="btnDownload" type="button" onclick="handleSubmit('download')" disabled>
          ğŸ“„ PDF íŒŒì¼ë¡œ ì €ì¥í•˜ê¸°
        </button>
        <button class="btn primary" id="btnSendFax" type="button" onclick="handleSubmit('fax')" disabled>
          ğŸ“  ì„ íƒí•œ ë³´í—˜ì‚¬ë¡œ íŒ©ìŠ¤ ì „ì†¡
        </button>
      </div>
      <span id="status" class="muted" style="display:block; margin-top: 8px;"></span>
      
      <div class="step-footer">
        <button class="btn" type="button" onclick="navigateToStep(2)">ì´ì „ (ì‚¬ê³ /ì§ˆë³‘ ì •ë³´)</button>
      </div>
    </div>
  </div>
</div>

<div id="postcode-layer" role="dialog" aria-modal="true" aria-label="ì£¼ì†Œ ê²€ìƒ‰">
  </div>

<script>
/* ============== (NEW) PDF í…œí”Œë¦¿ ê²½ë¡œ, ì„œëª… ì¢Œí‘œ, íŒ©ìŠ¤ ë²ˆí˜¸ ============== */
const PDF_TEMPLATES = {
  "SAMSUNG_LIFE": {
    label: "ì‚¼ì„±ìƒëª… (ì§ˆë³‘/ìƒí•´)",
    path: "/assets/pdf-templates/samsung-life-template.pdf",
    sigPos: { x: 450, y: 120, width: 100, height: 50 },
    fax: "050-1234-5678"
  },
  "KB_INSURANCE": {
    label: "KBì†í•´ë³´í—˜ (ì§ˆë³‘/ìƒí•´)",
    path: "/assets/pdf-templates/kb-insurance-template.pdf",
    sigPos: { x: 480, y: 210, width: 100, height: 50 },
    fax: "050-1111-2222"
  },
  "SAMSUNG_FIRE": {
    label: "ì‚¼ì„±í™”ì¬ (ì§ˆë³‘/ìƒí•´)",
    path: "/assets/pdf-templates/samsung-fire-template.pdf",
    sigPos: { x: 400, y: 150, width: 100, height: 50 },
    fax: "050-3333-4444"
  }
};


/* ============== ê³µí†µ ìœ í‹¸ ë° ì´ˆê¸°í™” (ì´í•˜ ë™ì¼) ============== */
const el = id=>document.getElementById(id);
const $status=el(id="status");
let signaturePad = null; 

function onlyDigits(e){ e.value = (e.value||"").replace(/\D/g,""); }
function autoAdvance(cur, nextId, max){ onlyDigits(cur); if(cur.value.length>=max){const n=el(nextId); n&&n.focus(); n?.select?.();} }
function autoBackspace(e, prevId){ if(e.key==="Backspace" && !e.target.value){ const p=el(prevId); p&&p.focus(); p?.select?.(); } }

function initTemplateList(){
  const container = el('template-list-container');
  container.innerHTML = "";
  for(const [key, config] of Object.entries(PDF_TEMPLATES)){
    const item = document.createElement('div');
    item.className = 'template-item';
    item.innerHTML = `
      <label>
        <input type="checkbox" name="template_select" value="${key}">
        <span>${config.label}</span>
      </label>
      <span class="fax">FAX: ${config.fax}</span>
      <a href="${config.path}" target="_blank" class="view-link" onclick="event.stopPropagation()">ì›ë³¸ë³´ê¸°</a>
    `;
    container.appendChild(item);
  }
}

let currentStep = 1;
function navigateToStep(stepNumber) {
  el(`step-${currentStep}`).classList.remove('active');
  el(`step-nav-${currentStep}`).classList.remove('active');
  currentStep = stepNumber;
  el(`step-${currentStep}`).classList.add('active');
  el(`step-nav-${currentStep}`).classList.add('active');
  if (currentStep === 3) {
    el('claim_date_today').value = new Date().toISOString().split('T')[0];
    resizeCanvas();
  }
}

function collectProfile(){
  const p = {};
  const ids = [
    'sub_name', 'sub_rrn1', 'sub_rrn2', 'sub_phone1', 'sub_phone2', 'sub_phone3',
    'ins_name', 'ins_rrn1', 'ins_rrn2', 'ins_phone1', 'ins_phone2', 'ins_phone3',
    'zip', 'addr', 'addr_detail', 'employer_job',
    'ben_name', 'ins_bank_name', 'ins_bank_account',
    'accident_date', 'diagnosis', 'hospital_name', 'accident_detail',
    'claim_date_today'
  ];
  ids.forEach(id => { p[id] = (el(id).value || "").trim(); });
  const sameInsBen = el('sameInsBen').checked;
  if (sameInsBen) { p['ben_name'] = p.ins_name; p['bank_name'] = p.ins_bank_name; p['bank_account'] = p.ins_bank_account; } else { p['bank_name'] = el('bank_name').value.trim(); p['bank_account'] = el('bank_account').value.trim(); }
  delete p.ins_bank_name; delete p.ins_bank_account;
  p['bank_depositor'] = p.ben_name;
  p['claim_type_sickness'] = el('claim_type_sickness').checked; p['claim_type_injury'] = el('claim_type_injury').checked;
  p['claim_detail_hospital'] = el('claim_detail_hospital').checked; p['claim_detail_outpatient'] = el('claim_detail_outpatient').checked; p['claim_detail_surgery'] = el('claim_detail_surgery').checked;
  p['ins_full_phone'] = [p.ins_phone1, p.ins_phone2, p.ins_phone3].join('-'); p['sub_full_phone'] = [p.sub_phone1, p.sub_phone2, p.sub_phone3].join('-');
  p['ins_full_rrn'] = [p.ins_rrn1, p.ins_rrn2].join('-'); p['sub_full_rrn'] = [p.sub_rrn1, p.sub_rrn2].join('-');
  return p;
}

function applyProfile(p){ /* ... (ì´ì „ê³¼ ë™ì¼) ... */ }
function fillSample(){ /* ... (ì´ì „ê³¼ ë™ì¼) ... */ }

/* ============== ì•”í˜¸ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° (ì´ì „ê³¼ ë™ì¼) ============== */
async function deriveKey(pass){ /* ... */ }
async function encryptJSON(obj, pass){ /* ... */ }
async function decryptJSON(payload, pass){ /* ... */ }
const LS_KEY_SECURE = "claim-autofill.profile.enc.v3";
async function saveEncrypted(){ /* ... */ }
async function loadEncrypted(){ /* ... */ }

/* ============== ì£¼ì†Œê²€ìƒ‰ (ì´ì „ê³¼ ë™ì¼) ============== */
const $layer = document.getElementById('postcode-layer'); const $container = document.getElementById('postcode-container');
function openPostcode(){ /* ... */ }
function closePostcode(){ /* ... */ }

/* ============== 'ë™ì¼' ì²´í¬ë°•ìŠ¤ ë¡œì§ (ì´ì „ê³¼ ë™ì¼) ============== */
function syncSameSubIns() { /* ... */ }
function syncSameInsBen() { /* ... */ }

/* ============== ìº”ë²„ìŠ¤ í¬ê¸° ì¡°ì ˆ (ì´ì „ê³¼ ë™ì¼) ============== */
const canvas = el('signature-canvas');
function resizeCanvas() { /* ... */ }

/* ============== ì´ë²¤íŠ¸ ì´ˆê¸°í™” (ìˆ˜ì •) ============== */
document.addEventListener("DOMContentLoaded", ()=>{
  initTemplateList(); 
  signaturePad = new SignaturePad(canvas, { penColor: "rgb(0, 0, 0)" });
  el('clear_signature').addEventListener('click', () => { signaturePad.clear(); });
  window.addEventListener("resize", resizeCanvas);

  el('sameSubIns').addEventListener("change", syncSameSubIns);
  ['sub_name', 'sub_rrn1', 'sub_rrn2', 'sub_phone1', 'sub_phone2', 'sub_phone3'].forEach(id => { el(id).addEventListener("input", syncSameSubIns); });
  el('sameInsBen').addEventListener("change", syncSameInsBen);
  syncSameInsBen();

  // (NEW) ë‘ ê°œì˜ ë²„íŠ¼ì„ ëª¨ë‘ ì œì–´
  el('signature_confirm').addEventListener('change', (e) => {
    const isDisabled = !e.target.checked;
    el('btnDownload').disabled = isDisabled;
    el('btnSendFax').disabled = isDisabled;
  });

  /* ... (ë‚˜ë¨¸ì§€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë™ì¼) ... */
});

/* ============== í°íŠ¸ ë¡œë” (ì´ì „ê³¼ ë™ì¼) ============== */
async function loadKoreanFontBytes(){ /* ... */ }

/* ============== (NEW) PDF ìƒì„± í•¸ë“¤ëŸ¬ (ì €ì¥/íŒ©ìŠ¤ ë¶„ê¸°) ============== */
async function handleSubmit(action) {
  const btnDownload = el("btnDownload");
  const btnSendFax = el("btnSendFax");
  $status.textContent = "ì‘ì—… ì¤€ë¹„ ì¤‘â€¦";
  btnDownload.disabled = true;
  btnSendFax.disabled = true;

  // 1. ìœ íš¨ì„± ê²€ì‚¬ (ê³µí†µ)
  const selectedCheckboxes = document.querySelectorAll('input[name="template_select"]:checked');
  const selectedTemplateKeys = Array.from(selectedCheckboxes).map(cb => cb.value);

  if (selectedTemplateKeys.length === 0) {
    alert("ì²­êµ¬í•  ë³´í—˜ì‚¬ë¥¼ 1ê³³ ì´ìƒ ì„ íƒí•˜ì„¸ìš”.");
    // (ì¤‘ìš”) ë²„íŠ¼ ìƒíƒœ ì›ë³µ
    el('signature_confirm').checked = false;
    // btnDownload.disabled = true; // signature_confirm ë¦¬ìŠ¤ë„ˆê°€ ì´ë¯¸ ì²˜ë¦¬
    // btnSendFax.disabled = true;
    return;
  }
  
  if (signaturePad.isEmpty()) {
    alert("ì„œëª…ë€ì— ì„œëª…ì„ í•´ì£¼ì„¸ìš”.");
    navigateToStep(3);
    el('signature_confirm').checked = false;
    return;
  }

  const P = collectProfile();
  if(!P?.ins_name){ alert("í”¼ë³´í—˜ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”."); navigateToStep(1); return; }
  if(!P?.accident_date){ alert("ë°œë³‘/ì‚¬ê³ ì¼ì„ ì…ë ¥í•˜ì„¸ìš”."); navigateToStep(2); return; }

  const { PDFDocument, StandardFonts } = PDFLib;
  let kFontBytes = null, sigImageBytes = null;
  
  try {
    // 2. ê³µí†µ ë¦¬ì†ŒìŠ¤ ë¡œë“œ
    kFontBytes = await loadKoreanFontBytes();
    const sigDataUrl = signaturePad.toDataURL("image/png");
    sigImageBytes = await fetch(sigDataUrl).then(res => res.arrayBuffer());

    // 3. ì•¡ì…˜ì— ë”°ë¼ ë¶„ê¸°
    if (action === 'download') {
      // --- 3-A: PDF ì €ì¥í•˜ê¸° (ê¸°ì¡´ ZIP ë¡œì§) ---
      if (selectedTemplateKeys.length > 1) {
        $status.textContent = `ZIP íŒŒì¼ ìƒì„± ì¤‘... (0/${selectedTemplateKeys.length})`;
        const zip = new JSZip();
        for (let i = 0; i < selectedTemplateKeys.length; i++) {
          const key = selectedTemplateKeys[i];
          const config = PDF_TEMPLATES[key];
          $status.textContent = `ZIP ìƒì„± ì¤‘... (${i+1}/${selectedTemplateKeys.length}) - ${config.label}`;
          const pdfBytes = await generateSinglePdf(P, config, kFontBytes, sigImageBytes);
          zip.file(`${config.label.replace(/[\(\)]/g, '').trim()}.pdf`, pdfBytes);
        }
        $status.textContent = "ZIP íŒŒì¼ ì••ì¶• ì¤‘...";
        const zipBlob = await zip.generateAsync({ type: "blob" });
        downloadFile(zipBlob, "insurance_claims.zip");
        $status.textContent = "ZIP íŒŒì¼ ìƒì„± ì™„ë£Œ";
      } else {
        $status.textContent = "PDF íŒŒì¼ ìƒì„± ì¤‘...";
        const key = selectedTemplateKeys[0];
        const config = PDF_TEMPLATES[key];
        const pdfBytes = await generateSinglePdf(P, config, kFontBytes, sigImageBytes);
        downloadFile(new Blob([pdfBytes], { type:"application/pdf" }), `${config.label.replace(/[\(\)]/g, '').trim()}.pdf`);
        $status.textContent = "PDF ìƒì„± ì™„ë£Œ";
      }

    } else if (action === 'fax') {
      // --- 3-B: íŒ©ìŠ¤ ì „ì†¡í•˜ê¸° (ì‹œë®¬ë ˆì´ì…˜) ---
      $status.textContent = `íŒ©ìŠ¤ ì „ì†¡ ì¤€ë¹„ ì¤‘... (0/${selectedTemplateKeys.length})`;
      let faxLog = [];

      for (let i = 0; i < selectedTemplateKeys.length; i++) {
        const key = selectedTemplateKeys[i];
        const config = PDF_TEMPLATES[key];
        $status.textContent = `ì „ì†¡ ì¤‘... (${i+1}/${selectedTemplateKeys.length}) - ${config.label} (FAX: ${config.fax})`;
        
        try {
          // 1. PDFëŠ” ë™ì¼í•˜ê²Œ ìƒì„±
          const pdfBytes = await generateSinglePdf(P, config, kFontBytes, sigImageBytes);

          // 2. (MOCK) ì‹¤ì œë¡œëŠ” ì—¬ê¸°ì„œ ì„œë²„ë¡œ 'pdfBytes'ì™€ 'config.fax'ë¥¼ ì „ì†¡í•©ë‹ˆë‹¤.
          // (ì˜ˆì‹œ) fetch('/api/send-fax', { method: 'POST', body: pdfBytes, headers: {'X-Fax-Number': config.fax, ...} });

          // 3. (MOCK) 1ì´ˆê°„ ì „ì†¡ ì‹œë®¬ë ˆì´ì…˜
          await new Promise(resolve => setTimeout(resolve, 1000)); 
          
          console.log(`[MOCK FAX] ${config.label}(${config.fax})ë¡œ PDF (${(pdfBytes.length/1024).toFixed(1)}KB) ì „ì†¡ ì„±ê³µ.`);
          faxLog.push(`âœ… ${config.label}: ì „ì†¡ ì„±ê³µ (-> ${config.fax})`);

        } catch (e) {
          console.error(`íŒ©ìŠ¤ ì „ì†¡ ì‹¤íŒ¨: ${config.label}`, e);
          faxLog.push(`âŒ ${config.label}: ìƒì„±/ì „ì†¡ ì‹¤íŒ¨ (${e.message})`);
        }
      }

      $status.textContent = "íŒ©ìŠ¤ ì „ì†¡ ì™„ë£Œ. (ì‹œë®¬ë ˆì´ì…˜)";
      alert("íŒ©ìŠ¤ ì „ì†¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. (ì‹œë®¬ë ˆì´ì…˜)\n\n--- ì „ì†¡ ê²°ê³¼ ---\n" + faxLog.join("\n"));
    }

  } catch (err) {
    console.error(err);
    alert("ì‘ì—… ì‹¤íŒ¨: " + (err?.message||err));
    $status.textContent = "ì‹¤íŒ¨";
  } finally {
    // 4. (ê³µí†µ) ì‘ì—… ì™„ë£Œ í›„ ìƒíƒœ ì›ë³µ
    el('signature_confirm').checked = false;
    btnDownload.disabled = true;
    btnSendFax.disabled = true;
    signaturePad.clear();
  }
}

/* ============== ê°œë³„ PDF ìƒì„± ë¡œì§ (ì´ì „ê³¼ ë™ì¼) ============== */
async function generateSinglePdf(P, config, kFontBytes, sigImageBytes) {
  const { PDFDocument, StandardFonts } = PDFLib;

  const url = new URL(encodeURI(config.path), location.origin).toString();
  const existingPdfBytes = await fetch(url, { cache:"no-store" }).then(res => res.arrayBuffer());
  const pdfDoc = await PDFDocument.load(existingPdfBytes, { ignoreEncryption:true });
  if (typeof fontkit !== "undefined") pdfDoc.registerFontkit(fontkit);

  let fontToUse;
  if (kFontBytes) { fontToUse = await pdfDoc.embedFont(kFontBytes, { subset:true }); } 
  else { fontToUse = await pdfDoc.embedFont(StandardFonts.Helvetica); }
  
  const form = pdfDoc.getForm();
  for (const [fieldName, text] of Object.entries(P)) {
    if (text === "" || text === false || text === undefined) continue;
    try {
      if (typeof text === 'string') {
        form.getTextField(fieldName).setText(text);
        form.getTextField(fieldName).updateAppearances(fontToUse);
      } else if (typeof text === 'boolean' && text === true) {
        const field = form.getRadioGroup(fieldName) || form.getCheckBox(fieldName);
        if(field.constructor.name === 'PDFRadioGroup') {
            const options = field.getOptions();
            if(options.length > 0) field.select(options[0]);
        } else { field.check(); }
        field.updateAppearances();
      }
    } catch (e) { /* í•„ë“œ ì—†ìŒ */ }
  }
  
  const sigImage = await pdfDoc.embedPng(sigImageBytes);
  const page = pdfDoc.getPage(0); 
  const { x, y, width, height } = config.sigPos;
  page.drawImage(sigImage, { x, y, width, height });
  
  form.flatten();
  return await pdfDoc.save();
}

/* ============== íŒŒì¼ ë‹¤ìš´ë¡œë“œ í—¬í¼ (ì´ì „ê³¼ ë™ì¼) ============== */
function downloadFile(blob, fileName) {
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = fileName;
  a.click();
  URL.revokeObjectURL(a.href);
}

// (ì£¼ì˜) 1ë‹¨ê³„, 2ë‹¨ê³„ HTMLì„ ìƒëµí–ˆìœ¼ë‹ˆ, ì‹¤ì œ íŒŒì¼ì— ë¶™ì—¬ë„£ì„ ë•ŒëŠ”
// 1, 2ë‹¨ê³„ HTMLì„ ì´ì „ ì½”ë“œì—ì„œ ê°€ì ¸ì™€ì„œ ì±„ì›Œë„£ì–´ì•¼ í•©ë‹ˆë‹¤.
</script>
</body>
</html>
