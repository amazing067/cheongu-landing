<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ë³´í—˜ê¸ˆ ì²­êµ¬ì„œ ìë™ê¸°ì… (links.json ì—°ë™)</title>
<meta name="format-detection" content="telephone=no" />
<style>
  :root{--bg:#f6f8fb;--card:#fff;--ink:#111827;--muted:#6b7280;--brand:#3a64ff;--line:#e5e7eb;--radius:16px;--shadow:0 10px 30px rgba(17,24,39,.08)}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:900px;margin:24px auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px 24px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input,select{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;font-size:14px;transition:border-color .2s, box-shadow .2s}
  input:focus, select:focus {border-color:var(--brand);box-shadow:0 0 0 3px rgba(58,100,255,.2);outline:none}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:12px 16px;border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:600;transition:all .2s}
  .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
  .btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 4px 10px rgba(0,0,0,.05)}
  .btn.primary:hover:not(:disabled){box-shadow:0 4px 12px rgba(58,100,255,.2)}
  .btn:disabled{background:#f6f8fb;color:var(--muted);border-color:var(--line);cursor:not-allowed;opacity:0.7}
  .muted{color:var(--muted);font-size:12px}
  h2{margin:0 0 12px 0}
  h3{margin:0 0 16px 0;padding-bottom:10px;border-bottom:1px solid var(--line)}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .seg{display:grid;gap:0;align-items:center}
  .seg-rrn{grid-template-columns:1fr 14px 1fr}
  .seg-phone{grid-template-columns:72px 14px 84px 14px 84px}
  .seg input{text-align:center;letter-spacing:1px}
  .dash{color:var(--muted);text-align:center}
  .addr-line{display:grid;grid-template-columns:100px 1fr;gap:8px;margin-bottom: 8px;}
  .addr-line #addr_detail{grid-column:1 / -1}
  .check-group {display:flex;flex-wrap:wrap;gap:10px}
  .check-group label {display:inline-flex;align-items:center;gap:6px;font-size:14px;color:var(--ink);margin:0;padding:10px 12px;border:1px solid var(--line);border-radius:12px;cursor:pointer;transition:all .2s}
  .check-group input[type="radio"], .check-group input[type="checkbox"] {width:auto;accent-color:var(--brand);}
  .check-group label:has(:checked) {background:rgba(58,100,255,.05);border-color:var(--brand);box-shadow:0 0 0 2px rgba(58,100,255,.1)}
  .data-actions{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:16px 20px;margin-bottom:16px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .data-actions input {width:240px}
  .step-nav {display:grid;grid-template-columns: 1fr 1fr 1fr 1fr; gap:8px;margin-bottom:12px}
  .step-nav-item {flex:1;text-align:center;padding:10px;border-radius:12px;background:var(--bg);color:var(--muted);border:1px solid var(--line);font-size:14px;font-weight:600; cursor: pointer; transition: background .2s, color .2s;}
  .step-nav-item:hover {background: #eef2ff; color: var(--brand);}
  .step-nav-item.active {background:var(--brand);color:#fff;border-color:var(--brand); cursor: default;}
  .step-nav-item.active:hover {background: var(--brand); color: #fff;}
  .step {display:none}
  .step.active {display:block}
  .step-footer {margin-top:20px;display:flex;justify-content:space-between;align-items:center}
  
  .carrier-type-heading {
    font-size: 16px;
    font-weight: 600;
    color: var(--ink);
    margin: 24px 0 12px 0;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--line);
  }
  .carrier-type-heading:first-of-type {
    margin-top: 0;
  }
  .carrier-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 10px; }
  .carrier-item { border: 1px solid var(--line); border-radius: 12px; background: #fff; }
  .carrier-item label { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 16px 12px; gap: 8px; height: 100%; cursor: pointer; }
  .carrier-item img {
    width: 100%;
    height: 80px;
    max-width: 140px;
    object-fit: contain;
    border-radius: 8px;
  }
  .carrier-item span { font-size: 14px; font-weight: 600; color: var(--ink); text-align: center; }
  .carrier-item input[type="checkbox"] { display:none; }
  .carrier-item label:has(:checked) { background:rgba(58,100,255,.05); border-color:var(--brand); box-shadow:0 0 0 2px rgba(58,100,255,.1); border-radius: 12px; }
  .carrier-item.disabled { background: var(--bg); opacity: 0.6; }
  .carrier-item.disabled label { cursor: not-allowed; }
  .carrier-item.disabled span::after { content: " (ì²­êµ¬ì„œ ì—†ìŒ)"; font-size: 10px; color: var(--muted); display: block; }

  .review-list { border: 1px solid var(--line); border-radius: 12px; background: var(--bg); padding: 8px; max-height: 400px; overflow-y: auto; }
  .review-item { display: grid; grid-template-columns: auto 1fr 1fr; gap: 10px 16px; align-items: center; padding: 12px; background: var(--card); border-radius: 8px; margin-bottom: 8px; }
  .review-item img { width: 32px; height: 32px; object-fit: contain; border-radius: 4px; grid-row: 1 / 3; }
  .review-item .name { font-weight: 600; grid-column: 2 / 4; }
  .review-item .template-label { grid-column: 2 / 4; font-size: 13px; color: var(--muted); }
  .review-item .fax-label { font-size: 12px; color: var(--muted); margin: 0; align-self: end; }
  .review-item .fax-input { grid-column: 3 / 4; }
  .review-item .fax-input.missing { border-color: #f00; box-shadow: 0 0 0 3px rgba(255,0,0,.2); }

  .signature-pad-wrapper { position:relative; border:2px dashed var(--line); border-radius:12px; margin-top:12px; height: 200px; background: #fff; }
  .signature-pad-wrapper canvas { width:100%; height:100%; border-radius:12px; cursor:crosshair; }
  #clear_signature { position:absolute; top:8px; right:8px; z-index: 10; font-size:12px; padding:6px 10px; }
  .signature-confirm {margin-top:16px;padding:14px;background:var(--bg);border-radius:8px}
  .signature-confirm label {display:flex;align-items:center;gap:10px;font-size:14px;color:var(--ink);cursor:pointer}
  .signature-confirm input[type="checkbox"] {width:auto;flex-shrink:0}
  
  #postcode-layer{display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:9999;width:360px;height:480px;border:1px solid var(--line);border-radius:12px;box-shadow:0 12px 30px rgba(0,0,0,.12);background:#fff;overflow:hidden}
  #postcode-layer .layer-hd{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--line)}
  #postcode-layer .layer-hd strong{font-size:14px}
  #postcode-layer .layer-close{border:0;background:#fff;cursor:pointer;font-size:16px;line-height:1}
  #postcode-layer #postcode-container{width:100%;height:calc(100% - 44px)}

  @media(max-width:820px){
    .row3, .row2 {grid-template-columns:1fr}
    .seg-phone{grid-template-columns:1fr 14px 1fr 14px 1fr}
    .addr-line{grid-template-columns:100px 1fr}
    .data-actions input {width:100%;order:3}
    .data-actions button {flex:1}
    .step-nav { font-size: 12px; gap: 4px; }
    .step-nav-item { padding: 8px 4px; }
    .carrier-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
  }
</style>
<script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script src="https://unpkg.com/@pdf-lib/fontkit@1.1.1/dist/fontkit.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
<div class="wrap">
  <h2>ë³´í—˜ê¸ˆ ì²­êµ¬ì„œ ìë™ê¸°ì…</h2>
  <p class="muted" style="margin:0 0 16px 0">ì •ë³´ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ê°€ëŠ¥. ëª¨ë“  ì •ë³´ëŠ” ë¸Œë¼ìš°ì € ë‚´ì—ì„œë§Œ ì²˜ë¦¬ë©ë‹ˆë‹¤.</p>

  <div class="data-actions">
    <label for="passphrase" class="muted" style="margin:0">ë¹„ë°€ë²ˆí˜¸:</label>
    <input id="passphrase" type="password" placeholder="ë°ì´í„° ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°ìš© ë¹„ë°€ë²ˆí˜¸" />
    <button class="btn" id="btnSaveEnc" type="button">ë‚´ ì •ë³´ ì €ì¥</button>
    <button class="btn" id="btnLoadEnc" type="button">ë‚´ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <button class="btn" id="btnSample" type="button" style="margin-left:auto">ìƒ˜í”Œ ì±„ìš°ê¸°</button>
  </div>

  <div class="step-nav">
    <div id="step-nav-1" class="step-nav-item active" onclick="navigateToStep(1)">1. ì²­êµ¬ì ì •ë³´</div>
    <div id="step-nav-2" class="step-nav-item" onclick="navigateToStep(2)">2. ì‚¬ê³ /ì§ˆë³‘ ì •ë³´</div>
    <div id="step-nav-3" class="step-nav-item" onclick="navigateToStep(3)">3. ë³´í—˜ì‚¬ ì„ íƒ</div>
    <div id="step-nav-4" class="step-nav-item" onclick="navigateToStep(4)">4. ê²€í†  ë° ì„œëª…</div>
  </div>

  <div class="card">
    
    <div id="step-1" class="step active">
      <h3>1. ì²­êµ¬ì ì •ë³´ (ëˆ„ê°€?)</h3>
      <label style="font-size:16px;font-weight:600;margin:16px 0 12px 0">1-1. ê³„ì•½ì</label>
      <div class="row3">
        <div><label>ì´ë¦„</label><input id="sub_name" placeholder="ê³„ì•½ì ì´ë¦„" /></div>
        <div><label>ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸</label><div class="seg seg-rrn"><input id="sub_rrn1" inputmode="numeric" maxlength="6" placeholder="ì• 6ìë¦¬" /><span class="dash">-</span><input id="sub_rrn2" inputmode="numeric" maxlength="7" placeholder="ë’¤ 7ìë¦¬" /></div></div>
        <div><label>ì „í™”ë²ˆí˜¸</label><div class="seg seg-phone"><input id="sub_phone1" inputmode="numeric" maxlength="3" placeholder="010" /><span class="dash">-</span><input id="sub_phone2" inputmode="numeric" maxlength="4" placeholder="0000" /><span class="dash">-</span><input id="sub_phone3" inputmode="numeric" maxlength="4" placeholder="0000" /></div></div>
      </div>
      <div style="display:flex;align-items:center;gap:8px;margin:24px 0 12px 0">
        <label style="font-size:16px;font-weight:600;margin:0">1-2. í”¼ë³´í—˜ì (ë‹¤ì¹˜ê±°ë‚˜ ì•„í”ˆ ë¶„)</label>
        <label style="display:inline-flex;align-items:center;gap:6px;font-size:13px;color:var(--muted);margin:0"><input type="checkbox" id="sameSubIns" style="width:auto" /> ê³„ì•½ìì™€ ë™ì¼</label>
      </div>
      <div class="row3">
        <div><label>ì´ë¦„</label><input id="ins_name" placeholder="í”¼ë³´í—˜ì ì´ë¦„" /></div>
        <div><label>ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸</label><div class="seg seg-rrn"><input id="ins_rrn1" inputmode="numeric" maxlength="6" placeholder="ì• 6ìë¦¬" /><span class="dash">-</span><input id="ins_rrn2" inputmode="numeric" maxlength="7" placeholder="ë’¤ 7ìë¦¬" /></div></div>
        <div><label>ì „í™”ë²ˆí˜¸</label><div class="seg seg-phone"><input id="ins_phone1" inputmode="numeric" maxlength="3" placeholder="010" /><span class="dash">-</span><input id="ins_phone2" inputmode="numeric" maxlength="4" placeholder="0000" /><span class="dash">-</span><input id="ins_phone3" inputmode="numeric" maxlength="4" placeholder="0000" /></div></div>
      </div>
      <div class="row3" style="margin-top:12px">
        <div><label>ì£¼ì†Œ</label><div class="addr-line"><input id="zip" placeholder="ìš°í¸ë²ˆí˜¸" readonly /><input id="addr" placeholder="ë„ë¡œëª…ì£¼ì†Œ" readonly /></div><div class="addr-line"><input id="addr_detail" placeholder="ìƒì„¸ì£¼ì†Œ" /></div></div>
        <div><label>ì§ì¥/ì§ë¬´</label><input id="employer_job" placeholder="ì˜ˆ: ì²­êµ¬ë‹·ì»´ / ë³´í—˜ìƒë‹´ì‚¬" /></div>
        
        <div id="relationBlock" style="display:none;">
          <label>í”¼ë³´í—˜ìì™€ì˜ ê´€ê³„</label>
          <input id="sub_relation" placeholder="ì˜ˆ: ë¶€, ëª¨, ìë…€" />
        </div>
        </div>
      <div style="display:flex;align-items:center;gap:8px;margin:24px 0 12px 0">
        <label style="font-size:16px;font-weight:600;margin:0">1-3. ë³´í—˜ê¸ˆ ë°›ëŠ” ë¶„ (ìˆ˜ìµì)</label>
        <label style="display:inline-flex;align-items:center;gap:6px;font-size:13px;color:var(--muted);margin:0"><input type="checkbox" id="sameInsBen" style="width:auto" checked /> í”¼ë³´í—˜ìì™€ ë™ì¼</label>
      </div>
      <div id="beneficiaryBlock" style="display:none"><div class="row3"><div><label>ì´ë¦„ (ì˜ˆê¸ˆì£¼)</label><input id="ben_name" placeholder="ìˆ˜ìµì ì´ë¦„" /></div><div><label>ì€í–‰ëª…</label><input id="bank_name" placeholder="ì˜ˆ: êµ­ë¯¼ì€í–‰" /></div><div><label>ê³„ì¢Œë²ˆí˜¸</label><input id="bank_account" placeholder="ìˆ«ì/í•˜ì´í”ˆ ê°€ëŠ¥" /></div></div></div>
      <div id="beneficiaryAccountBlock"><div class="row3"><div><label>ì€í–‰ëª…</label><input id="ins_bank_name" placeholder="í”¼ë³´í—˜ì ë³¸ì¸ ì€í–‰" /></div><div><label>ê³„ì¢Œë²ˆí˜¸</label><input id="ins_bank_account" placeholder="í”¼ë³´í—˜ì ë³¸ì¸ ê³„ì¢Œ" /></div></div></div>
      <div class="step-footer"><button class="btn" disabled>ì´ì „</button><button class="btn primary" type="button" onclick="navigateToStep(2)">ë‹¤ìŒ (ì‚¬ê³ /ì§ˆë³‘ ì •ë³´)</button></div>
    </div>

    <div id="step-2" class="step">
      <h3>2. ì‚¬ê³ /ì§ˆë³‘ ì •ë³´ (ë¬´ì—‡ì„?)</h3>
      <div class="row2"><div><label>ì²­êµ¬ ìœ í˜•</label><div class="check-group"><label><input type="radio" name="claim_type" id="claim_type_sickness" value="ì§ˆë³‘" /> ì§ˆë³‘</label><label><input type="radio" name="claim_type" id="claim_type_injury" value="ìƒí•´ (ì‚¬ê³ )" /> ìƒí•´ (ì‚¬ê³ )</label></div></div><div><label>ì²­êµ¬ ë‚´ìš© (ì¤‘ë³µ ê°€ëŠ¥)</label><div class="check-group"><label><input type="checkbox" name="claim_detail" id="claim_detail_hospital" value="ì…ì›" /> ì…ì›</label><label><input type="checkbox" name="claim_detail" id="claim_detail_outpatient" value="í†µì›" /> í†µì›</label><label><input type="checkbox" name="claim_detail" id="claim_detail_surgery" value="ìˆ˜ìˆ " /> ìˆ˜ìˆ </label></div></div></div>
      <div class="row2" style="margin-top:16px"><div><label>ë°œë³‘ ë˜ëŠ” ì‚¬ê³ ì¼</label><input type="date" id="accident_date" /></div><div><label>ì§„ë‹¨ëª… (ë³‘ëª…)</label><input type="text" id="diagnosis" placeholder="ì˜ˆ: ê¸‰ì„± ìœ„ì—¼, ë°œëª© ì—¼ì¢Œ" /></div></div>
      <div class="row2" style="margin-top:16px"><div><label>ë³‘ì›ëª…</label><input type="text" id="hospital_name" placeholder="ì˜ˆ: ì„œìš¸ë³‘ì›" /></div><div><label>ì‚¬ê³  ê²½ìœ„ (ìƒí•´/ì‚¬ê³ ì¼ ê²½ìš°)</label><input type="text" id="accident_detail" placeholder="ì˜ˆ: 25ë…„ 11ì›” 2ì¼ ì§‘ ê³„ë‹¨ì—ì„œ ë„˜ì–´ì§" /></div></div>
      <div class="step-footer"><button class="btn" type="button" onclick="navigateToStep(1)">ì´ì „ (ì²­êµ¬ì ì •ë³´)</button><button class="btn primary" type="button" onclick="navigateToStep(3)">ë‹¤ìŒ (ë³´í—˜ì‚¬ ì„ íƒ)</button></div>
    </div>

    <div id="step-3" class="step">
      <h3>3. ë³´í—˜ì‚¬ ì„ íƒ</h3>
      <p class="muted" style="margin:-10px 0 12px 0">ì²­êµ¬í•  ë³´í—˜ì‚¬ë¥¼ ëª¨ë‘ ì„ íƒí•˜ì„¸ìš”. (ì²­êµ¬ì„œê°€ ì—†ëŠ” ë³´í—˜ì‚¬ëŠ” ë¹„í™œì„±í™”ë©ë‹ˆë‹¤)</p>
      
      <h4 class="carrier-type-heading">ì†í•´ë³´í—˜ì‚¬</h4>
      <div id="carrier-grid-sonhae" class="carrier-grid">
        </div>

      <h4 class="carrier-type-heading">ìƒëª…ë³´í—˜ì‚¬</h4>
      <div id="carrier-grid-saengmyung" class="carrier-grid">
        </div>

      <div class="step-footer">
        <button class="btn" type="button" onclick="navigateToStep(2)">ì´ì „ (ì‚¬ê³ /ì§ˆë³‘ ì •ë³´)</button>
        <button class="btn primary" type="button" onclick="navigateToStep(4)">ë‹¤ìŒ (ê²€í†  ë° ì„œëª…)</button>
      </div>
    </div>

    <div id="step-4" class="step">
      <h3>4. ê²€í†  ë° ì„œëª…</h3>
      <p class="muted" style="margin:-10px 0 12px 0">ì„ íƒí•œ ë³´í—˜ì‚¬ì˜ íŒ©ìŠ¤ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ì„¸ìš”. (íŒ©ìŠ¤ë²ˆí˜¸ ìˆ˜ì • ê°€ëŠ¥)</p>
      
      <div id="review-list-container" class="review-list">
        </div>
      
      <div style="margin-top:12px">
        <label>ì²­êµ¬ì¼ (ì˜¤ëŠ˜ ë‚ ì§œ)</label>
        <input type="date" id="claim_date_today" />
      </div>

      <label style="margin-top:16px;font-weight:600">ì„œëª… (ì²­êµ¬ì)</label>
      <div class="signature-pad-wrapper">
        <canvas id="signature-canvas"></canvas>
        <button class="btn" id="clear_signature" type="button">ì§€ìš°ê¸°</button>
      </div>

      <div class="signature-confirm">
        <label>
          <input type="checkbox" id="signature_confirm" />
          <span>ë³¸ì¸ì€ ìœ„ ì²­êµ¬ì„œ ë‚´ìš©ê³¼ ìƒê¸° ì„œëª…ì„ í™•ì¸í•˜ì˜€ìœ¼ë©°, ì´ëŠ” ë²•ì  ì„œëª…ê³¼ ë™ì¼í•œ íš¨ë ¥ì„ ê°€ì§ì— ë™ì˜í•©ë‹ˆë‹¤. (í•„ìˆ˜)</span>
        </label>
      </div>

      <div style="margin-top:16px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="btnDownload" type="button" onclick="handleSubmit('download')" disabled>
          ğŸ“„ PDF íŒŒì¼ë¡œ ì €ì¥í•˜ê¸°
        </button>
        <button class="btn primary" id="btnSendFax" type="button" onclick="handleSubmit('fax')" disabled>
          ğŸ“  ì„ íƒí•œ ë³´í—˜ì‚¬ë¡œ íŒ©ìŠ¤ ì „ì†¡
        </button>
      </div>
      <span id="status" class="muted" style="display:block; margin-top: 8px;"></span>
      
      <div class="step-footer">
        <button class="btn" type="button" onclick="navigateToStep(3)">ì´ì „ (ë³´í—˜ì‚¬ ì„ íƒ)</button>
      </div>
    </div>
  </div>
</div>

<div id="postcode-layer" role="dialog" aria-modal="true" aria-label="ì£¼ì†Œ ê²€ìƒ‰">
  <div class="layer-hd">
    <strong>ì£¼ì†Œ ê²€ìƒ‰</strong>
    <button class="layer-close" type="button" onclick="closePostcode()" aria-label="ë‹«ê¸°">âœ•</button>
  </div>
  <div id="postcode-container"></div>
</div>

<script>
/* ============== (NEW) ê¸°ë³¸ í…œí”Œë¦¿ ì •ë³´ (sigPositions ë°°ì—´ ì‚¬ìš©) ============== */
// (ì¤‘ìš”!)
// 1. 'name'ì€ links.jsonì˜ 'name'ê³¼ ì •í™•íˆ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤. (ë³‘í•© ê¸°ì¤€)
// 2. 'logo'ëŠ” ../assets/logos/ ê²½ë¡œì˜ íŒŒì¼ëª…ê³¼ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.
// 3. (NEW) 'templatePath'ëŠ” AcroForm í…œí”Œë¦¿ ê²½ë¡œì…ë‹ˆë‹¤. (â˜…ì§ì ‘ ìˆ˜ì • í•„ìš”â˜…)
// 4. (NEW) 'sigPositions'ëŠ” í…œí”Œë¦¿ì˜ ì„œëª… ì¢Œí‘œ(pt) 'ë°°ì—´'ì…ë‹ˆë‹¤. (â˜…ì§ì ‘ ìˆ˜ì • í•„ìš”â˜…)
// 5. (NEW) 'type' ê¼¬ë¦¬í‘œë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.
//    - type: 'BENEFICIARY' : ìˆ˜ìµì(ì²­êµ¬ì¸) ì„œëª…ë€ (í•­ìƒ ì°í˜)
//    - type: 'INSURED' : í”¼ë³´í—˜ì ì„œëª…ë€ (í”¼ë³´í—˜ìê°€ ì„±ì¸ì¼ ë•Œë§Œ ì°í˜)
//    - type: 'GUARDIAN' : ë²•ì •ëŒ€ë¦¬ì¸ ì„œëª…ë€ (í”¼ë³´í—˜ìê°€ ë¯¸ì„±ë…„ìì¼ ë•Œë§Œ ì°í˜)
const CARRIER_TEMPLATE_DATA = {
  // --- ì†í•´ë³´í—˜ì‚¬ ---
  "SAMSUNG_FIRE": {
    name: "ì‚¼ì„±í™”ì¬",
    logo: "../assets/logos/ì‚¼ì„±í™”ì¬.png",
    // (NEW) 'templatePath'ëŠ” links.jsonì˜ 'pdf' í‚¤ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³ , 
    // ìš°ë¦¬ê°€ Acrobatìœ¼ë¡œ ì‘ì—…í•œ "í…œí”Œë¦¿ íŒŒì¼" ê²½ë¡œë¥¼ ì§ì ‘ ì§€ì •í•©ë‹ˆë‹¤.
    templatePath: "../assets/pdf-templates/SAMSUNG_FIRE-template.pdf", // (â˜…ê²½ë¡œ ì˜ˆì‹œ)
    sigPositions: [ // (â˜…ì˜ˆì‹œ: 4ê°œ) - PDFë¥¼ ë³´ê³  ì–´ë–¤ ì„œëª…ì¸ì§€ typeì„ ì •í™•íˆ ì§€ì •í•´ì•¼ í•©ë‹ˆë‹¤.
      { type: 'BENEFICIARY', page: 0, x: 235, y: 188, width: 100, height: 50 }, // 1í˜ì´ì§€ (ì²­êµ¬ì(ìˆ˜ìµì) ì„œëª…)
      { type: 'BENEFICIARY', page: 0, x: 244, y: 188, width: 100, height: 50 }, // 1í˜ì´ì§€ (ì²­êµ¬ì(ìˆ˜ìµì) ì„œëª…)
      { type: 'BENEFICIARY', page: 4, x: 141, y: 188, width: 100, height: 50 }, // 5í˜ì´ì§€ (ì²­êµ¬ì(ìˆ˜ìµì) ì„œëª…)
      { type: 'BENEFICIARY', page: 4, x: 155, y: 188, width: 100, height: 50 }, // 5í˜ì´ì§€ (ì²­êµ¬ì(ìˆ˜ìµì) ì„œëª…)
      { type: 'GUARDIAN',  page: 0, x: 239, y: 188, width: 100, height: 50 }  // 1í˜ì´ì§€ (ë²•ì •ëŒ€ë¦¬ì¸(ë¯¸ì„±ë…„) ë™ì˜)
      { type: 'GUARDIAN',  page: 4, x: 149, y: 188, width: 100, height: 50 }  // 5í˜ì´ì§€ (ë²•ì •ëŒ€ë¦¬ì¸(ë¯¸ì„±ë…„) ë™ì˜)
    ]
  },
  "HYUNDAI_MARINE": {
    name: "í˜„ëŒ€í•´ìƒ",
    logo: "../assets/logos/í˜„ëŒ€í•´ìƒ.png",
    templatePath: "../assets/pdf-templates/HYUNDAI_MARINE-template.pdf", // (â˜…ê²½ë¡œ ì˜ˆì‹œ)
    sigPositions: [
      { type: 'BENEFICIARY', page: 0, x: 480, y: 210, width: 100, height: 50 }
    ]
  },
  "DB_INSURANCE": {
    name: "DBì†í•´ë³´í—˜",
    logo: "../assets/logos/DBì†í•´ë³´í—˜.png",
    templatePath: "../assets/pdf-templates/DB_INSURANCE-template.pdf", // (â˜…ê²½ë¡œ ì˜ˆì‹œ)
    sigPositions: [
      { type: 'BENEFICIARY', page: 0, x: 400, y: 100, width: 100, height: 50 }
    ]
  },
  "KB_INSURANCE": {
    name: "KBì†í•´ë³´í—˜",
    logo: "../assets/logos/KBì†í•´ë³´í—˜.png",
    templatePath: "../assets/pdf-templates/KB_INSURANCE-template.pdf", // (â˜…ê²½ë¡œ ì˜ˆì‹œ)
    sigPositions: [ // (â˜…ì˜ˆì‹œ: 2ê°œ)
      { type: 'BENEFICIARY', page: 0, x: 480, y: 210, width: 100, height: 50 }, // 1í˜ì´ì§€ (ì²­êµ¬ì ì„œëª…)
      { type: 'INSURED',   page: 2, x: 150, y: 100, width: 100, height: 50 }  // 3í˜ì´ì§€ (í”¼ë³´í—˜ì(ì„±ì¸) ë™ì˜)
      // { type: 'GUARDIAN',  page: 2, x: 250, y: 100, width: 100, height: 50 }  // 3í˜ì´ì§€ (ë²•ì •ëŒ€ë¦¬ì¸(ë¯¸ì„±ë…„) ë™ì˜)
    ]
  },
  "MERITZ_FIRE": {
    name: "ë©”ë¦¬ì¸ í™”ì¬",
    logo: "../assets/logos/ë©”ë¦¬ì¸ í™”ì¬.png",
    templatePath: "../assets/pdf-templates/MERITZ_FIRE-template.pdf", // (â˜…ê²½ë¡œ ì˜ˆì‹œ)
    sigPositions: [
      { type: 'BENEFICIARY', page: 0, x: 400, y: 100, width: 100, height: 50 }
    ]
  },
  
  // ... (ë‹¤ë¥¸ ëª¨ë“  ë³´í—˜ì‚¬ë“¤ë„ 'templatePath'ì™€ 'sigPositions'ì— 'type' ê¼¬ë¦¬í‘œ ì¶”ê°€ í•„ìš”) ...
  
  "LOTTE_INSURANCE": {
    name: "ë¡¯ë°ì†í•´ë³´í—˜",
    logo: "../assets/logos/ë¡¯ë°ì†í•´ë³´í—˜.png",
    templatePath: "../assets/pdf-templates/LOTTE_INSURANCE-template.pdf", // (â˜…ê²½ë¡œ ì˜ˆì‹œ)
    sigPositions: [
      { type: 'BENEFICIARY', page: 0, x: 400, y: 100, width: 100, height: 50 }
    ]
  },
  "HEUNGKUK_FIRE": {
    name: "í¥êµ­í™”ì¬",
    logo: "../assets/logos/í¥êµ­í™”ì¬.png",
    templatePath: "../assets/pdf-templates/HEUNGKUK_FIRE-template.pdf", // (â˜…ê²½ë¡œ ì˜ˆì‹œ)
    sigPositions: [
      { type: 'BENEFICIARY', page: 0, x: 400, y: 100, width: 100, height: 50 }
    ]
  },
  "HANA_INSURANCE": {
    name: "í•˜ë‚˜ì†í•´ë³´í—˜",
    logo: "../assets/logos/í•˜ë‚˜ì†í•´ë³´í—˜.png",
    templatePath: "../assets/pdf-templates/HANA_INSURANCE-template.pdf", // (â˜…ê²½ë¡œ ì˜ˆì‹œ)
    sigPositions: [
      { type: 'BENEFICIARY', page: 0, x: 400, y: 100, width: 100, height: 50 }
    ]
  },
  "NH_INSURANCE": {
    name: "ë†í˜‘ì†í•´ë³´í—˜",
    logo: "../assets/logos/ë†í˜‘ì†í•´ë³´í—˜.png",
    templatePath: "../assets/pdf-templates/NH_INSURANCE-template.pdf", // (â˜…ê²½ë¡œ ì˜ˆì‹œ)
    sigPositions: [
      { type: 'BENEFICIARY', page: 0, x: 400, y: 100, width: 100, height: 50 }
    ]
  },
  "KAKAO_PAY_INSURANCE": {
    name: "ì¹´ì¹´ì˜¤í˜ì´ì†í•´ë³´í—˜",
    logo: "../assets/logos/ì¹´ì¹´ì˜¤í˜ì´ì†í•´ë³´í—˜.png",
    templatePath: "../assets/pdf-templates/KAKAO_PAY_INSURANCE-template.pdf", // (â˜…ê²½ë¡œ ì˜ˆì‹œ)
    sigPositions: [
      { type: 'BENEFICIARY', page: 0, x: 400, y: 100, width: 100, height: 50 }
    ]
  },
  "SHINHAN_EZ_INSURANCE": {
    name: "ì‹ í•œEZì†í•´ë³´í—˜",
    logo: "../assets/logos/ì‹ í•œEZì†í•´ë³´í—˜.png",
    templatePath: "../assets/pdf-templates/SHINHAN_EZ_INSURANCE-template.pdf", // (â˜…ê²½ë¡œ ì˜ˆì‹œ)
    sigPositions: [
      { type: 'BENEFICIARY', page: 0, x: 400, y: 100, width: 100, height: 50 }
    ]
  },
  "CARROT_INSURANCE": {
    name: "ìºë¡¯ì†í•´ë³´í—˜",
    logo: "../assets/logos/ìºë¡¯ì†í•´ë³´í—˜.png",
    templatePath: "../assets/pdf-templates/CARROT_INSURANCE-template.pdf", // (â˜…ê²½ë¡œ ì˜ˆì‹œ)
    sigPositions: [
      { type: 'BENEFICIARY', page: 0, x: 400, y: 100, width: 100, height: 50 }
    ]
  },
  "AIG_INSURANCE": {
    name: "AIGì†í•´ë³´í—˜",
    logo: "../assets/logos/AIGì†í•´ë³´í—˜.png",
    templatePath: "../assets/pdf-templates/AIG_INSURANCE-template.pdf", // (â˜…ê²½ë¡œ ì˜ˆì‹œ)
    sigPositions: [
      { type: 'BENEFICIARY', page: 0, x: 400, y: 100, width: 100, height: 50 }
    ]
  },
  "LINA_G_INSURANCE": {
    name: "ë¼ì´ë‚˜ì†í•´ë³´í—˜",
    logo: "../assets/logos/ë¼ì´ë‚˜ìƒëª….png",
    templatePath: "../assets/pdf-templates/LINA_G_INSURANCE-template.pdf", // (â˜…ê²½ë¡œ ì˜ˆì‹œ)
    sigPositions: [
      { type: 'BENEFICIARY', page: 0, x: 400, y: 100, width: 100, height: 50 }
    ]
  },
  "HANWHA_INSURANCE": {
    name: "í•œí™”ì†í•´ë³´í—˜",
    logo: "../assets/logos/í•œí™”ì†í•´ë³´í—˜.png",
    templatePath: "../assets/pdf-templates/HANWHA_INSURANCE-template.pdf", // (â˜…ê²½ë¡œ ì˜ˆì‹œ)
    sigPositions: [
      { type: 'BENEFICIARY', page: 0, x: 400, y: 100, width: 100, height: 50 }
    ]
  },
  "SAMSUNG_LIFE": {
    name: "ì‚¼ì„±ìƒëª…",
    logo: "../assets/logos/ì‚¼ì„±ìƒëª….png",
    templatePath: "../assets/pdf-templates/SAMSUNG_LIFE-template.pdf", // (â˜…ê²½ë¡œ ì˜ˆì‹œ)
    sigPositions: [
      { type: 'BENEFICIARY', page: 0, x: 450, y: 120, width: 100, height: 50 }
    ]
  },
  "HANWHA_LIFE": {
    name: "í•œí™”ìƒëª…",
    logo: "../assets/logos/í•œí™”ìƒëª….png",
    templatePath: "../assets/pdf-templates/HANWHA_LIFE-template.pdf", // (â˜…ê²½ë¡œ ì˜ˆì‹œ)
    sigPositions: [
      { type: 'BENEFICIARY', page: 0, x: 400, y: 100, width: 100, height: 50 }
    ]
  },
  "KYOBO_LIFE": {
    name: "êµë³´ìƒëª…",
    logo: "../assets/logos/êµë³´ìƒëª….png",
    templatePath: "../assets/pdf-templates/KYOBO_LIFE-template.pdf", // (â˜…ê²½ë¡œ ì˜ˆì‹œ)
    sigPositions: [
      { type: 'BENEFICIARY', page: 0, x: 400, y: 100, width: 100, height: 50 }
    ]
  },
  "MIRAE_ASSET_LIFE": {
    name: "ë¯¸ë˜ì—ì…‹ìƒëª…",
    logo: "../assets/logos/ë¯¸ë˜ì—ì…‹ìƒëª….png",
    templatePath: "../assets/pdf-templates/MIRAE_ASSET_LIFE-template.pdf", // (â˜…ê²½ë¡œ ì˜ˆì‹œ)
    sigPositions: [
      { type: 'BENEFICIARY', page: 0, x: 400, y: 100, width: 100, height: 50 }
    ]
  },
  "KB_LIFE": {
    name: "KBë¼ì´í”„ìƒëª…",
    logo: "../assets/logos/KBë¼ì´í”„ìƒëª….png",
    templatePath: "../assets/pdf-templates/KB_LIFE-template.pdf", // (â˜…ê²½ë¡œ ì˜ˆì‹œ)
    sigPositions: [
      { type: 'BENEFICIARY', page: 0, x: 400, y: 100, width: 100, height: 50 }
    ]
  },
  "SHINHAN_LIFE": {
    name: "ì‹ í•œë¼ì´í”„",
    logo: "../assets/logos/ì‹ í•œë¼ì´í”„.png",
    templatePath: "../assets/pdf-templates/SHINHAN_LIFE-template.pdf", // (â˜…ê²½ë¡œ ì˜ˆì‹œ)
    sigPositions: [
      { type: 'BENEFICIARY', page: 0, x: 400, y: 100, width: 100, height: 50 }
    ]
  },
  "NH_LIFE": {
    name: "ë†í˜‘ìƒëª…",
    logo: "../assets/logos/ë†í˜‘ìƒëª….png",
    templatePath: "../assets/pdf-templates/NH_LIFE-template.pdf", // (â˜…ê²½ë¡œ ì˜ˆì‹œ)
    sigPositions: [
      { type: 'BENEFICIARY', page: 0, x: 400, y: 100, width: 100, height: 50 }
    ]
  },
  "HANA_LIFE": {
    name: "í•˜ë‚˜ìƒëª…",
    logo: "../assets/logos/í•˜ë‚˜ìƒëª….png",
    templatePath: "../assets/pdf-templates/HANA_LIFE-template.pdf", // (â˜…ê²½ë¡œ ì˜ˆì‹œ)
    sigPositions: [
      { type: 'BENEFICIARY', page: 0, x: 400, y: 100, width: 100, height: 50 }
    ]
  },
  "DB_LIFE": {
    name: "DBìƒëª…",
    logo: "../assets/logos/DBìƒëª….png",
    templatePath: "../assets/pdf-templates/DB_LIFE-template.pdf", // (â˜…ê²½ë¡œ ì˜ˆì‹œ)
    sigPositions: [
      { type: 'BENEFICIARY', page: 0, x: 400, y: 100, width: 100, height: 50 }
    ]
  },
  "KDB_LIFE": {
    name: "KDBìƒëª…",
    logo: "../assets/logos/KDBìƒëª….png",
    templatePath: "../assets/pdf-templates/KDB_LIFE-template.pdf", // (â˜…ê²½ë¡œ ì˜ˆì‹œ)
    sigPositions: [
      { type: 'BENEFICIARY', page: 0, x: 400, y: 100, width: 100, height: 50 }
    ]
  },
  "ABL_LIFE": {
    name: "ABLìƒëª…",
    logo: "../assets/logos/ABLìƒëª….png",
    templatePath: "../assets/pdf-templates/ABL_LIFE-template.pdf", // (â˜…ê²½ë¡œ ì˜ˆì‹œ)
    sigPositions: [
      { type: 'BENEFICIARY', page: 0, x: 400, y: 100, width: 100, height: 50 }
    ]
  },
  "HEUNGKUK_LIFE": {
    name: "í¥êµ­ìƒëª…",
    logo: "../assets/logos/í¥êµ­ìƒëª….png",
    templatePath: "../assets/pdf-templates/HEUNGKUK_LIFE-template.pdf", // (â˜…ê²½ë¡œ ì˜ˆì‹œ)
    sigPositions: [
      { type: 'BENEFICIARY', page: 0, x: 400, y: 100, width: 100, height: 50 }
    ]
  },
  "METLIFE_LIFE": {
    name: "ë©”íŠ¸ë¼ì´í”„",
    logo: "../assets/logos/ë©”íŠ¸ë¼ì´í”„.png",
    templatePath: "../assets/pdf-templates/METLIFE_LIFE-template.pdf", // (â˜…ê²½ë¡œ ì˜ˆì‹œ)
    sigPositions: [
      { type: 'BENEFICIARY', page: 0, x: 400, y: 100, width: 100, height: 50 }
    ]
  },
  "AIA_LIFE": {
    name: "AIAìƒëª…",
    logo: "../assets/logos/AIAìƒëª….png",
    templatePath: "../assets/pdf-templates/AIA_LIFE-template.pdf", // (â˜…ê²½ë¡œ ì˜ˆì‹œ)
    sigPositions: [
      { type: 'BENEFICIARY', page: 0, x: 400, y: 100, width: 100, height: 50 }
    ]
  },
  "IBK_PENSION": {
    name: "IBKì—°ê¸ˆë³´í—˜",
    logo: "../assets/logos/IBKì—°ê¸ˆë³´í—˜.png",
    templatePath: null, // (í…œí”Œë¦¿ ì—†ìŒ)
    sigPositions: null // (í…œí”Œë¦¿ ì—†ìŒ)
  },
  "CHUBB_LIFE": {
    name: "ì²˜ë¸Œë¼ì´í”„",
    logo: "../assets/logos/ì²˜ë¸Œë¼ì´í”„.png",
    templatePath: "../assets/pdf-templates/CHUBB_LIFE-template.pdf", // (â˜…ê²½ë¡œ ì˜ˆì‹œ)
    sigPositions: [
      { type: 'BENEFICIARY', page: 0, x: 400, y: 100, width: 100, height: 50 }
    ]
  },
  "FUBON_HYUNDAI_LIFE": {
    name: "í‘¸ë³¸í˜„ëŒ€ìƒëª…",
    logo: "../assets/logos/í‘¸ë³¸í˜„ëŒ€ìƒëª….png",
    templatePath: "../assets/pdf-templates/FUBON_HYUNDAI_LIFE-template.pdf", // (â˜…ê²½ë¡œ ì˜ˆì‹œ)
    sigPositions: [
      { type: 'BENEFICIARY', page: 0, x: 400, y: 100, width: 100, height: 50 }
    ]
  },
  "LINA_LIFE": {
    name: "ë¼ì´ë‚˜ìƒëª…",
    logo: "../assets/logos/ë¼ì´ë‚˜ìƒëª….png",
    templatePath: "../assets/pdf-templates/LINA_LIFE-template.pdf", // (â˜…ê²½ë¡œ ì˜ˆì‹œ)
    sigPositions: [
      { type: 'BENEFICIARY', page: 0, x: 400, y: 100, width: 100, height: 50 }
    ]
  },
  "IM_LIFE": {
    name: "iMë¼ì´í”„ìƒëª…",
    logo: "../assets/logos/iMë¼ì´í”„ìƒëª….png",
    templatePath: "../assets/pdf-templates/IM_LIFE-template.pdf", // (â˜…ê²½ë¡œ ì˜ˆì‹œ)
    sigPositions: [
      { type: 'BENEFICIARY', page: 0, x: 400, y: 100, width: 100, height: 50 }
    ]
  },
  "TONGYANG_LIFE": {
    name: "ë™ì–‘ìƒëª…",
    logo: "../assets/logos/ë™ì–‘ìƒëª….png",
    templatePath: "../assets/pdf-templates/TONGYANG_LIFE-template.pdf", // (â˜…ê²½ë¡œ ì˜ˆì‹œ)
    sigPositions: [
      { type: 'BENEFICIARY', page: 0, x: 400, y: 100, width: 100, height: 50 }
    ]
  }
};

/* ============== ë³‘í•©ëœ ìµœì¢… ë°ì´í„°ê°€ ì €ì¥ë  ê°ì²´ ============== */
let GLOBAL_MERGED_DATA = {};


/* ============== ê³µí†µ ìœ í‹¸ ============== */
const el = id=>document.getElementById(id);
const $status=el(id="status");
let signaturePad = null; 

function onlyDigits(e){ e.value = (e.value||"").replace(/\D/g,""); }
function autoAdvance(cur, nextId, max){ onlyDigits(cur); if(cur.value.length>=max){const n=el(nextId); n&&n.focus(); n?.select?.();} }
function autoBackspace(e, prevId){ if(e.key==="Backspace" && !e.target.value){ const p=el(prevId); p&&p.focus(); p?.select?.(); } }

/* ============== 3ë‹¨ê³„: ë³´í—˜ì‚¬ ì„ íƒ ëª©ë¡ ìƒì„± (ì†/ìƒ ë¶„ë¦¬) ============== */
function initCarrierList(){
  const containerSonhae = el('carrier-grid-sonhae');
  const containerSaengmyung = el('carrier-grid-saengmyung');
  if (!containerSonhae || !containerSaengmyung) return;
  
  containerSonhae.innerHTML = ""; // ëª©ë¡ ë¹„ìš°ê¸°
  containerSaengmyung.innerHTML = ""; // ëª©ë¡ ë¹„ìš°ê¸°
  
  for(const [key, config] of Object.entries(GLOBAL_MERGED_DATA)){
    const item = document.createElement('div');
    item.className = 'carrier-item';
    
    // (NEW) í…œí”Œë¦¿(path)ì´ ì—†ìœ¼ë©´ ë¹„í™œì„±í™”
    const hasTemplate = config.template && config.template.path;
    if (!hasTemplate) {
      item.classList.add('disabled');
    }

    item.innerHTML = `
      <label>
        <input type="checkbox" name="carrier_select" value="${key}" ${!hasTemplate ? 'disabled' : ''}>
        <img src="${config.logo}" alt="${config.name} ë¡œê³ " onerror="this.onerror=null; this.src='https://placehold.co/140x80/eee/ccc?text=?';">
        <span>${config.name}</span>
      </label>
    `;
    
    if (config.type === "ì†í•´") {
      containerSonhae.appendChild(item);
    } else if (config.type === "ìƒëª…") {
      containerSaengmyung.appendChild(item);
    }
  }
}

/* ============== 4ë‹¨ê³„: ê²€í†  ëª©ë¡ ìƒì„± ============== */
function initReviewList() {
  const container = el('review-list-container');
  container.innerHTML = ""; // ëª©ë¡ ë¹„ìš°ê¸°
  
  const selectedCheckboxes = document.querySelectorAll('input[name="carrier_select"]:checked');
  if (selectedCheckboxes.length === 0) {
    container.innerHTML = "<p style='padding:12px;text-align:center;color:var(--muted)'>3ë‹¨ê³„ì—ì„œ ì²­êµ¬í•  ë³´í—˜ì‚¬ë¥¼ 1ê³³ ì´ìƒ ì„ íƒí•˜ì„¸ìš”.</p>";
    return;
  }

  selectedCheckboxes.forEach(cb => {
    const key = cb.value;
    const config = GLOBAL_MERGED_DATA[key];
    if (!config || !config.template) return;

    const faxValue = (config.fax && /^[0-9-]+$/.test(config.fax)) ? config.fax : "";

    const item = document.createElement('div');
    item.className = 'review-item';
    item.innerHTML = `
      <img src="${config.logo}" alt="${config.name} ë¡œê³ " onerror="this.onerror=null; this.src='https://placehold.co/32x32/eee/ccc?text=?';">
      <div class="name">${config.name}</div>
      <div class="template-label">ì²­êµ¬ì„œ: ${config.template.label}</div>
      <label class="fax-label" for="fax_${key}">íŒ©ìŠ¤ë²ˆí˜¸:</label>
      <input type="text" class="fax-input ${!faxValue ? 'missing' : ''}" id="fax_${key}" data-carrier-key="${key}" value="${faxValue || ''}" placeholder="íŒ©ìŠ¤ë²ˆí˜¸ ì§ì ‘ ì…ë ¥">
    `;
    container.appendChild(item);
  });
}

/* ============== 4ë‹¨ê³„ ì›Œí¬í”Œë¡œìš° ì ìš© ============== */
let currentStep = 1;
function navigateToStep(stepNumber) {
  // 4ë‹¨ê³„ë¡œ ì´ë™ ì‹œ ê²€í†  ëª©ë¡ ê°•ì œ ìƒì„±
  if (stepNumber === 4) {
    initReviewList();
  }
  
  // 3ë‹¨ê³„ë¡œ ì´ë™ ì‹œ 4ë‹¨ê³„ ê²€í†  ëª©ë¡ ë¹„ìš°ê¸° (ì„ íƒ ë³€ê²½ ëŒ€ë¹„)
  if (stepNumber === 3) {
    el('review-list-container').innerHTML = "";
  }
  
  if(currentStep <= 4 && el(`step-${currentStep}`)) el(`step-${currentStep}`).classList.remove('active');
  if(currentStep <= 4 && el(`step-nav-${currentStep}`)) el(`step-nav-${currentStep}`).classList.remove('active');
  currentStep = stepNumber;
  if(el(`step-${currentStep}`)) el(`step-${currentStep}`).classList.add('active');
  if(el(`step-nav-${currentStep}`)) el(`step-nav-${currentStep}`).classList.add('active');

  if (currentStep === 4) {
    el('claim_date_today').value = new Date().toISOString().split('T')[0];
    resizeCanvas();
  }
}

/* ============== (NEW) ë§Œ 19ì„¸ ë¯¸ë§Œ ì²´í¬ í—¬í¼ í•¨ìˆ˜ ============== */
function isMinor(rrn1_str, rrn2_str) {
  if (!rrn1_str || !rrn2_str || rrn1_str.length !== 6 || rrn2_str.length !== 7) {
    return false; // RRN ì •ë³´ ë¶€ì¡±
  }
  try {
    const rrn1 = parseInt(rrn1_str, 10);
    const g = parseInt(rrn2_str.charAt(0), 10); // 7ë²ˆì§¸ ìë¦¬

    // 7ë²ˆì§¸ ìë¦¬ì— ë”°ë¥¸ ì„¸ê¸° ê²°ì • (1,2: 1900ë…„ëŒ€ / 3,4: 2000ë…„ëŒ€)
    let century = (g === 1 || g === 2 || g === 5 || g === 6) ? 1900 : 2000;
    let birthYear = century + Math.floor(rrn1 / 10000);
    let birthMonth = Math.floor((rrn1 % 10000) / 100) - 1; // JS ì›”ì€ 0ë¶€í„° ì‹œì‘
    let birthDay = rrn1 % 100;

    const today = new Date();
    const birthDate = new Date(birthYear, birthMonth, birthDay);
    
    let age = today.getFullYear() - birthDate.getFullYear();
    const m = today.getMonth() - birthDate.getMonth();
    
    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
      age--; // ìƒì¼ì´ ì•„ì§ ì•ˆ ì§€ë‚¬ìœ¼ë©´ -1
    }
    
    return age < 19; // ë§Œ 19ì„¸ ë¯¸ë§Œì´ë©´ true
  } catch (e) {
    console.error("isMinor RRN íŒŒì‹± ì˜¤ë¥˜", e);
    return false; // ê³„ì‚° ì‹¤íŒ¨ ì‹œ ì„±ì¸ìœ¼ë¡œ ê°„ì£¼
  }
}

/* ============== ë°ì´í„° ìˆ˜ì§‘ (1, 2ë‹¨ê³„) (NEW) ============== */
function collectProfile(){
  const p = {};
  const ids = [
    'sub_name', 'sub_rrn1', 'sub_rrn2', 'sub_phone1', 'sub_phone2', 'sub_phone3',
    'ins_name', 'ins_rrn1', 'ins_rrn2', 'ins_phone1', 'ins_phone2', 'ins_phone3',
    'zip', 'addr', 'addr_detail', 'employer_job',
    'ben_name', 'ins_bank_name', 'ins_bank_account',
    'accident_date', 'diagnosis', 'hospital_name', 'accident_detail',
    'sub_relation' // (NEW) ê´€ê³„ í•„ë“œ ì¶”ê°€
    // 'claim_date_today'ëŠ” ì•„ë˜ì—ì„œ ë³„ë„ ì²˜ë¦¬
  ];
  ids.forEach(id => { if(el(id)) p[id] = (el(id).value || "").trim(); });
  
  const sameInsBen = el('sameInsBen').checked;
  if (sameInsBen) {
    p['ben_name'] = p.ins_name;
    p['bank_name'] = p.ins_bank_name;
    p['bank_account'] = p.ins_bank_account;
  } else {
    p['bank_name'] = el('bank_name').value.trim();
    p['bank_account'] = el('bank_account').value.trim();
  }
  delete p.ins_bank_name; delete p.ins_bank_account;
  p['bank_depositor'] = p.ben_name;
  
  p['claim_type_sickness'] = el('claim_type_sickness').checked;
  p['claim_type_injury'] = el('claim_type_injury').checked;
  p['claim_detail_hospital'] = el('claim_detail_hospital').checked;
  p['claim_detail_outpatient'] = el('claim_detail_outpatient').checked;
  p['claim_detail_surgery'] = el('claim_detail_surgery').checked;
  
  p['ins_full_phone'] = [p.ins_phone1, p.ins_phone2, p.ins_phone3].filter(Boolean).join('-');
  p['sub_full_phone'] = [p.sub_phone1, p.sub_phone2, p.sub_phone3].filter(Boolean).join('-');
  p['ins_full_rrn'] = [p.ins_rrn1, p.ins_rrn2].filter(Boolean).join('-');
  p['sub_full_rrn'] = [p.sub_rrn1, p.sub_rrn2].filter(Boolean).join('-');

  // --- (NEW) ë‚ ì§œ ë¶„ë¦¬ ë¡œì§ ---
  const todayStr = (el('claim_date_today').value || "").trim();
  p['claim_date_today'] = todayStr; // (ì˜ˆ: 2025-11-04)
  
  if (todayStr) {
    try {
      const parts = todayStr.split('-'); // ["2025", "11", "04"]
      if (parts.length === 3) {
        p['date_y_full'] = parts[0];         // "2025"
        p['date_y_short'] = parts[0].substring(2); // "25"
        p['date_m'] = parts[1];            // "11"
        p['date_d'] = parts[2];            // "04"
      }
    } catch(e) {
      console.error("ë‚ ì§œ íŒŒì‹± ì‹¤íŒ¨", e);
    }
  }
  // --- (END NEW) ---

  // --- (NEW) ë¯¸ì„±ë…„ì ì²˜ë¦¬ ---
  p['isMinor'] = isMinor(p.ins_rrn1, p.ins_rrn2); // (NEW) isMinor í”Œë˜ê·¸ë¥¼ P ê°ì²´ì— ì €ì¥
  if (p['isMinor']) {
    console.log("í”¼ë³´í—˜ìê°€ ë¯¸ì„±ë…„ìì…ë‹ˆë‹¤. ë²•ì •ëŒ€ë¦¬ì¸ ì •ë³´ë¥¼ ì±„ì›ë‹ˆë‹¤.");
    // ê³„ì•½ì ì •ë³´ë¥¼ ë²•ì •ëŒ€ë¦¬ì¸ ì •ë³´ë¡œ ë§¤í•‘
    p['guardian_name'] = p.sub_name;
    p['guardian_relation'] = p.sub_relation;
    p['guardian_rrn1'] = p.sub_rrn1;
    p['guardian_rrn2'] = p.sub_rrn2;
  } else {
    // ì„±ì¸ì¸ ê²½ìš° ë²•ì •ëŒ€ë¦¬ì¸ í•„ë“œëŠ” ë¹„ì›Œë‘ 
    p['guardian_name'] = "";
    p['guardian_relation'] = "";
    p['guardian_rrn1'] = "";
    p['guardian_rrn2'] = "";
  }
  // --- (END NEW) ---
  
  // --- (NEW) ìë™ ì²´í¬ ì˜µì…˜ ---
  p['notify_sms'] = true; 
  p['claim_additional'] = false; 
  // --- (END NEW) ---
  
  return p;
}

/* ============== ë°ì´í„° ì ìš© (ìƒ˜í”Œ/ë¶ˆëŸ¬ì˜¤ê¸°) (NEW) ============== */
function applyProfile(p){
  for (const [key, value] of Object.entries(p)) {
    const field = el(key);
    if (!field) continue;
    if (field.type === 'checkbox' || field.type === 'radio') { field.checked = !!value; } else { field.value = value || ""; }
  }
  // (NEW) ìˆ˜ìµì/ê´€ê³„ í•„ë“œ ì ìš©
  const sameSubIns = (p.sub_name === p.ins_name) && (p.sub_rrn1 === p.ins_rrn1);
  el('sameSubIns').checked = sameSubIns;

  const sameInsBen = (p.ins_name === p.ben_name);
  el('sameInsBen').checked = sameInsBen;
  
  if (sameInsBen) { 
    el('ins_bank_name').value = p.bank_name || ''; 
    el('ins_bank_account').value = p.bank_account || ''; 
  } else { 
    el('ben_name').value = p.ben_name || '';
    el('bank_name').value = p.bank_name || ''; 
    el('bank_account').value = p.bank_account || ''; 
  }

  if (!sameSubIns) {
    el('sub_relation').value = p.sub_relation || '';
  }
  
  syncSameSubIns(); 
  syncSameInsBen();
}

function fillSample(){
  applyProfile({
    sub_name:"í™ê¸¸ë™", sub_rrn1:"900101", sub_rrn2:"1234567", sub_phone1:"010", sub_phone2:"1234", sub_phone3:"5678",
    // (NEW) ë¯¸ì„±ë…„ì í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ 2010ë…„ìƒìœ¼ë¡œ ë³€ê²½
    ins_name:"ê¹€ì²­êµ¬", ins_rrn1:"100505", ins_rrn2:"3345678", ins_phone1:"010", sub_phone2:"5555", ins_phone3:"6666",
    sub_relation: "ë¶€", // (NEW)
    zip:"04524", addr:"ì„œìš¸íŠ¹ë³„ì‹œ ì¤‘êµ¬ ì„¸ì¢…ëŒ€ë¡œ 110", addr_detail:"10ì¸µ (íƒœí‰ë¡œ1ê°€)",
    employer_job:"ì²­êµ¬ë‹·ì»´ / ë³´í—˜ìƒë‹´ì‚¬",
    ben_name: "í™ê¸¸ë™", // (NEW) ë¯¸ì„±ë…„ìì´ë¯€ë¡œ ìˆ˜ìµìë¥¼ ê³„ì•½ì(í™ê¸¸ë™)ë¡œ ë³€ê²½
    bank_name: "ì²­êµ¬ì€í–‰", bank_account: "123-456-789012",
    claim_type_sickness: true,
    claim_detail_outpatient: true,
    accident_date: new Date().toISOString().split('T')[0],
    diagnosis: "ê¸‰ì„± ìœ„ì—¼",
    hospital_name: "ì„œìš¸ë³‘ì›"
  });
  // (NEW) ìƒ˜í”Œ ì‹œë‚˜ë¦¬ì˜¤ì— ë§ê²Œ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ê°•ì œ ì„¤ì •
  el('sameSubIns').checked = false;
  el('sameInsBen').checked = false;
  syncSameSubIns(); // 'ê´€ê³„' í•„ë“œ í‘œì‹œ
  syncSameInsBen(); // 'ìˆ˜ìµì' ì •ë³´ í‘œì‹œ
}

/* ============== ì•”í˜¸ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ============== */
async function deriveKey(pass){
  const enc = new TextEncoder(); const salt = enc.encode("claim-autofill-salt-v3");
  const baseKey = await crypto.subtle.importKey("raw", enc.encode(pass), "PBKDF2", false, ["deriveKey"]);
  return crypto.subtle.deriveKey({ name:"PBKDF2", salt, iterations:120000, hash:"SHA-256" }, baseKey, { name:"AES-GCM", length:256 }, false, ["encrypt","decrypt"]);
}
async function encryptJSON(obj, pass){
  const key = await deriveKey(pass); const iv = crypto.getRandomValues(new Uint8Array(12));
  const data = new TextEncoder().encode(JSON.stringify(obj));
  const cipher = await crypto.subtle.encrypt({name:"AES-GCM", iv}, key, data);
  return { iv: Array.from(iv), cipher: Array.from(new Uint8Array(cipher)) };
}
async function decryptJSON(payload, pass){
  const key = await deriveKey(pass); const iv = new Uint8Array(payload.iv); const cipher = new Uint8Array(payload.cipher);
  const plain = await crypto.subtle.decrypt({name:"AES-GCM", iv}, key, cipher);
  return JSON.parse(new TextDecoder().decode(plain));
}
const LS_KEY_SECURE = "claim-autofill.profile.enc.v3";
async function saveEncrypted(){ const pass=el("passphrase").value; if(!pass){alert("ì•”í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");return;}
  try { const enc=await encryptJSON(collectProfile(),pass); localStorage.setItem(LS_KEY_SECURE,JSON.stringify(enc)); alert("ì•”í˜¸ ì €ì¥ ì™„ë£Œ"); }
  catch(e) { alert("ì €ì¥ ì‹¤íŒ¨: " + e.message); }
}
async function loadEncrypted(){ const pass=el("passphrase").value; if(!pass){alert("ì•”í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");return;}
  const raw=localStorage.getItem(LS_KEY_SECURE); if(!raw){alert("ì €ì¥ëœ ë‚´ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");return;}
  try{ const obj=await decryptJSON(JSON.parse(raw),pass); applyProfile(obj); alert("ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ"); }
  catch(e){ alert("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ì•”í˜¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."); } }

/* ============== ì£¼ì†Œê²€ìƒ‰ ============== */
const $layer = document.getElementById('postcode-layer'); const $container = document.getElementById('postcode-container');
function openPostcode(){ $layer.style.display='block';
  new daum.Postcode({ oncomplete:(data)=>{ el("zip").value=data.zonecode||""; el("addr").value=data.roadAddress||data.address||""; el("addr_detail").focus(); closePostcode(); }, width:'100%', height:'100%' }).embed($container); }
function closePostcode(){ $layer.style.display='none'; $container.innerHTML=''; }

/* ============== 'ë™ì¼' ì²´í¬ë°•ìŠ¤ ë¡œì§ (NEW) ============== */
function syncSameSubIns() {
  const same = el('sameSubIns').checked;
  const fields = ['name', 'rrn1', 'rrn2', 'phone1', 'phone2', 'phone3'];
  fields.forEach(f => {
    const target = el(`ins_${f}`);
    if (same) { 
      target.value = el(`sub_${f}`).value; 
      target.disabled = true; 
      target.style.background = 'var(--bg)'; 
    } else { 
      target.disabled = false; 
      target.style.background = '#fff'; 
    }
  });
  
  // (NEW) "ê´€ê³„" í•„ë“œ ë³´ì´ê¸°/ìˆ¨ê¸°ê¸°
  el('relationBlock').style.display = same ? 'none' : 'block';
  if (same) {
    el('sub_relation').value = 'ë³¸ì¸'; // ê³„ì•½ìì™€ í”¼ë³´í—˜ìê°€ ê°™ìœ¼ë©´ 'ë³¸ì¸'
  } else {
    // el('sub_relation').value = ''; // (ì˜µì…˜) ë¹„ì›Œë‘ê¸°
  }
}
function syncSameInsBen() {
  const same = el('sameInsBen').checked;
  el('beneficiaryBlock').style.display = same ? 'none' : 'block';
  el('beneficiaryAccountBlock').style.display = same ? 'block' : 'none';
}

/* ============== ìº”ë²„ìŠ¤ í¬ê¸° ì¡°ì ˆ ============== */
const canvas = el('signature-canvas');
function resizeCanvas() {
  if (!canvas) return;
  const ratio =  Math.max(window.devicePixelRatio || 1, 1);
  canvas.width = canvas.offsetWidth * ratio;
  canvas.height = canvas.offsetHeight * ratio;
  canvas.getContext("2d").scale(ratio, ratio);
  if (signaturePad) { signaturePad.clear(); }
}

/* ============== (NEW) ì•± ì´ˆê¸°í™” ë° links.json ë³‘í•© ============== */
async function initializeApp() {
  // 1. links.json íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
  let linksArray = [];
  try {
    const response = await fetch('../data/links.json'); 
    if (!response.ok) {
      throw new Error(`links.jsonì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (Status: ${response.status})`);
    }
    const linksData = await response.json();
    linksArray = linksData.carriers || [];
  } catch (e) {
    console.error(e);
    $status.textContent = "ë³´í—˜ì‚¬ ì •ë³´(links.json) ë¡œë“œ ì‹¤íŒ¨.";
  }
  
  // 2. CARRIER_TEMPLATE_DATAì™€ links.json ë³‘í•©
  const linksMap = new Map(linksArray.map(item => [item.name, item]));
  GLOBAL_MERGED_DATA = {}; // ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™”

  for (const [key, templateData] of Object.entries(CARRIER_TEMPLATE_DATA)) {
    const linksEntry = linksMap.get(templateData.name); // 'name' í•„ë“œë¡œ ë§¤ì¹­
    
    if (!linksEntry) {
      console.warn(`links.jsonì—ì„œ '${templateData.name}' í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
      continue;
    }

    // ë³‘í•©ëœ ì •ë³´ë¥¼ GLOBAL_MERGED_DATAì— ì €ì¥
    GLOBAL_MERGED_DATA[key] = {
      key: key,
      name: templateData.name,
      logo: templateData.logo,
      type: linksEntry.type || "ê¸°íƒ€",
      fax: linksEntry.links.fax || "",
      cs: linksEntry.links.cs || "",
      template: null // í…œí”Œë¦¿ ì •ë³´ ì´ˆê¸°í™”
    };
    
    // (NEW) í…œí”Œë¦¿ ê²½ë¡œë¥¼ links.jsonì´ ì•„ë‹Œ CARRIER_TEMPLATE_DATAì—ì„œ ì§ì ‘ ê°€ì ¸ì˜´
    const pdfPath = templateData.templatePath; 
    
    if (pdfPath && templateData.sigPositions && templateData.sigPositions.length > 0) {
      GLOBAL_MERGED_DATA[key].template = {
        label: "ë³´í—˜ê¸ˆì²­êµ¬ì„œ",
        path: pdfPath, // (NEW) CARRIER_TEMPLATE_DATAì˜ ê²½ë¡œ ì‚¬ìš©
        sigPositions: templateData.sigPositions 
      };
    }
  }
  
  // 3. ë³‘í•© ì™„ë£Œ í›„ UI ìƒì„±
  initCarrierList(); // 3ë‹¨ê³„ ë³´í—˜ì‚¬ ëª©ë¡ ìƒì„±
  
  // 4. ë‚˜ë¨¸ì§€ ëª¨ë“  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
  signaturePad = new SignaturePad(canvas, { penColor: "rgb(0, 0, 0)" });
  el('clear_signature').addEventListener('click', () => { signaturePad.clear(); });
  window.addEventListener("resize", resizeCanvas);

  el('sameSubIns').addEventListener("change", syncSameSubIns);
  ['sub_name', 'sub_rrn1', 'sub_rrn2', 'sub_phone1', 'sub_phone2', 'sub_phone3'].forEach(id => { el(id).addEventListener("input", syncSameSubIns); });
  el('sameInsBen').addEventListener("change", syncSameInsBen);
  syncSameInsBen();

  el('signature_confirm').addEventListener('change', (e) => {
    const isDisabled = !e.target.checked;
    el('btnDownload').disabled = isDisabled;
    el('btnSendFax').disabled = isDisabled;
  });

  el("zip").addEventListener("click", openPostcode); 
  el("addr").addEventListener("click", openPostcode);
  el("addr_detail").addEventListener("focus", ()=>{ if(!el("addr").value) openPostcode(); });
  el("btnSample").addEventListener("click", fillSample);
  el("btnSaveEnc").addEventListener("click", ()=>{ saveEncrypted().catch(e=>alert(e.message)); });
  el("btnLoadEnc").addEventListener("click", ()=>{ loadEncrypted().catch(e=>alert(e.message)); });
  
  [["sub_phone1","sub_phone2","sub_phone3",3,4],["ins_phone1","ins_phone2","ins_phone3",3,4]].forEach(([a,b,c,ma,mb])=>{ el(a).addEventListener("input", ()=>autoAdvance(el(a),b,ma)); el(b).addEventListener("input", ()=>autoAdvance(el(b),c,mb)); el(c).addEventListener("input", ()=>onlyDigits(el(c))); el(b).addEventListener("keydown", (e)=>autoBackspace(e,a)); el(c).addEventListener("keydown", (e)=>autoBackspace(e,b)); });
  [["sub_rrn1","sub_rrn2",6],["ins_rrn1","ins_rrn2",6]].forEach(([a,b,mx])=>{ el(a).addEventListener("input", ()=>autoAdvance(el(a),b,mx)); el(b).addEventListener("input", ()=>onlyDigits(el(b))); el(b).addEventListener("keydown",(e)=>autoBackspace(e,a)); });
}

/* ============== ì´ë²¤íŠ¸ ì´ˆê¸°í™” (DOMContentLoaded) ============== */
document.addEventListener("DOMContentLoaded", ()=>{
  initializeApp().catch(err => {
    console.error("ì•± ì´ˆê¸°í™” ì‹¤íŒ¨:", err);
    alert("ì•±ì„ ì´ˆê¸°í™”í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.");
  });
});

/* ============== í°íŠ¸ ë¡œë” ============== */
async function loadKoreanFontBytes(){
  const cdn = 'https://cdn.jsdelivr.net/gh/googlefonts/noto-cjk@main/Sans/OTF/Korean/NotoSansKR-Regular.otf';
  const candidates = [ `../assets/fonts/NotoSansKR-Regular.otf`, cdn ];
  for (const url of candidates){
    try{
      const resp = await fetch(url, { cache:'no-store' });
      if (resp.ok){
        const buf = await resp.arrayBuffer();
        if (buf.byteLength > 1024){ console.log('[font] loaded:', url); return buf; }
      } else { console.log('[font] miss(status):', url, resp.status); }
    }catch(e){ console.log('[font] miss(err):', url, e?.message||e); }
  }
  console.warn('[font] no font found -> ASCII fallback');
  return null;
}

/* ============== PDF ìƒì„± í•¸ë“¤ëŸ¬ ============== */
async function handleSubmit(action) {
  const btnDownload = el("btnDownload");
  const btnSendFax = el("btnSendFax");
  $status.textContent = "ì‘ì—… ì¤€ë¹„ ì¤‘â€¦";
  btnDownload.disabled = true;
  btnSendFax.disabled = true;

  // 1. ìœ íš¨ì„± ê²€ì‚¬ (4ë‹¨ê³„ ê²€í†  ëª©ë¡ ê¸°ì¤€)
  const reviewItems = el('review-list-container').querySelectorAll('.review-item');
  if (reviewItems.length === 0) {
    alert("3ë‹¨ê³„ì—ì„œ ì²­êµ¬í•  ë³´í—˜ì‚¬ë¥¼ 1ê³³ ì´ìƒ ì„ íƒí•˜ì„¸ìš”.");
    navigateToStep(3); 
    el('signature_confirm').checked = false;
    return;
  }
  
  if (signaturePad.isEmpty()) {
    alert("ì„œëª…ë€ì— ì„œëª…ì„ í•´ì£¼ì„¸ìš”.");
    navigateToStep(4);
    el('signature_confirm').checked = false;
    return;
  }

  // 2. ì‘ì—… ëª©ë¡ (Job List) ìƒì„± ë° íŒ©ìŠ¤ë²ˆí˜¸ ìœ íš¨ì„± ê²€ì‚¬
  let jobList = [];
  let hasMissingFax = false;
  
  reviewItems.forEach(item => {
    const carrierKey = item.querySelector('.fax-input').dataset.carrierKey;
    const faxInput = item.querySelector('.fax-input');
    const faxNumber = faxInput.value.trim();
    
    if (action === 'fax' && (!faxNumber || !/^[0-9-]+$/.test(faxNumber))) { 
      faxInput.classList.add('missing'); 
      hasMissingFax = true;
    } else {
      faxInput.classList.remove('missing');
    }
    
    jobList.push({
      carrierKey: carrierKey,
      faxNumber: faxNumber
    });
  });

  if (hasMissingFax) {
    alert("íŒ©ìŠ¤ë²ˆí˜¸ê°€ ë¹„ì–´ìˆê±°ë‚˜ í˜•ì‹ì´ ì˜ëª»ëœ í•­ëª©ì´ ìˆìŠµë‹ˆë‹¤. (ìˆ«ìì™€ í•˜ì´í”ˆë§Œ ì‚¬ìš©)\níŒ©ìŠ¤ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜, 'PDF íŒŒì¼ë¡œ ì €ì¥í•˜ê¸°'ë¥¼ ì´ìš©í•˜ì„¸ìš”.");
    el('signature_confirm').checked = false; 
    return;
  }

  const P = collectProfile();
  if(!P?.ins_name){ alert("í”¼ë³´í—˜ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”."); navigateToStep(1); return; }
  if(!P?.accident_date){ alert("ë°œë³‘/ì‚¬ê³ ì¼ì„ ì…ë ¥í•˜ì„¸ìš”."); navigateToStep(2); return; }

  const { PDFDocument, StandardFonts } = PDFLib;
  let kFontBytes = null, sigImageBytes = null;
  
  try {
    // 3. ê³µí†µ ë¦¬ì†ŒìŠ¤ ë¡œë“œ
    kFontBytes = await loadKoreanFontBytes();
    const sigDataUrl = signaturePad.toDataURL("image/png");
    sigImageBytes = await fetch(sigDataUrl).then(res => res.arrayBuffer());

    // 4. ì•¡ì…˜ì— ë”°ë¼ ë¶„ê¸°
    if (action === 'download') {
      // --- 4-A: PDF ì €ì¥í•˜ê¸° (ZIP ë¡œì§) ---
      if (jobList.length > 1) {
        $status.textContent = `ZIP íŒŒì¼ ìƒì„± ì¤‘... (0/${jobList.length})`;
        const zip = new JSZip();
        for (let i = 0; i < jobList.length; i++) {
          const job = jobList[i];
          const config = GLOBAL_MERGED_DATA[job.carrierKey];
          $status.textContent = `ZIP ìƒì„± ì¤‘... (${i+1}/${jobList.length}) - ${config.name}`;
          
          const pdfBytes = await generateSinglePdf(P, config.template, kFontBytes, sigImageBytes);
          zip.file(`${config.name}_ë³´í—˜ê¸ˆì²­êµ¬ì„œ.pdf`, pdfBytes);
        }
        $status.textContent = "ZIP íŒŒì¼ ì••ì¶• ì¤‘...";
        const zipBlob = await zip.generateAsync({ type: "blob" });
        downloadFile(zipBlob, "insurance_claims.zip");
        $status.textContent = "ZIP íŒŒì¼ ìƒì„± ì™„ë£Œ";
      } else {
        $status.textContent = "PDF íŒŒì¼ ìƒì„± ì¤‘...";
        const job = jobList[0];
        const config = GLOBAL_MERGED_DATA[job.carrierKey];
        const pdfBytes = await generateSinglePdf(P, config.template, kFontBytes, sigImageBytes);
        downloadFile(new Blob([pdfBytes], { type:"application/pdf" }), `${config.name}_ë³´í—˜ê¸ˆì²­êµ¬ì„œ.pdf`);
        $status.textContent = "PDF ìƒì„± ì™„ë£Œ";
      }

    } else if (action === 'fax') {
      // --- 4-B: íŒ©ìŠ¤ ì „ì†¡í•˜ê¸° (ì‹œë®¬ë ˆì´ì…˜) ---
      $status.textContent = `íŒ©ìŠ¤ ì „ì†¡ ì¤€ë¹„ ì¤‘... (0/${jobList.length})`;
      let faxLog = [];

      for (let i = 0; i < jobList.length; i++) {
        const job = jobList[i];
        const config = GLOBAL_MERGED_DATA[job.carrierKey];
        $status.textContent = `ì „ì†¡ ì¤‘... (${i+1}/${jobList.length}) - ${config.name} (FAX: ${job.faxNumber})`;
        
        try {
          const pdfBytes = await generateSinglePdf(P, config.template, kFontBytes, sigImageBytes);
          await new Promise(resolve => setTimeout(resolve, 1000)); 
          
          console.log(`[MOCK FAX] ${config.name}(${job.faxNumber})ë¡œ ${config.template.label} PDF (${(pdfBytes.length/1024).toFixed(1)}KB) ì „ì†¡ ì„±ê³µ.`);
          faxLog.push(`âœ… ${config.name}: ì „ì†¡ ì„±ê³µ (-> ${job.faxNumber})`);

        } catch (e) {
          console.error(`íŒ©ìŠ¤ ì „ì†¡ ì‹¤íŒ¨: ${config.name}`, e);
          faxLog.push(`âŒ ${config.name}: ìƒì„±/ì „ì†¡ ì‹¤íŒ¨ (${e.message})`);
        }
      }
      $status.textContent = "íŒ©ìŠ¤ ì „ì†¡ ì™„ë£Œ. (ì‹œë®¬ë ˆì´ì…˜)";
      alert("íŒ©ìŠ¤ ì „ì†¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. (ì‹œë®¬ë ˆì´ì…˜)\n\n--- ì „ì†¡ ê²°ê³¼ ---\n" + faxLog.join("\n"));
    }

  } catch (err) {
    console.error(err);
    alert("ì‘ì—… ì‹¤íŒ¨: " + (err.message||err));
    $status.textContent = "ì‹¤íŒ¨";
  } finally {
    // 5. (ê³µí†µ) ì‘ì—… ì™„ë£Œ í›„ ìƒíƒœ ì›ë³µ
    el('signature_confirm').checked = false;
    btnDownload.disabled = true;
    btnSendFax.disabled = true;
    signaturePad.clear();
  }
}

/* ============== (NEW) ê°œë³„ PDF ìƒì„± ë¡œì§ (ì¡°ê±´ë¶€ ì„œëª…) ============== */
async function generateSinglePdf(P, templateConfig, kFontBytes, sigImageBytes) {
  const { PDFDocument, StandardFonts } = PDFLib;
  if (!templateConfig || !templateConfig.path) {
    throw new Error("PDF í…œí”Œë¦¿ ê²½ë¡œ(path)ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
  }
  
  const url = new URL(encodeURI(templateConfig.path), location.origin).toString();
  
  let existingPdfBytes;
  try {
     existingPdfBytes = await fetch(url, { cache:"no-store" }).then(res => {
      if(!res.ok) throw new Error(`PDF í…œí”Œë¦¿ ë¡œë“œ ì‹¤íŒ¨: ${res.status} ${res.statusText} (ê²½ë¡œ: ${url})`);
      return res.arrayBuffer();
     });
  } catch (e) {
    console.error(e);
    throw new Error(`PDF í…œí”Œë¦¿(${url})ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ ê²½ë¡œì™€ AcroForm ì‘ì—… ì—¬ë¶€ë¥¼ í™•ì¸í•˜ì„¸ìš”.`);
  }

  const pdfDoc = await PDFDocument.load(existingPdfBytes, { ignoreEncryption:true });
  if (typeof fontkit !== "undefined") pdfDoc.registerFontkit(fontkit);

  let fontToUse;
  if (kFontBytes) { fontToUse = await pdfDoc.embedFont(kFontBytes, { subset:true }); } 
  else { fontToUse = await pdfDoc.embedFont(StandardFonts.Helvetica); }
  
  const form = pdfDoc.getForm();
  for (const [fieldName, text] of Object.entries(P)) {
    if (text === "" || text === false || text === undefined) continue;
    try {
      if (typeof text === 'string') {
        const field = form.getTextField(fieldName);
        field.setText(text);
        field.updateAppearances(fontToUse);
      } else if (typeof text === 'boolean' && text === true) {
        const field = form.getRadioGroup(fieldName) || form.getCheckBox(fieldName);
        if(field.constructor.name === 'PDFRadioGroup') {
            const options = field.getOptions();
            if(options.length > 0) field.select(options[0]);
        } else { field.check(); }
        field.updateAppearances();
      }
    } catch (e) { /* í•„ë“œ ì—†ìŒ */ }
  }
  
  // (NEW) ì„œëª… ë¡œì§ ìˆ˜ì • (ë°°ì—´ ìˆœíšŒ ë° ì¡°ê±´ë¶€ ìŠ¤íƒ¬í”„)
  if (sigImageBytes && templateConfig.sigPositions && templateConfig.sigPositions.length > 0) {
    const sigImage = await pdfDoc.embedPng(sigImageBytes);
    const isInsuredMinor = P.isMinor; // 1. ë¯¸ì„±ë…„ì ì—¬ë¶€ í”Œë˜ê·¸ ê°€ì ¸ì˜¤ê¸°

    // (NEW) ì •ì˜ëœ ëª¨ë“  ì„œëª… ìœ„ì¹˜ë¥¼ ìˆœíšŒ
    for (const pos of templateConfig.sigPositions) {
      let shouldStamp = false; // 2. ê¸°ë³¸ê°’ì€ 'ì°ì§€ ì•ŠìŒ'

      // 3. ê¼¬ë¦¬í‘œ(type)ì— ë”°ë¼ ìŠ¤íƒ¬í”„ ì—¬ë¶€ ê²°ì •
      if (pos.type === 'BENEFICIARY') { // ìˆ˜ìµì ì„œëª…ì€ í•­ìƒ ì°ìŒ
        shouldStamp = true;
      }
      else if (pos.type === 'INSURED' && !isInsuredMinor) { // í”¼ë³´í—˜ì ì„œëª…ì€ ì„±ì¸ì¼ ë•Œë§Œ
        shouldStamp = true;
      }
      else if (pos.type === 'GUARDIAN' && isInsuredMinor) { // ë²•ì •ëŒ€ë¦¬ì¸ ì„œëª…ì€ ë¯¸ì„±ë…„ìì¼ ë•Œë§Œ
        shouldStamp = true;
      }
      // (ì°¸ê³ ) typeì´ ì—†ìœ¼ë©´ í•­ìƒ ì°ë„ë¡ í•˜ë ¤ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ
      // else if (!pos.type) {
      //   shouldStamp = true;
      // }

      // 4. ìŠ¤íƒ¬í”„ ì°ê¸°
      if (shouldStamp) {
        if (pos.page >= 0 && pos.page < pdfDoc.getPageCount()) {
          const page = pdfDoc.getPage(pos.page); // (NEW) í•´ë‹¹ í˜ì´ì§€ ê°€ì ¸ì˜¤ê¸°
          const { x, y, width, height } = pos;
          page.drawImage(sigImage, { x, y, width, height });
        } else {
          console.warn(`ì˜ëª»ëœ í˜ì´ì§€ ë²ˆí˜¸(${pos.page})ë¡œ ì„œëª…ì„ ê±´ë„ˆëœë‹ˆë‹¤.`);
        }
      }
    }
  }
  
  form.flatten();
  return await pdfDoc.save();
}

/* ============== íŒŒì¼ ë‹¤ìš´ë¡œë“œ í—¬í¼ ============== */
function downloadFile(blob, fileName) {
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = fileName;
  a.click();
  URL.revokeObjectURL(a.href);
}

</script>
</body>
</html>
