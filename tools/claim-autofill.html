<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>보험금 청구서 자동기입 PDF 생성</title>
<meta name="format-detection" content="telephone=no" />
<style>
  :root{--bg:#f6f8fb;--card:#fff;--ink:#111827;--muted:#6b7280;--brand:#3a64ff;--line:#e5e7eb;--radius:16px;--shadow:0 10px 30px rgba(17,24,39,.08)}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:900px;margin:24px auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px 20px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input,select{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff;font-size:14px}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
  .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
  .muted{color:var(--muted);font-size:12px}

  /* 상단 폼 배치 */
  .row2{display:grid;grid-template-columns:240px 1fr;gap:12px}      /* 이름(작게) | 전화(컴팩트) */
  .row2-b{display:grid;grid-template-columns:1fr 1fr;gap:12px}      /* 주민 | 주소 */
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}    /* 은행 | 계좌 | 직장/직무 */

  /* 전화·주민번호 구간 입력(컴팩트) */
  .seg{display:flex;gap:6px;align-items:center}
  .seg input{width:80px;text-align:center;letter-spacing:1px;padding:10px}
  .seg .dash{color:var(--muted)}
  .seg .w-60{width:60px} .seg .w-74{width:74px} .seg .w-90{width:90px}

  /* 주소 입력: 우편번호 좁게, 나머지 길게 */
  .addr-row{display:grid;grid-template-columns:110px 1fr 1fr;gap:8px}
  .addr-row input{min-width:0}

  /* 버튼/암호 영역 */
  .actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .actions input[type="password"]{width:220px}

  @media(max-width:860px){
    .row2{grid-template-columns:1fr}
    .row2-b{grid-template-columns:1fr}
    .row3{grid-template-columns:1fr}
    .addr-row{grid-template-columns:110px 1fr}
    .addr-row #addrDetail{grid-column:1 / -1}
  }
</style>
<!-- 카카오(다음) 우편번호 서비스 -->
<script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</head>
<body>
<div class="wrap">
  <h2 style="margin:0 0 12px 0">보험금 청구서 자동기입 PDF 생성</h2>
  <p class="muted" style="margin:0 0 16px 0">새로고침 시 입력값은 초기화됩니다. 내 정보는 <b>암호 저장/불러오기</b>로만 사용하세요.</p>

  <div class="card" style="margin-bottom:16px">
    <h3 style="margin:0 0 12px 0">내 기본정보</h3>

    <!-- 이름(작게) | 전화(컴팩트) -->
    <div class="row2">
      <div>
        <label>이름</label>
        <input id="name" placeholder="예: 홍길동">
      </div>
      <div>
        <label>전화번호</label>
        <div class="seg">
          <input id="phone1" class="w-60" inputmode="numeric" maxlength="3" placeholder="010" />
          <span class="dash">-</span>
          <input id="phone2" class="w-90" inputmode="numeric" maxlength="4" placeholder="0000" />
          <span class="dash">-</span>
          <input id="phone3" class="w-90" inputmode="numeric" maxlength="4" placeholder="0000" />
        </div>
      </div>
    </div>

    <!-- 주민등록번호 | 주소(우편번호 좁게, 주소/상세주소 길게) -->
    <div class="row2-b" style="margin-top:12px">
      <div>
        <label>주민등록번호</label>
        <div class="seg">
          <input id="rrn1" class="w-90" inputmode="numeric" maxlength="6" placeholder="앞 6자리" />
          <span class="dash">-</span>
          <input id="rrn2" class="w-90" inputmode="numeric" maxlength="7" placeholder="뒤 7자리" />
        </div>
      </div>
      <div>
        <label>주소</label>
        <div class="addr-row">
          <input id="zip" class="w-74" placeholder="우편번호" readonly />
          <input id="addr" placeholder="도로명주소" readonly />
          <input id="addrDetail" placeholder="상세주소" />
        </div>
      </div>
    </div>

    <!-- 은행 | 계좌 | 직장/직무 -->
    <div class="row3" style="margin-top:12px">
      <div><label>은행명</label><input id="bankName" placeholder="예: 국민은행" /></div>
      <div><label>계좌번호</label><input id="accountNumber" placeholder="숫자/하이픈 가능" /></div>
      <div><label>직장/직무</label><input id="employerJob" placeholder="예: 청구닷컴 / 보험상담사" /></div>
    </div>

    <!-- 샘플/암호 저장·불러오기(암호칸 아래로 이동) -->
    <div class="actions" style="margin-top:12px">
      <button class="btn" id="btnSample" type="button">샘플 채우기</button>
      <input id="passphrase" type="password" placeholder="AES-GCM 암호" />
      <button class="btn" id="btnSaveEnc" type="button">암호 저장</button>
      <button class="btn" id="btnLoadEnc" type="button">암호 불러오기</button>
      <span class="muted">※ 자동 로드는 하지 않습니다.</span>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 12px 0">보험사 선택 및 PDF 생성</h3>
    <div class="row2">
      <div>
        <label>보험사</label>
        <select id="carrier"></select>
      </div>
      <div>
        <label>청구서 PDF</label>
        <select id="pdfFile"></select>
      </div>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <button class="btn primary" id="btnMake" type="button" onclick="makePdf()">PDF 만들기</button>
      <a class="btn" id="btnViewRaw" target="_blank" rel="noopener">원본 PDF 보기</a>
      <span id="status" class="muted"></span>
    </div>
    <p class="muted" style="margin-top:8px">다음 단계에서 각 보험사 PDF 내부 칸에 직접 텍스트를 찍는 “스탬프/폼 채움”을 추가합니다.</p>
  </div>
</div>

<!-- 주소검색 레이어 -->
<div id="postcode-layer" role="dialog" aria-modal="true" aria-label="주소 검색" style="display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:9999;width:360px;height:480px;border:1px solid var(--line);border-radius:12px;box-shadow:0 12px 30px rgba(0,0,0,.12);background:#fff;overflow:hidden">
  <div class="layer-hd" style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--line);background:#fff">
    <strong style="font-size:14px">주소 검색</strong>
    <button class="layer-close" type="button" onclick="closePostcode()" aria-label="닫기" style="border:0;background:#fff;cursor:pointer;font-size:16px;line-height:1">✕</button>
  </div>
  <div id="postcode-container" style="width:100%;height:calc(100% - 44px)"></div>
</div>

<!-- pdf-lib (CDN) -->
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<!-- 카카오(다음) 우편번호 서비스 -->
<script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script>
/* ====== PDF 경로 매핑 ====== */
const PDF_MAP = {
  "삼성화재": [["보험금청구서", "/assets/pdf/삼성화재-보험금청구서.pdf"]],
  "현대해상": [["보험금청구서", "/assets/pdf/현대해상-보험금청구서.pdf"]],
  "DB손해": [
    ["보험금청구서", "/assets/pdf/DB손해보험-보험금청구서.pdf"],
    ["치과치료확인서", "/assets/pdf/DB손해보험 치과치료확인서.pdf"]
  ],
  "KB손해": [["보험금청구서", "/assets/pdf/KB손해보험-보험금청구서.pdf"]],
  "KB라이프생명": [["보험금청구서", "/assets/pdf/KB라이프생명 보험금청구서.pdf"]],
  "AIA생명": [
    ["보험금청구서", "/assets/pdf/AIA생명-보험금청구서.pdf"],
    ["치과치료확인서", "/assets/pdf/AIA생명 치과치료확인서.pdf"]
  ],
  "ABL생명": [
    ["보험금청구서", "/assets/pdf/ABL생명-보험금청구서.pdf"],
    ["치과치료확인서", "/assets/pdf/ABL생명 치과치료확인서.pdf"]
  ],
  "AXA손해보험": [
    ["보험금청구서", "/assets/pdf/AXA손해보험.pdf"],
    ["치과치료확인서", "/assets/pdf/AXA손해보험 치과치료확인서.pdf"]
  ],
  "AIG손해보험": [["치과치료확인서", "/assets/pdf/AIG손해보험 치과치료확인서.pdf"]],
  "기타": [["공란 커버만 생성", ""]]
};

/* ====== 암호화 유틸(AES-GCM) ====== */
async function deriveKey(pass){
  const enc = new TextEncoder();
  const salt = enc.encode("claim-autofill-salt-v3");
  const baseKey = await crypto.subtle.importKey("raw", enc.encode(pass), "PBKDF2", false, ["deriveKey"]);
  return crypto.subtle.deriveKey({name:"PBKDF2", salt, iterations:120000, hash:"SHA-256"}, baseKey, {name:"AES-GCM", length:256}, false, ["encrypt","decrypt"]);
}
async function encryptJSON(obj, pass){
  const key = await deriveKey(pass);
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const data = new TextEncoder().encode(JSON.stringify(obj));
  const cipher = await crypto.subtle.encrypt({name:"AES-GCM", iv}, key, data);
  return { iv: Array.from(iv), cipher: Array.from(new Uint8Array(cipher)) };
}
async function decryptJSON(payload, pass){
  const key = await deriveKey(pass);
  const iv = new Uint8Array(payload.iv);
  const cipher = new Uint8Array(payload.cipher);
  const plain = await crypto.subtle.decrypt({name:"AES-GCM", iv}, key, cipher);
  return JSON.parse(new TextDecoder().decode(plain));
}
const LS_KEY_SECURE = "claim-autofill.profile.enc.v3";

/* ====== DOM ====== */
const el = (id)=>document.getElementById(id);
const $name=el("name");
const $phone1=el("phone1"), $phone2=el("phone2"), $phone3=el("phone3");
const $rrn1=el("rrn1"), $rrn2=el("rrn2");
const $zip=el("zip"), $addr=el("addr"), $addrDetail=el("addrDetail");
const $bankName=el("bankName"), $accountNumber=el("accountNumber");
const $employerJob=el("employerJob");
const $pass=el("passphrase");
const $carrier=el("carrier"), $pdfFile=el("pdfFile"), $btnViewRaw=el("btnViewRaw"), $status=el("status");

/* ====== 셀렉터 ====== */
function initSelectors(){
  $carrier.innerHTML="";
  Object.keys(PDF_MAP).forEach(k=>{
    const o=document.createElement("option"); o.value=k; o.textContent=k; $carrier.appendChild(o);
  });
  updatePdfOptions();
}
function updatePdfOptions(){
  const list = PDF_MAP[$carrier.value] || [];
  $pdfFile.innerHTML="";
  list.forEach(([label, path])=>{
    const o=document.createElement("option"); o.value=path; o.textContent=label; $pdfFile.appendChild(o);
  });
  $btnViewRaw.href = (list[0]?.[1]||"#");
}

/* ====== 저장/불러오기(암호 전용) ====== */
function collectProfile(){
  const phone = [$phone1.value,$phone2.value,$phone3.value].map(v=>(v||"").replace(/\D/g,"")).join("-");
  const rrn = [$rrn1.value,$rrn2].map(v=>(v?.value||"").replace(/\D/g,"")).join("-");
  const addressFull = [($zip.value||"").trim(), ($addr.value||"").trim(), ($addrDetail.value||"").trim()].filter(Boolean).join(" ");
  return {
    name: ($name.value||"").trim(),
    phone, rrn,
    zip: ($zip.value||"").trim(),
    addr: ($addr.value||"").trim(),
    addrDetail: ($addrDetail.value||"").trim(),
    address: addressFull,
    bankName: ($bankName.value||"").trim(),
    accountNumber: ($accountNumber.value||"").trim(),
    employerJob: ($employerJob.value||"").trim()
  };
}
function applyProfile(p){
  $name.value = p.name||"";
  const [p1="",p2="",p3=""] = (p.phone||"").split("-");
  $phone1.value=p1; $phone2.value=p2; $phone3.value=p3;
  const [r1="",r2=""] = (p.rrn||"").split("-");
  $rrn1.value=r1; $rrn2.value=r2;
  $zip.value=p.zip||""; $addr.value=p.addr||""; $addrDetail.value=p.addrDetail||"";
  $bankName.value=p.bankName||""; $accountNumber.value=p.accountNumber||"";
  $employerJob.value=p.employerJob||"";
}
async function saveEncrypted(){
  if(!$pass.value){ alert("암호를 입력하세요."); return; }
  const enc = await encryptJSON(collectProfile(), $pass.value);
  localStorage.setItem(LS_KEY_SECURE, JSON.stringify(enc));
  alert("암호 저장 완료");
}
async function loadEncrypted(){
  if(!$pass.value){ alert("암호를 입력하세요."); return; }
  const raw = localStorage.getItem(LS_KEY_SECURE);
  if(!raw){ alert("저장된 내 정보가 없습니다."); return; }
  try{
    const obj =
