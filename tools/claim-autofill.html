<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>보험금 청구서 자동기입 PDF 생성</title>
<meta name="format-detection" content="telephone=no" />
<style>
  :root{--bg:#f6f8fb;--card:#fff;--ink:#111827;--muted:#6b7280;--brand:#3a64ff;--line:#e5e7eb;--radius:16px;--shadow:0 10px 30px rgba(17,24,39,.08)}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:900px;margin:24px auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px 20px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input,select{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;background:#fff;font-size:14px}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:12px 16px;border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer}
  .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
  .muted{color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <h2 style="margin:0 0 12px 0">보험금 청구서 자동기입 PDF 생성</h2>
  <p class="muted" style="margin:0 0 16px 0">새로고침 시 입력값은 초기화됩니다. 내 정보는 <b>암호 저장/불러오기</b>로만 사용하세요.</p>

  <div class="card" style="margin-bottom:16px">
    <h3 style="margin:0 0 12px 0">내 기본정보</h3>
    <div class="row">
      <div><label>이름</label><input id="name"></div>
      <div><label>전화번호(숫자만)</label><input id="phone" inputmode="numeric"></div>
    </div>
    <div class="row" style="margin-top:12px">
      <div><label>주민등록번호(숫자만)</label><input id="rrn" inputmode="numeric"></div>
      <div><label>계좌번호(은행명 포함)</label><input id="account"></div>
    </div>
    <div class="row" style="margin-top:12px">
      <div><label>직장명</label><input id="employer"></div>
      <div><label>하는 일(직무)</label><input id="job"></div>
    </div>

    <div class="row" style="margin-top:12px">
      <div>
        <label>암호(내 정보 저장/불러오기용)</label>
        <input id="passphrase" type="password" placeholder="AES-GCM 암호" />
      </div>
      <div style="display:flex;align-items:end;gap:8px;flex-wrap:wrap">
        <button class="btn" id="btnSample" type="button">샘플 채우기</button>
        <button class="btn" id="btnSaveEnc" type="button">암호 저장</button>
        <button class="btn" id="btnLoadEnc" type="button">암호 불러오기</button>
        <span class="muted">※ 자동 로드는 하지 않습니다.</span>
      </div>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 12px 0">보험사 선택 및 PDF 생성</h3>
    <div class="row">
      <div>
        <label>보험사</label>
        <select id="carrier"></select>
      </div>
      <div>
        <label>청구서 PDF</label>
        <select id="pdfFile"></select>
      </div>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn primary" id="btnMake" type="button" onclick="makePdf()">PDF 만들기</button>
      <a class="btn" id="btnViewRaw" target="_blank" rel="noopener">원본 PDF 보기</a>
      <span id="status" class="muted"></span>
    </div>
    <p class="muted" style="margin-top:8px">다음 단계에서 각 보험사 PDF 내부 칸에 직접 텍스트를 찍는 “스탬프/폼 채움”을 추가합니다.</p>
  </div>
</div>

<!-- pdf-lib (CDN) -->
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script>
/* ====== 1) PDF 경로 매핑 ====== */
const PDF_MAP = {
  "삼성화재": [
    ["보험금청구서", "/assets/pdf/삼성화재-보험금청구서.pdf"]
  ],
  "현대해상": [
    ["보험금청구서", "/assets/pdf/현대해상-보험금청구서.pdf"]
  ],
  "DB손해": [
    ["보험금청구서", "/assets/pdf/DB손해보험-보험금청구서.pdf"],
    ["치과치료확인서", "/assets/pdf/DB손해보험 치과치료확인서.pdf"]
  ],
  "KB손해": [
    ["보험금청구서", "/assets/pdf/KB손해보험-보험금청구서.pdf"]
  ],
  "KB라이프생명": [
    ["보험금청구서", "/assets/pdf/KB라이프생명 보험금청구서.pdf"]
  ],
  "AIA생명": [
    ["보험금청구서", "/assets/pdf/AIA생명-보험금청구서.pdf"],
    ["치과치료확인서", "/assets/pdf/AIA생명 치과치료확인서.pdf"]
  ],
  "ABL생명": [
    ["보험금청구서", "/assets/pdf/ABL생명-보험금청구서.pdf"],
    ["치과치료확인서", "/assets/pdf/ABL생명 치과치료확인서.pdf"]
  ],
  "AXA손해보험": [
    ["보험금청구서", "/assets/pdf/AXA손해보험.pdf"],
    ["치과치료확인서", "/assets/pdf/AXA손해보험 치과치료확인서.pdf"]
  ],
  "AIG손해보험": [
    ["치과치료확인서", "/assets/pdf/AIG손해보험 치과치료확인서.pdf"]
  ],
  "기타": [
    ["공란 커버만 생성", ""]
  ]
};

/* ====== 2) 암호화 유틸 (AES-GCM) ====== */
async function deriveKey(passphrase){
  const enc = new TextEncoder();
  const salt = enc.encode("claim-autofill-salt-v2");
  const baseKey = await crypto.subtle.importKey("raw", enc.encode(passphrase), "PBKDF2", false, ["deriveKey"]);
  return crypto.subtle.deriveKey(
    { name:"PBKDF2", salt, iterations:120000, hash:"SHA-256" },
    baseKey,
    { name:"AES-GCM", length:256 },
    false,
    ["encrypt","decrypt"]
  );
}
async function encryptJSON(obj, passphrase){
  const key = await deriveKey(passphrase);
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const data = new TextEncoder().encode(JSON.stringify(obj));
  const cipher = await crypto.subtle.encrypt({name:"AES-GCM", iv}, key, data);
  return { iv: Array.from(iv), cipher: Array.from(new Uint8Array(cipher)) };
}
async function decryptJSON(payload, passphrase){
  const key = await deriveKey(passphrase);
  const iv = new Uint8Array(payload.iv);
  const cipher = new Uint8Array(payload.cipher);
  const plain = await crypto.subtle.decrypt({name:"AES-GCM", iv}, key, cipher);
  return JSON.parse(new TextDecoder().decode(plain));
}
const LS_KEY_SECURE = "claim-autofill.profile.enc";

/* ====== 3) DOM ====== */
const el = (id)=>document.getElementById(id);
const $name=el("name"),$rrn=el("rrn"),$phone=el("phone"),$account=el("account"),$employer=el("employer"),$job=el("job");
const $pass=el("passphrase");
const $carrier=el("carrier"),$pdfFile=el("pdfFile"),$btnViewRaw=el("btnViewRaw"),$status=el("status");

/* ====== 4) 셀렉터 ====== */
function initSelectors(){
  $carrier.innerHTML="";
  Object.keys(PDF_MAP).forEach(k=>{
    const o=document.createElement("option");o.value=k;o.textContent=k;$carrier.appendChild(o);
  });
  updatePdfOptions();
}
function updatePdfOptions(){
  const list = PDF_MAP[$carrier.value] || [];
  $pdfFile.innerHTML="";
  list.forEach(([label, path])=>{
    const o=document.createElement("option");o.value=path;o.textContent=label;$pdfFile.appendChild(o);
  });
  $btnViewRaw.href = (list[0]?.[1]||"#");
}

/* ====== 5) 저장/불러오기(암호 전용) — 자동 로드 없음 ====== */
async function saveEncrypted(){
  if(!$pass.value){ alert("암호를 입력하세요."); return; }
  const profile = collectProfile();
  const enc = await encryptJSON(profile, $pass.value);
  localStorage.setItem(LS_KEY_SECURE, JSON.stringify(enc));
  alert("암호 저장 완료");
}
async function loadEncrypted(){
  if(!$pass.value){ alert("암호를 입력하세요."); return; }
  const raw = localStorage.getItem(LS_KEY_SECURE);
  if(!raw){ alert("저장된 내 정보가 없습니다."); return; }
  try{
    const obj = await decryptJSON(JSON.parse(raw), $pass.value);
    applyProfile(obj);
    alert("불러오기 완료");
  }catch(e){ alert("불러오기 실패: 암호를 확인하세요."); }
}
function collectProfile(){
  return {
    name: ($name.value||"").trim(),
    rrn: ($rrn.value||"").replace(/\D/g,""),
    phone: ($phone.value||"").replace(/\D/g,""),
    account: ($account.value||"").trim(),
    employer: ($employer.value||"").trim(),
    job: ($job.value||"").trim()
  };
}
function applyProfile(p){
  $name.value=p.name||""; $rrn.value=p.rrn||""; $phone.value=p.phone||"";
  $account.value=p.account||""; $employer.value=p.employer||""; $job.value=p.job||"";
}
function fillSample(){
  applyProfile({name:"홍길동", rrn:"9001011234567", phone:"01012345678", account:"국민은행 123-456-789012", employer:"청구닷컴 주식회사", job:"보험상담사"});
}

/* ====== 6) PDF 생성 ====== */
async function makePdf(){
  // 즉시 UI 반응(무응답 진단)
  const btn = document.getElementById("btnMake");
  $status.textContent = "PDF 생성 중…";
  btn.disabled = true;

  try{
    const P = collectProfile();
    if(!P.name){ alert("이름을 입력하세요."); return; }

    const { PDFDocument, StandardFonts, rgb } = PDFLib;
    // 커버 페이지
    const out = await PDFDocument.create();
    const page = out.addPage([595.28, 841.89]); // A4
    const font = await out.embedFont(StandardFonts.Helvetica);
    const titleSize=18, labelSize=11, valueSize=13;

    page.drawText("보험금 청구서 자동기입 커버", { x: 50, y: 790, size: titleSize, font, color: rgb(0.1,0.1,0.2) });
    const t=new Date(), y=t.getFullYear(), m=String(t.getMonth()+1).padStart(2,"0"), d=String(t.getDate()).padStart(2,"0");
    page.drawText(`생성일: ${y}-${m}-${d}`, { x: 50, y: 770, size: labelSize, font, color: rgb(0.4,0.4,0.5) });

    page.drawRectangle({ x:40, y: 500, width: 515, height: 220, borderColor: rgb(0.85,0.87,0.92), borderWidth: 1, color: rgb(1,1,1) });

    const rows = [
      ["피보험자 성명", P.name],
      ["주민등록번호", P.rrn],
      ["연락처", P.phone],
      ["보험금 수령계좌", P.account],
      ["직장명", P.employer],
      ["직무", P.job],
    ];
    let yPos = 700;
    rows.forEach(([label,val])=>{
      page.drawText(label, { x: 55, y: yPos, size: labelSize, font, color: rgb(0.35,0.35,0.45) });
      page.drawText(String(val||""), { x: 200, y: yPos, size: valueSize, font, color: rgb(0,0,0) });
      yPos -= 32;
    });
    page.drawText("※ 다음 장부터는 선택한 보험사의 원본 청구서가 이어집니다.", { x: 50, y: 480, size: 10, font, color: rgb(0.4,0.4,0.5) });

    // 원본 병합
    const srcPath = $pdfFile.value;
    if(srcPath){
      const bytes = await fetch(srcPath, {cache:"no-store"}).then(r=>{
        if(!r.ok) throw new Error("원본 PDF 경로 오류");
        return r.arrayBuffer();
      });
      const src = await PDFDocument.load(bytes);
      const pages = await out.copyPages(src, src.getPageIndices());
      pages.forEach(p=>out.addPage(p));
    }

    // 저장
    const pdfBytes = await out.save();
    const blob = new Blob([pdfBytes], {type:"application/pdf"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `${($carrier.value||"보험사")}_청구서_자동기입.pdf`;
    a.click();
    URL.revokeObjectURL(a.href);

    $status.textContent = "완료";
  }catch(err){
    console.error(err);
    alert("PDF 생성 실패: " + (err?.message||err));
    $status.textContent = "실패";
  }finally{
    document.getElementById("btnMake").disabled = false;
  }
}
window.makePdf = makePdf; // 전역 노출 (onclick 안전)

/* ====== 7) 이벤트 ====== */
document.addEventListener("DOMContentLoaded", ()=>{
  initSelectors();
  $carrier.addEventListener("change", updatePdfOptions);
  $pdfFile.addEventListener("change", ()=>{ $btnViewRaw.href = $pdfFile.value || "#"; });

  document.getElementById("btnSample").addEventListener("click", fillSample);
  document.getElementById("btnSaveEnc").addEventListener("click", ()=>{ saveEncrypted().catch(e=>alert(e.message)); });
  document.getElementById("btnLoadEnc").addEventListener("click", ()=>{ loadEncrypted().catch(e=>alert(e.message)); });
});
</script>
</body>
</html>
