<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>보험금 청구서 자동기입 PDF 생성 (폼 필드 방식)</title>
<meta name="format-detection" content="telephone=no" />
<style>
  :root{--bg:#f6f8fb;--card:#fff;--ink:#111827;--muted:#6b7280;--brand:#3a64ff;--line:#e5e7eb;--radius:16px;--shadow:0 10px 30px rgba(17,24,39,.08)}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:900px;margin:24px auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px 20px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input,select{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;font-size:14px}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:12px 16px;border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer}
  .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
  .muted{color:var(--muted);font-size:12px}

  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}

  .seg{display:grid;gap:0;align-items:center}
  .seg-rrn{grid-template-columns:1fr 14px 1fr}
  .seg-phone{grid-template-columns:72px 14px 84px 14px 84px}
  .seg input{text-align:center;letter-spacing:1px}
  .dash{color:var(--muted);text-align:center}

  .addr-line{display:grid;grid-template-columns:100px 1fr;gap:8px;margin-bottom: 8px;}
  .addr-line #addr_detail{grid-column:1 / -1}

  .pass-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .pass-actions input{width:240px}

  #postcode-layer{display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:9999;width:360px;height:480px;border:1px solid var(--line);border-radius:12px;box-shadow:0 12px 30px rgba(0,0,0,.12);background:#fff;overflow:hidden}
  #postcode-layer .layer-hd{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--line)}
  #postcode-layer .layer-hd strong{font-size:14px}
  #postcode-layer .layer-close{border:0;background:#fff;cursor:pointer;font-size:16px;line-height:1}
  #postcode-layer #postcode-container{width:100%;height:calc(100% - 44px)}

  @media(max-width:820px){
    .row3{grid-template-columns:1fr}
    .row2{grid-template-columns:1fr}
    .seg-phone{grid-template-columns:1fr 14px 1fr 14px 1fr}
    .addr-line{grid-template-columns:100px 1fr}
  }
</style>
<script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script src="https://unpkg.com/@pdf-lib/fontkit@1.1.1/dist/fontkit.umd.min.js"></script>
</head>
<body>
<div class="wrap">
  <h2 style="margin:0 0 12px 0">보험금 청구서 자동기입 PDF 생성</h2>
  <p class="muted" style="margin:0 0 16px 0">새로고침 시 입력값은 초기화됩니다. 내 정보는 <b>암호 저장/불러오기</b>로만 사용하세요.</p>

  <div class="card" style="margin-bottom:16px">
    <h3 style="margin:0 0 8px 0">계약자</h3>
    <div class="row3">
      <div><label>이름</label><input id="sub_name" placeholder="계약자 이름" /></div>
      <div>
        <label>주민등록번호</label>
        <div class="seg seg-rrn">
          <input id="sub_rrn1" inputmode="numeric" maxlength="6" placeholder="앞 6자리" />
          <span class="dash">-</span>
          <input id="sub_rrn2" inputmode="numeric" maxlength="7" placeholder="뒤 7자리" />
        </div>
      </div>
      <div>
        <label>전화번호</label>
        <div class="seg seg-phone">
          <input id="sub_phone1" inputmode="numeric" maxlength="3" placeholder="010" />
          <span class="dash">-</span>
          <input id="sub_phone2" inputmode="numeric" maxlength="4" placeholder="0000" />
          <span class="dash">-</span>
          <input id="sub_phone3" inputmode="numeric" maxlength="4" placeholder="0000" />
        </div>
      </div>
    </div>

    <div style="display:flex;align-items:center;gap:8px;margin:14px 0 6px 0">
      <h3 style="margin:0">피보험자</h3>
      <label style="display:inline-flex;align-items:center;gap:6px;font-size:13px;color:var(--muted)">
        <input type="checkbox" id="samePerson" /> 계약자와 동일
      </label>
    </div>
    <div class="row3">
      <div><label>이름</label><input id="ins_name" placeholder="피보험자 이름" /></div>
      <div>
        <label>주민등록번호</label>
        <div class="seg seg-rrn">
          <input id="ins_rrn1" inputmode="numeric" maxlength="6" placeholder="앞 6자리" />
          <span class="dash">-</span>
          <input id="ins_rrn2" inputmode="numeric" maxlength="7" placeholder="뒤 7자리" />
        </div>
      </div>
      <div>
        <label>전화번호</label>
        <div class="seg seg-phone">
          <input id="ins_phone1" inputmode="numeric" maxlength="3" placeholder="010" />
          <span class="dash">-</span>
          <input id="ins_phone2" inputmode="numeric" maxlength="4" placeholder="0000" />
          <span class="dash">-</span>
          <input id="ins_phone3" inputmode="numeric" maxlength="4" placeholder="0000" />
        </div>
      </div>
    </div>

    <div id="addrBlock" style="margin-top:12px">
      <label>주소</label>
      <div class="addr-line">
        <input id="zip" placeholder="우편번호" readonly />
        <input id="addr" placeholder="도로명주소" readonly />
      </div>
      <div class="addr-line">
        <input id="addr_detail" placeholder="상세주소" />
      </div>
    </div>

    <div class="row3" style="margin-top:12px">
      <div><label>은행명</label><input id="bank_name" placeholder="예: 국민은행" /></div>
      <div><label>계좌번호</label><input id="bank_account" placeholder="숫자/하이픈 가능" /></div>
      <div><label>직장/직무</label><input id="employer_job" placeholder="예: 청구닷컴 / 보험상담사" /></div>
    </div>

    <div class="pass-actions" style="margin-top:12px">
      <input id="passphrase" type="password" placeholder="AES-GCM 암호" />
      <button class="btn" id="btnSaveEnc" type="button">암호 저장</button>
      <button class="btn" id="btnLoadEnc" type="button">암호 불러오기</button>
      <button class="btn" id="btnSample" type="button">샘플 채우기</button>
      <span class="muted">※ 자동 로드는 하지 않습니다.</span>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 12px 0">보험사 선택 및 PDF 생성</h3>
    <div class="row2">
      <div>
        <label>보험사 템플릿 PDF</label>
        <select id="pdfFile"></select>
      </div>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn primary" id="btnMake" type="button" onclick="makePdf()">PDF 만들기</button>
      <a class="btn" id="btnViewRaw" target="_blank" rel="noopener">원본 템플릿 보기</a>
      <span id="status" class="muted"></span>
    </div>
    <p class="muted" style="margin-top:8px">이 방식은 PDF 템플릿에 미리 정의된 '폼 필드'에 값을 채워넣습니다. 템플릿에 주소 필드가 없으면 주소는 입력되지 않습니다.</p>
  </div>
</div>

<div id="postcode-layer" role="dialog" aria-modal="true" aria-label="주소 검색">
  <div class="layer-hd">
    <strong>주소 검색</strong>
    <button class="layer-close" type="button" onclick="closePostcode()" aria-label="닫기">✕</button>
  </div>
  <div id="postcode-container"></div>
</div>

<script>
/* ============== (NEW) PDF 템플릿 경로 ============== */
// 1단계에서 만든 "폼 필드가 심어진" 템플릿 PDF의 경로를 지정합니다.
// 경로는 이 HTML 파일이 있는 위치(cheongu-landing/tools/)를 기준으로 하거나,
// /assets/ 처럼 루트 상대 경로를 사용할 수 있습니다.
const PDF_TEMPLATES = {
  "삼성생명 (템플릿 예시)": "/assets/pdf-templates/samsung-life-template.pdf",
  "KB손해보험 (템플릿 예시)": "/assets/pdf-templates/kb-insurance-template.pdf",
  "삼성화재 (템플릿 예시)": "/assets/pdf-templates/samsung-fire-template.pdf",
  "DB손해 (템플릿 예시)": "/assets/pdf-templates/db-insurance-template.pdf",
  "현대해상 (템플릿 예시)": "/assets/pdf-templates/hyundai-marine-template.pdf"
};


/* ============== 공통 유틸 ============== */
const el = id=>document.getElementById(id);
const $pdfFile=el("pdfFile"), $btnViewRaw=el("btnViewRaw"), $status=el("status"), $same=el("samePerson");

function onlyDigits(e){ e.value = (e.value||"").replace(/\D/g,""); }
function autoAdvance(cur, nextId, max){ onlyDigits(cur); if(cur.value.length>=max){const n=el(nextId); n&&n.focus(); n?.select?.();} }
function autoBackspace(e, prevId){ if(e.key==="Backspace" && !e.target.value){ const p=el(prevId); p&&p.focus(); p?.select?.(); } }

function initSelectors(){
  $pdfFile.innerHTML="";
  for(const [label, path] of Object.entries(PDF_TEMPLATES)){
    const o=document.createElement("option"); o.value=path; o.textContent=label; $pdfFile.appendChild(o);
  }
  updatePdfOptions();
}
function updatePdfOptions(){
  $btnViewRaw.href = $pdfFile.value || "#";
}

/* ============== 데이터 수집/적용 ============== */
// HTML의 id와 PDF 폼 필드 이름을 일치시키는 것이 핵심입니다.
// (예: HTML id="ins_name"  <->  PDF 필드명 "ins_name")
function collectProfile(){
  const p = {};
  const ids = [
    'sub_name', 'sub_rrn1', 'sub_rrn2', 'sub_phone1', 'sub_phone2', 'sub_phone3',
    'ins_name', 'ins_rrn1', 'ins_rrn2', 'ins_phone1', 'ins_phone2', 'ins_phone3',
    'zip', 'addr', 'addr_detail',
    'bank_name', 'bank_account', 'employer_job'
  ];
  ids.forEach(id => {
    p[id] = (el(id).value || "").trim();
  });
  
  // (추가) PDF 템플릿에 'bank_depositor' (예금주) 필드가 있다면,
  // 피보험자 이름을 기본으로 채워줄 수 있습니다.
  p['bank_depositor'] = p.ins_name;
  
  return p;
}

function applyProfile(p){
  for (const [key, value] of Object.entries(p)) {
    if (el(key)) {
      el(key).value = value || "";
    }
  }
}

function fillSample(){
  applyProfile({
    sub_name:"홍길동", sub_rrn1:"900101", sub_rrn2:"1234567", sub_phone1:"010", sub_phone2:"1234", sub_phone3:"5678",
    ins_name:"홍길동", ins_rrn1:"900101", ins_rrn2:"1234567", ins_phone1:"010", ins_phone2:"1234", ins_phone3:"5678",
    zip:"04524", addr:"서울특별시 중구 세종대로 110", addr_detail:"10층 (태평로1가)",
    bank_name:"청구은행", bank_account:"123-456-789012", employer_job:"청구닷컴 / 보험상담사"
  });
  $same.checked = true;
}

/* ============== 암호 저장/불러오기 (기존과 동일) ============== */
async function deriveKey(pass){
  const enc = new TextEncoder();
  const salt = enc.encode("claim-autofill-salt-v3");
  const baseKey = await crypto.subtle.importKey("raw", enc.encode(pass), "PBKDF2", false, ["deriveKey"]);
  return crypto.subtle.deriveKey({ name:"PBKDF2", salt, iterations:120000, hash:"SHA-256" },
    baseKey, { name:"AES-GCM", length:256 }, false, ["encrypt","decrypt"]);
}
async function encryptJSON(obj, pass){
  const key = await deriveKey(pass);
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const data = new TextEncoder().encode(JSON.stringify(obj));
  const cipher = await crypto.subtle.encrypt({name:"AES-GCM", iv}, key, data);
  return { iv: Array.from(iv), cipher: Array.from(new Uint8Array(cipher)) };
}
async function decryptJSON(payload, pass){
  const key = await deriveKey(pass);
  const iv = new Uint8Array(payload.iv);
  const cipher = new Uint8Array(payload.cipher);
  const plain = await crypto.subtle.decrypt({name:"AES-GCM", iv}, key, cipher);
  return JSON.parse(new TextDecoder().decode(plain));
}
const LS_KEY_SECURE = "claim-autofill.profile.enc.v3";
async function saveEncrypted(){ const pass=el("passphrase").value; if(!pass){alert("암호를 입력하세요.");return;}
  const enc=await encryptJSON(collectProfile(),pass); localStorage.setItem(LS_KEY_SECURE,JSON.stringify(enc)); alert("암호 저장 완료"); }
async function loadEncrypted(){ const pass=el("passphrase").value; if(!pass){alert("암호를 입력하세요.");return;}
  const raw=localStorage.getItem(LS_KEY_SECURE); if(!raw){alert("저장된 내 정보가 없습니다.");return;}
  try{ const obj=await decryptJSON(JSON.parse(raw),pass); applyProfile(obj); alert("불러오기 완료"); }
  catch(e){ alert("불러오기 실패: 암호를 확인하세요."); } }

/* ============== 주소검색 (기존과 동일) ============== */
const $layer = document.getElementById('postcode-layer'); const $container = document.getElementById('postcode-container');
function openPostcode(){ $layer.style.display='block';
  new daum.Postcode({ oncomplete:(data)=>{ el("zip").value=data.zonecode||""; el("addr").value=data.roadAddress||data.address||""; el("addr_detail").focus(); closePostcode(); }, width:'100%', height:'100%' }).embed($container); }
function closePostcode(){ $layer.style.display='none'; $container.innerHTML=''; }

/* ============== 이벤트 초기화 ============== */
document.addEventListener("DOMContentLoaded", ()=>{
  initSelectors();

  const syncInsured = ()=>{ if(!$same.checked) return;
    el("ins_name").value=el("sub_name").value;
    el("ins_rrn1").value=el("sub_rrn1").value; el("ins_rrn2").value=el("sub_rrn2").value;
    el("ins_phone1").value=el("sub_phone1").value; el("ins_phone2").value=el("sub_phone2").value; el("ins_phone3").value=el("sub_phone3").value;
  };
  $same.addEventListener("change", syncInsured);
  ["sub_name","sub_rrn1","sub_rrn2","sub_phone1","sub_phone2","sub_phone3"].forEach(id=>el(id).addEventListener("input", syncInsured));

  $pdfFile.addEventListener("change", updatePdfOptions);

  [["sub_phone1","sub_phone2","sub_phone3",3,4],["ins_phone1","ins_phone2","ins_phone3",3,4]].forEach(([a,b,c,ma,mb])=>{
    el(a).addEventListener("input", ()=>autoAdvance(el(a),b,ma)); el(b).addEventListener("input", ()=>autoAdvance(el(b),c,mb)); el(c).addEventListener("input", ()=>onlyDigits(el(c)));
    el(b).addEventListener("keydown", (e)=>autoBackspace(e,a)); el(c).addEventListener("keydown", (e)=>autoBackspace(e,b));
  });
  [["sub_rrn1","sub_rrn2",6],["ins_rrn1","ins_rrn2",6]].forEach(([a,b,mx])=>{
    el(a).addEventListener("input", ()=>autoAdvance(el(a),b,mx)); el(b).addEventListener("input", ()=>onlyDigits(el(b))); el(b).addEventListener("keydown",(e)=>autoBackspace(e,a));
  });

  el("zip").addEventListener("click", openPostcode);
  el("addr").addEventListener("click", openPostcode);
  el("addr_detail").addEventListener("focus", ()=>{ if(!el("addr").value) openPostcode(); });

  el("btnSample").addEventListener("click", fillSample);
  el("btnSaveEnc").addEventListener("click", ()=>{ saveEncrypted().catch(e=>alert(e.message)); });
  el("btnLoadEnc").addEventListener("click", ()=>{ loadEncrypted().catch(e=>alert(e.message)); });
});

/* ============== 폰트 로더 (기존과 동일) ============== */
// (중요) 폼 필드 방식에서도 한글을 채워넣으려면 폰트 임베딩이 "필수"입니다.
async function loadKoreanFontBytes(){
  const cdn = 'https://cdn.jsdelivr.net/gh/googlefonts/noto-cjk@main/Sans/OTF/Korean/NotoSansKR-Regular.otf';
  const candidates = [
    // 로컬 경로를 우선 탐색
    `${location.origin}/assets/fonts/NotoSansKR-Regular.otf`,
    '/assets/fonts/NotoSansKR-Regular.otf',
    cdn // 최후의 보루
  ];
  for (const url of candidates){
    try{
      const resp = await fetch(url, { cache:'no-store' });
      if (resp.ok){
        const buf = await resp.arrayBuffer();
        if (buf.byteLength > 1024){ console.log('[font] loaded:', url); return buf; }
      } else { console.log('[font] miss(status):', url, resp.status); }
    }catch(e){ console.log('[font] miss(err):', url, e?.message||e); }
  }
  console.warn('[font] no font found -> ASCII fallback');
  return null;
}

/* ============== (NEW) PDF 생성: 폼 필드 채우기 방식 ============== */
async function makePdf(){
  const btn = el("btnMake");
  $status.textContent = "PDF 생성 중…";
  btn.disabled = true;

  try {
    const P = collectProfile();
    if(!P?.ins_name){ alert("피보험자 이름을 입력하세요."); return; }

    const srcPath = $pdfFile.value;
    if(!srcPath){ alert("템플릿 PDF를 선택하세요."); return; }

    const { PDFDocument, StandardFonts } = PDFLib;
    
    // 1. 원본 "템플릿" PDF 불러오기
    const url = new URL(encodeURI(srcPath), location.origin).toString();
    const existingPdfBytes = await fetch(url, { cache:"no-store" }).then(res => res.arrayBuffer());
    
    const pdfDoc = await PDFDocument.load(existingPdfBytes, { ignoreEncryption:true });
    if (typeof fontkit !== "undefined") pdfDoc.registerFontkit(fontkit);

    // 2. 폰트 임베드 (한글 표기를 위해 필수)
    let kFont = null;
    try{
      const bytes = await loadKoreanFontBytes();
      if (bytes) kFont = await pdfDoc.embedFont(bytes, { subset:true });
    }catch(e){ console.error("폰트 임베딩 실패:", e); }
    
    const fontToUse = kFont || await pdfDoc.embedFont(StandardFonts.Helvetica);

    // 3. 폼 가져오기 및 필드 채우기
    const form = pdfDoc.getForm();
    
    // P 객체 (collectProfile 결과)에 있는 모든 키-값을 순회하며
    // PDF 템플릿에 "같은 이름의 폼 필드"가 있는지 찾아보고 값을 채웁니다.
    for (const [fieldName, text] of Object.entries(P)) {
      if (!text) continue; // 빈 값은 스킵
      
      try {
        const field = form.getTextField(fieldName);
        field.setText(text.toString());
        field.updateAppearances(fontToUse); // ★ 중요: 필드에 한글 폰트 적용
      } catch (e) {
        // 템플릿에 해당 필드가 없으면 무시하고 넘어감
        // (예: 주소 필드가 없는 템플릿의 경우 zip, addr 등은 무시됨)
        // console.warn(`폼 필드 '${fieldName}'를 찾을 수 없습니다.`);
      }
    }
    
    // (선택) 체크박스 채우기 (예시)
    // if (form.getCheckBox('medical_aid_yes')) {
    //   form.getCheckBox('medical_aid_yes').check();
    // }

    // 4. 폼 필드를 '읽기 전용'으로 납작하게 만듭니다. (수정 불가하게 함)
    form.flatten();

    // 5. PDF 저장 및 다운로드
    const pdfBytes = await pdfDoc.save();
    const blob = new Blob([pdfBytes], { type:"application/pdf" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    
    const carrierName = $pdfFile.options[$pdfFile.selectedIndex].text.split(' ')[0];
    a.download = `${carrierName || 'insurer'}_claim_autofill.pdf`;
    
    a.click();
    URL.revokeObjectURL(a.href);

    $status.textContent = (kFont ? "완료(한글 폰트 적용)" : "완료(ASCII 폴백)");
  } catch(err) {
    console.error(err);
    alert("PDF 생성 실패: " + (err?.message||err));
    $status.textContent = "실패";
  } finally {
    btn.disabled = false;
  }
}
window.makePdf = makePdf;
</script>
</body>
</html>
