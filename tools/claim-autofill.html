<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>보험금 청구서 자동채움 · 인쇄</title>
<meta name="format-detection" content="telephone=no" />
<style>
  :root{
    --bg:#f6f8fb; --card:#fff; --ink:#111827; --muted:#6b7280; --brand:#3a64ff; --line:#e5e7eb;
    --radius:16px; --shadow:0 10px 30px rgba(17,24,39,.08);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1000px;margin:24px auto;padding:16px}
  .grid{display:grid;gap:16px}
  .two{grid-template-columns:1fr 1fr}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
  .hd{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--line)}
  .hd h2{margin:0;font-size:18px}
  .bd{padding:16px 20px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input,select{width:100%;padding:12px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;font-size:14px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 16px;border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer}
  .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
  .btn.ghost{background:#fff}
  .btnbar{display:flex;gap:8px;flex-wrap:wrap}
  .muted{color:var(--muted);font-size:12px}
  .preview{line-height:1.6}
  .formgrid{display:grid;grid-template-columns:220px 1fr;gap:10px;align-items:center}
  .field{border:1px solid var(--line);padding:10px;border-radius:10px;background:#fff;min-height:42px}
  .label{font-weight:600}
  .hr{height:1px;background:var(--line);margin:12px 0}
  @media (max-width:860px){ .two{grid-template-columns:1fr} .formgrid{grid-template-columns:1fr} }
  @media print{
    body{background:#fff}
    .no-print{display:none !important}
    .wrap{max-width:100%;margin:0;padding:0}
    .card{border:none;box-shadow:none}
    .bd{padding:0}
    .print-page{page-break-after:always;padding:12mm}
    .formgrid{grid-template-columns:200px 1fr}
  }
</style>
</head>
<body>
<div class="wrap grid two">
  <!-- 내 정보 -->
  <section class="card">
    <div class="hd">
      <h2>내 기본정보</h2>
      <div class="btnbar no-print">
        <button class="btn ghost" id="btnExport">내 정보 내보내기</button>
        <label class="btn ghost" for="importFile">불러오기</label>
        <input id="importFile" type="file" accept=".json" hidden />
      </div>
    </div>
    <div class="bd grid" style="gap:14px">
      <div class="row">
        <div>
          <label>이름</label>
          <input id="name" autocomplete="name" />
        </div>
        <div>
          <label>전화번호(숫자만)</label>
          <input id="phone" inputmode="numeric" autocomplete="tel" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>주민등록번호(13자리·숫자만)</label>
          <input id="rrn" inputmode="numeric" />
        </div>
        <div>
          <label>계좌번호(은행명 포함)</label>
          <input id="account" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>직장명</label>
          <input id="employer" />
        </div>
        <div>
          <label>하는 일(직무)</label>
          <input id="job" />
        </div>
      </div>

      <div class="hr"></div>

      <div class="row no-print">
        <div>
          <label>로컬 저장 암호(선택·설정 시 암호화 저장)</label>
          <input id="passphrase" type="password" placeholder="암호 설정 또는 해제" />
        </div>
        <div class="btnbar" style="align-items:end">
          <button class="btn" id="btnSave">저장/업데이트</button>
          <button class="btn" id="btnClear">정보 삭제</button>
        </div>
      </div>
      <p class="muted no-print">개인정보는 브라우저 <b>로컬 저장소</b>에만 보관됩니다. 암호를 입력한 상태로 저장하면 <b>AES-GCM</b>으로 암호화됩니다.</p>
    </div>
  </section>

  <!-- 회사/양식 선택 + 미리보기/인쇄 -->
  <section class="card">
    <div class="hd">
      <h2>회사별 청구서 자동채움</h2>
      <div class="btnbar no-print">
        <button class="btn primary" id="btnPrint">인쇄(PDF)</button>
      </div>
    </div>
    <div class="bd grid" style="gap:14px">
      <div class="row no-print">
        <div>
          <label>보험사</label>
          <select id="carrier"></select>
        </div>
        <div>
          <label>양식(라벨세트)</label>
          <select id="formset"></select>
        </div>
      </div>

      <!-- 인쇄 영역 -->
      <div class="print-page">
        <div class="preview">
          <h3 style="margin:0 0 8px 0">보험금 청구서(자동채움 미리보기)</h3>
          <div class="muted" id="metaLine"></div>
          <div class="hr"></div>
          <div id="formGrid" class="formgrid"></div>
          <div class="hr"></div>
          <div class="grid" style="gap:8px">
            <div class="label">서명(자필)</div>
            <div class="field" style="height:64px"></div>
            <div class="label">날짜</div>
            <div class="field" id="todayBox"></div>
          </div>
          <p class="muted" style="margin-top:10px">※ 실제 보험사 제출 시, 회사 고유 양식(다운로드 PDF/페이지)에 동일 내용으로 기입하여 제출하세요.</p>
        </div>
      </div>

      <div class="no-print">
        <div class="hr"></div>
        <details>
          <summary><b>라벨 커스터마이즈/회사 추가 방법</b></summary>
          <p class="muted">아래 <code>FORMS</code> 객체에 회사 키(예: <code>"삼성화재"</code>)를 추가하고, 라벨/필드 순서를 원하는 대로 정의하세요.</p>
        </details>
      </div>
    </div>
  </section>
</div>

<script>
/** ===== 회사별 라벨/순서 정의 =====
 * 각 항목은 [라벨, 데이터키] 형태.
 * 데이터키는 아래 PROFILE_KEYS 중 하나: name, rrn, phone, account, employer, job
 * 필요시 라벨을 회사 관용어로 맞추면 됩니다.
 */
const FORMS = {
  "삼성화재": {
    "기본 청구서": [
      ["피보험자 성명", "name"],
      ["주민(외국인)등록번호", "rrn"],
      ["연락처", "phone"],
      ["보험금 수령계좌", "account"],
      ["직장명(사업장)", "employer"],
      ["직무(하는 일)", "job"],
    ],
    "입원/통원 공통": [
      ["피보험자 성명", "name"],
      ["연락처", "phone"],
      ["주민등록번호", "rrn"],
      ["계좌(은행명/번호)", "account"],
      ["회사명", "employer"],
      ["업무내용", "job"],
    ]
  },
  "현대해상": {
    "일반 청구서": [
      ["계약자/피보험자 성명", "name"],
      ["주민번호", "rrn"],
      ["휴대전화", "phone"],
      ["지급계좌", "account"],
      ["근무처", "employer"],
      ["직무", "job"],
    ]
  },
  "DB손해": {
    "간편 청구": [
      ["성명", "name"],
      ["주민등록번호", "rrn"],
      ["연락처", "phone"],
      ["수령계좌", "account"],
      ["직장명", "employer"],
      ["직무", "job"],
    ]
  },
  "기타": {
    "공통(커스텀)": [
      ["이름", "name"],
      ["주민등록번호", "rrn"],
      ["전화번호", "phone"],
      ["계좌번호", "account"],
      ["직장명", "employer"],
      ["하시는 일", "job"],
    ]
  }
};

const PROFILE_KEYS = ["name","rrn","phone","account","employer","job"];

/** ===== 암호화 유틸(AES-GCM, Web Crypto) ===== */
async function deriveKey(passphrase){
  const enc = new TextEncoder();
  const salt = enc.encode("claim-autofill-salt-v1");
  const baseKey = await crypto.subtle.importKey("raw", enc.encode(passphrase), "PBKDF2", false, ["deriveKey"]);
  return crypto.subtle.deriveKey(
    { name:"PBKDF2", salt, iterations: 120000, hash: "SHA-256" },
    baseKey,
    { name:"AES-GCM", length:256 },
    false,
    ["encrypt","decrypt"]
  );
}
async function encryptJson(obj, passphrase){
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const key = await deriveKey(passphrase);
  const data = new TextEncoder().encode(JSON.stringify(obj));
  const cipher = await crypto.subtle.encrypt({name:"AES-GCM", iv}, key, data);
  return { iv: Array.from(iv), cipher: Array.from(new Uint8Array(cipher)) };
}
async function decryptJson(payload, passphrase){
  const key = await deriveKey(passphrase);
  const iv = new Uint8Array(payload.iv);
  const cipher = new Uint8Array(payload.cipher);
  const plain = await crypto.subtle.decrypt({name:"AES-GCM", iv}, key, cipher);
  return JSON.parse(new TextDecoder().decode(plain));
}

/** ===== 로컬 스토리지 키 ===== */
const LS_KEY = "claim-autofill.profile";      // 평문 저장
const LS_KEY_SECURE = "claim-autofill.profile.secure"; // 암호화 저장

/** ===== DOM ===== */
const el = (id)=>document.getElementById(id);
const $name=el("name"), $rrn=el("rrn"), $phone=el("phone"), $account=el("account"), $employer=el("employer"), $job=el("job");
const $pass=el("passphrase");
const $carrier=el("carrier"), $formset=el("formset");
const $formGrid=el("formGrid"), $metaLine=el("metaLine"), $todayBox=el("todayBox");

/** ===== 상태 ===== */
let currentProfile = { name:"", rrn:"", phone:"", account:"", employer:"", job:"" };

/** ===== 초기화 ===== */
function initSelectors(){
  $carrier.innerHTML = "";
  Object.keys(FORMS).forEach(c=>{
    const opt = document.createElement("option");
    opt.value = c; opt.textContent = c;
    $carrier.appendChild(opt);
  });
  updateFormsetOptions();
}
function updateFormsetOptions(){
  const carrier = $carrier.value;
  const sets = Object.keys(FORMS[carrier]||{});
  $formset.innerHTML = "";
  sets.forEach(s=>{
    const opt = document.createElement("option");
    opt.value=s; opt.textContent=s;
    $formset.appendChild(opt);
  });
}

/** ===== 프로필 로드/세이브 ===== */
async function loadProfile(){
  // 1) 암호화본 시도
  const sec = localStorage.getItem(LS_KEY_SECURE);
  if(sec){
    try{
      if(!$pass.value){
        // 암호 없으면 해독 불가 → 건너뛰고 평문 확인
      }else{
        const obj = await decryptJson(JSON.parse(sec), $pass.value);
        currentProfile = { ...currentProfile, ...obj };
      }
    }catch(e){
      console.warn("암호화 데이터 해독 실패", e);
    }
  }
  // 2) 평문본 병합
  const plain = localStorage.getItem(LS_KEY);
  if(plain){
    try{
      const obj = JSON.parse(plain);
      currentProfile = { ...currentProfile, ...obj };
    }catch(e){}
  }
  // UI 반영
  $name.value = currentProfile.name||"";
  $rrn.value = currentProfile.rrn||"";
  $phone.value = currentProfile.phone||"";
  $account.value = currentProfile.account||"";
  $employer.value = currentProfile.employer||"";
  $job.value = currentProfile.job||"";
  renderPreview();
}
async function saveProfile(){
  const obj = collectProfileFromInputs();
  // 평문 저장(로컬 전용 편의)
  localStorage.setItem(LS_KEY, JSON.stringify(obj));
  // 암호 설정 시 암호화 병행 저장
  if($pass.value){
    const enc = await encryptJson(obj, $pass.value);
    localStorage.setItem(LS_KEY_SECURE, JSON.stringify(enc));
  }
  currentProfile = obj;
  alert("저장되었습니다.");
  renderPreview();
}
function clearProfile(){
  if(!confirm("저장된 내 정보를 삭제할까요?")) return;
  localStorage.removeItem(LS_KEY);
  localStorage.removeItem(LS_KEY_SECURE);
  currentProfile = { name:"", rrn:"", phone:"", account:"", employer:"", job:"" };
  $name.value=$rrn.value=$phone.value=$account.value=$employer.value=$job.value="";
  alert("삭제되었습니다.");
  renderPreview();
}
function collectProfileFromInputs(){
  return {
    name: ($name.value||"").trim(),
    rrn: ($rrn.value||"").replace(/\D/g,""),
    phone: ($phone.value||"").replace(/\D/g,""),
    account: ($account.value||"").trim(),
    employer: ($employer.value||"").trim(),
    job: ($job.value||"").trim(),
  };
}

/** ===== 미리보기 렌더 ===== */
function renderPreview(){
  const carrier = $carrier.value;
  const setName = $formset.value;
  const spec = (FORMS[carrier] && FORMS[carrier][setName]) ? FORMS[carrier][setName] : [];
  // 메타라인
  $metaLine.textContent = `회사: ${carrier} · 양식: ${setName}`;
  // 오늘 날짜
  const now = new Date();
  const y = now.getFullYear(), m = String(now.getMonth()+1).padStart(2,"0"), d = String(now.getDate()).padStart(2,"0");
  $todayBox.textContent = `${y}-${m}-${d}`;
  // 그리드
  $formGrid.innerHTML = "";
  spec.forEach(([label,key])=>{
    const L = document.createElement("div");
    L.className="label";
    L.textContent=label;
    const V = document.createElement("div");
    V.className="field";
    V.textContent = (currentProfile[key]||"");
    $formGrid.appendChild(L);
    $formGrid.appendChild(V);
  });
}

/** ===== 내보내기/불러오기 ===== */
function exportProfile(){
  const data = {
    version:"v1",
    exportedAt:new Date().toISOString(),
    profile: collectProfileFromInputs()
  };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "claim-profile.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
}
function importProfile(file){
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const obj = JSON.parse(reader.result);
      if(obj && obj.profile){
        currentProfile = {...currentProfile, ...obj.profile};
        // 평문 저장
        localStorage.setItem(LS_KEY, JSON.stringify(currentProfile));
        // UI 반영
        $name.value=currentProfile.name||"";
        $rrn.value=currentProfile.rrn||"";
        $phone.value=currentProfile.phone||"";
        $account.value=currentProfile.account||"";
        $employer.value=currentProfile.employer||"";
        $job.value=currentProfile.job||"";
        renderPreview();
        alert("불러오기 완료");
      }else{
        alert("알 수 없는 파일 형식입니다.");
      }
    }catch(e){
      alert("불러오기 실패: "+e.message);
    }
  };
  reader.readAsText(file);
}

/** ===== 이벤트 ===== */
document.addEventListener("DOMContentLoaded", async ()=>{
  initSelectors();
  await loadProfile();
  $carrier.addEventListener("change", ()=>{ updateFormsetOptions(); renderPreview(); });
  $formset.addEventListener("change", renderPreview);
  [$name,$rrn,$phone,$account,$employer,$job].forEach(i=>i.addEventListener("input",()=>{
    currentProfile = collectProfileFromInputs();
    renderPreview();
  }));
  el("btnSave").addEventListener("click", saveProfile);
  el("btnClear").addEventListener("click", clearProfile);
  el("btnPrint").addEventListener("click", ()=>window.print());
  el("btnExport").addEventListener("click", exportProfile);
  el("importFile").addEventListener("change", (e)=>{
    const file = e.target.files?.[0]; if(file) importProfile(file);
    e.target.value = "";
  });
});
</script>
</body>
</html>
