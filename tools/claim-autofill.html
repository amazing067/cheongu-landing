<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>보험금 청구서 자동기입 PDF 생성</title>
<meta name="format-detection" content="telephone=no" />
<style>
  :root{--bg:#f6f8fb;--card:#fff;--ink:#111827;--muted:#6b7280;--brand:#3a64ff;--line:#e5e7eb;--radius:16px;--shadow:0 10px 30px rgba(17,24,39,.08)}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:900px;margin:24px auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px 20px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input,select{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;font-size:14px}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:12px 16px;border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer}
  .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
  .muted{color:var(--muted);font-size:12px}

  /* 상단 1줄: 이름 | 주민번호 | 전화번호 */
  .rowTop{display:grid;grid-template-columns:140px 280px 1fr;gap:12px}
  .seg{display:grid;gap:0;align-items:center}
  .seg-rrn{grid-template-columns:100px 14px 120px}
  .seg-phone{grid-template-columns:72px 14px 84px 14px 84px}
  .seg input{text-align:center;letter-spacing:1px}
  .dash{color:var(--muted);text-align:center}

  /* 주소 1줄: 우편번호(작게) | 도로명(크게) | 상세주소(크게) */
  .addr-line{display:grid;grid-template-columns:100px 1fr 1fr;gap:8px}
  .addr-line input{min-width:0}

  /* 은행(좁게) | 계좌 | 직장/직무 */
  .rowBankJob{display:grid;grid-template-columns:160px 1fr 1fr;gap:12px}

  .pass-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .pass-actions input{width:240px}

  /* 주소검색 레이어 */
  #postcode-layer{display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:9999;width:360px;height:480px;border:1px solid var(--line);border-radius:12px;box-shadow:0 12px 30px rgba(0,0,0,.12);background:#fff;overflow:hidden}
  #postcode-layer .layer-hd{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--line)}
  #postcode-layer .layer-hd strong{font-size:14px}
  #postcode-layer .layer-close{border:0;background:#fff;cursor:pointer;font-size:16px;line-height:1}
  #postcode-layer #postcode-container{width:100%;height:calc(100% - 44px)}

  @media(max-width:820px){
    .rowTop{grid-template-columns:1fr}
    .addr-line{grid-template-columns:100px 1fr}
    .addr-line #addrDetail{grid-column:1 / -1}
    .rowBankJob{grid-template-columns:1fr}
    .seg-rrn{grid-template-columns:1fr 14px 1fr}
    .seg-phone{grid-template-columns:1fr 14px 1fr 14px 1fr}
  }
</style>
<!-- 주소검색 -->
<script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<!-- pdf-lib & fontkit (한글 폰트 임베드용) -->
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script src="https://unpkg.com/@pdf-lib/fontkit@1.1.1/dist/fontkit.umd.min.js"></script>
</head>
<body>
<div class="wrap">
  <h2 style="margin:0 0 12px 0">보험금 청구서 자동기입 PDF 생성</h2>
  <p class="muted" style="margin:0 0 16px 0">새로고침 시 입력값은 초기화됩니다. 내 정보는 <b>암호 저장/불러오기</b>로만 사용하세요.</p>

  <div class="card" style="margin-bottom:16px">
    <h3 style="margin:0 0 12px 0">내 기본정보</h3>

    <div class="rowTop">
      <div>
        <label>이름</label>
        <input id="name" placeholder="이름" />
      </div>
      <div>
        <label>주민등록번호</label>
        <div class="seg seg-rrn">
          <input id="rrn1" inputmode="numeric" maxlength="6" placeholder="앞 6자리" />
          <span class="dash">-</span>
          <input id="rrn2" inputmode="numeric" maxlength="7" placeholder="뒤 7자리" />
        </div>
      </div>
      <div>
        <label>전화번호</label>
        <div class="seg seg-phone">
          <input id="phone1" inputmode="numeric" maxlength="3" placeholder="010" />
          <span class="dash">-</span>
          <input id="phone2" inputmode="numeric" maxlength="4" placeholder="0000" />
          <span class="dash">-</span>
          <input id="phone3" inputmode="numeric" maxlength="4" placeholder="0000" />
        </div>
      </div>
    </div>

    <div style="margin-top:12px">
      <label>주소</label>
      <div class="addr-line">
        <input id="zip" placeholder="우편번호" readonly />
        <input id="addr" placeholder="도로명주소" readonly />
        <input id="addrDetail" placeholder="상세주소" />
      </div>
    </div>

    <div class="rowBankJob" style="margin-top:12px">
      <div><label>은행명</label><input id="bankName" placeholder="예: 국민은행" /></div>
      <div><label>계좌번호</label><input id="accountNumber" placeholder="숫자/하이픈 가능" /></div>
      <div><label>직장/직무</label><input id="employerJob" placeholder="예: 청구닷컴 / 보험상담사" /></div>
    </div>

    <div class="pass-actions" style="margin-top:12px">
      <input id="passphrase" type="password" placeholder="AES-GCM 암호" />
      <button class="btn" id="btnSaveEnc" type="button">암호 저장</button>
      <button class="btn" id="btnLoadEnc" type="button">암호 불러오기</button>
      <button class="btn" id="btnSample" type="button">샘플 채우기</button>
      <span class="muted">※ 자동 로드는 하지 않습니다.</span>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 12px 0">보험사 선택 및 PDF 생성</h3>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div>
        <label>보험사</label>
        <select id="carrier"></select>
      </div>
      <div>
        <label>청구서 PDF</label>
        <select id="pdfFile"></select>
      </div>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn primary" id="btnMake" type="button" onclick="makePdf()">PDF 만들기</button>
      <a class="btn" id="btnViewRaw" target="_blank" rel="noopener">원본 PDF 보기</a>
      <span id="status" class="muted"></span>
    </div>
    <p class="muted" style="margin-top:8px">다음 단계에서 각 보험사 PDF 내부 칸에 직접 텍스트를 찍는 “스탬프/폼 채움”을 추가합니다.</p>
  </div>
</div>

<!-- 주소검색 레이어 -->
<div id="postcode-layer" role="dialog" aria-modal="true" aria-label="주소 검색">
  <div class="layer-hd">
    <strong>주소 검색</strong>
    <button class="layer-close" type="button" onclick="closePostcode()" aria-label="닫기">✕</button>
  </div>
  <div id="postcode-container"></div>
</div>

<script>
/* ====== PDF 경로 매핑 ====== */
const PDF_MAP = {
  "삼성화재": [["보험금청구서", "/assets/pdf/삼성화재-보험금청구서.pdf"]],
  "현대해상": [["보험금청구서", "/assets/pdf/현대해상-보험금청구서.pdf"]],
  "DB손해": [
    ["보험금청구서", "/assets/pdf/DB손해보험-보험금청구서.pdf"],
    ["치과치료확인서", "/assets/pdf/DB손해보험 치과치료확인서.pdf"]
  ],
  "KB손해": [["보험금청구서", "/assets/pdf/KB손해보험-보험금청구서.pdf"]],
  "KB라이프생명": [["보험금청구서", "/assets/pdf/KB라이프생명 보험금청구서.pdf"]],
  "AIA생명": [
    ["보험금청구서", "/assets/pdf/AIA생명-보험금청구서.pdf"],
    ["치과치료확인서", "/assets/pdf/AIA생명 치과치료확인서.pdf"]
  ],
  "ABL생명": [
    ["보험금청구서", "/assets/pdf/ABL생명-보험금청구서.pdf"],
    ["치과치료확인서", "/assets/pdf/ABL생명 치과치료확인서.pdf"]
  ],
  "AXA손해보험": [
    ["보험금청구서", "/assets/pdf/AXA손해보험.pdf"],
    ["치과치료확인서", "/assets/pdf/AXA손해보험 치과치료확인서.pdf"]
  ],
  "AIG손해보험": [["치과치료확인서", "/assets/pdf/AIG손해보험 치과치료확인서.pdf"]],
  "기타": [["공란 커버만 생성", ""]]
};

/* ====== AES-GCM 암호화 유틸 ====== */
async function deriveKey(pass){
  const enc = new TextEncoder();
  const salt = enc.encode("claim-autofill-salt-v3");
  const baseKey = await crypto.subtle.importKey("raw", enc.encode(pass), "PBKDF2", false, ["deriveKey"]);
  return crypto.subtle.deriveKey(
    { name:"PBKDF2", salt, iterations:120000, hash:"SHA-256" },
    baseKey, { name:"AES-GCM", length:256 }, false, ["encrypt","decrypt"]
  );
}
async function encryptJSON(obj, pass){
  const key = await deriveKey(pass);
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const data = new TextEncoder().encode(JSON.stringify(obj));
  const cipher = await crypto.subtle.encrypt({name:"AES-GCM", iv}, key, data);
  return { iv: Array.from(iv), cipher: Array.from(new Uint8Array(cipher)) };
}
async function decryptJSON(payload, pass){
  const key = await deriveKey(pass);
  const iv = new Uint8Array(payload.iv);
  const cipher = new Uint8Array(payload.cipher);
  const plain = await crypto.subtle.decrypt({name:"AES-GCM", iv}, key, cipher);
  return JSON.parse(new TextDecoder().decode(plain));
}
const LS_KEY_SECURE = "claim-autofill.profile.enc.v3";

/* ====== DOM ====== */
const el = (id)=>document.getElementById(id);
const $name=el("name");
const $phone1=el("phone1"), $phone2=el("phone2"), $phone3=el("phone3");
const $rrn1=el("rrn1"), $rrn2=el("rrn2");
const $zip=el("zip"), $addr=el("addr"), $addrDetail=el("addrDetail");
const $bankName=el("bankName"), $accountNumber=el("accountNumber");
const $employerJob=el("employerJob");
const $pass=el("passphrase");
const $carrier=el("carrier"), $pdfFile=el("pdfFile"), $btnViewRaw=el("btnViewRaw"), $status=el("status");

/* ====== 셀렉터 ====== */
function initSelectors(){
  $carrier.innerHTML="";
  Object.keys(PDF_MAP).forEach(k=>{
    const o=document.createElement("option"); o.value=k; o.textContent=k; $carrier.appendChild(o);
  });
  updatePdfOptions();
}
function updatePdfOptions(){
  const list = PDF_MAP[$carrier.value] || [];
  $pdfFile.innerHTML="";
  list.forEach(([label, path])=>{
    const o=document.createElement("option"); o.value=path; o.textContent=label; $pdfFile.appendChild(o);
  });
  $btnViewRaw.href = (list[0]?.[1]||"#");
}

/* ====== 프로필 저장/불러오기 ====== */
function collectProfile(){
  const phone = [$phone1.value,$phone2.value,$phone3.value].map(v=>(v||"").replace(/\D/g,"")).join("-");
  const rrn = [$rrn1.value,$rrn2.value].map(v=>(v||"").replace(/\D/g,"")).join("-");
  const addressFull = [($zip.value||"").trim(), ($addr.value||"").trim(), ($addrDetail.value||"").trim()].filter(Boolean).join(" ");
  return {
    name: ($name.value||"").trim(),
    phone, rrn,
    zip: ($zip.value||"").trim(),
    addr: ($addr.value||"").trim(),
    addrDetail: ($addrDetail.value||"").trim(),
    address: addressFull,
    bankName: ($bankName.value||"").trim(),
    accountNumber: ($accountNumber.value||"").trim(),
    employerJob: ($employerJob.value||"").trim()
  };
}
function applyProfile(p){
  $name.value = p.name||"";
  const [p1="",p2="",p3=""] = (p.phone||"").split("-");
  $phone1.value=p1; $phone2.value=p2; $phone3.value=p3;
  const [r1="",r2=""] = (p.rrn||"").split("-");
  $rrn1.value=r1; $rrn2.value=r2;
  $zip.value=p.zip||""; $addr.value=p.addr||""; $addrDetail.value=p.addrDetail||"";
  $bankName.value=p.bankName||""; $accountNumber.value=p.accountNumber||"";
  $employerJob.value=p.employerJob||"";
}
async function saveEncrypted(){
  if(!$pass.value){ alert("암호를 입력하세요."); return; }
  const enc = await encryptJSON(collectProfile(), $pass.value);
  localStorage.setItem(LS_KEY_SECURE, JSON.stringify(enc));
  alert("암호 저장 완료");
}
async function loadEncrypted(){
  if(!$pass.value){ alert("암호를 입력하세요."); return; }
  const raw = localStorage.getItem(LS_KEY_SECURE);
  if(!raw){ alert("저장된 내 정보가 없습니다."); return; }
  try{
    const obj = await decryptJSON(JSON.parse(raw), $pass.value);
    applyProfile(obj);
    alert("불러오기 완료");
  }catch(e){ alert("불러오기 실패: 암호를 확인하세요."); }
}
function fillSample(){
  applyProfile({
    name:"홍길동",
    phone:"010-1234-5678",
    rrn:"900101-1234567",
    zip:"04524",
    addr:"서울특별시 중구 세종대로 110",
    addrDetail:"10층",
    bankName:"국민은행",
    accountNumber:"123-456-789012",
    employerJob:"청구닷컴 / 보험상담사"
  });
}

/* ====== 입력 보조 ====== */
function onlyDigits(elm){ elm.value = (elm.value||"").replace(/\D/g,""); }
function autoAdvance(cur, nextId, max){
  onlyDigits(cur);
  if(cur.value.length >= max){
    const n = document.getElementById(nextId);
    if(n){ n.focus(); n.select?.(); }
  }
}
function autoBackspace(e, prevId){
  if(e.key==="Backspace" && !e.target.value){
    const p = document.getElementById(prevId);
    if(p){ p.focus(); p.select?.(); }
  }
}

/* ====== 주소검색 ====== */
const $layer = document.getElementById('postcode-layer');
const $container = document.getElementById('postcode-container');
function openPostcode(){
  $layer.style.display = 'block';
  new daum.Postcode({
    oncomplete: function(data){
      const road = data.roadAddress || data.address || "";
      $zip.value = data.zonecode || "";
      $addr.value = road;
      $addrDetail.focus();
      closePostcode();
    },
    width:'100%', height:'100%'
  }).embed($container);
}
function closePostcode(){
  $layer.style.display = 'none';
  $container.innerHTML = '';
}

/* ====== 유니코드 폰트 로더 (한글용) ====== */
async function loadKoreanFontBytes(){
  // 1) 리포에 업로드된 로컬 폰트가 있으면 우선 사용
  const candidates = [
    "/assets/fonts/NanumGothic-Regular.ttf",
    "/assets/fonts/NotoSansKR-Regular.otf",
    // 2) CDN 예비 경로(없으면 무시)
    "https://cdn.jsdelivr.net/gh/googlefonts/noto-cjk@main/Sans/OTF/Korean/NotoSansKR-Regular.otf"
  ];
  for (const url of candidates){
    try{
      const resp = await fetch(url, { cache:"no-store", mode:"cors" });
      if (resp.ok){
        const buf = await resp.arrayBuffer();
        if (buf.byteLength > 0) return buf;
      }
    }catch(_){}
  }
  return null; // 없으면 null
}

/* ====== PDF 생성 (강제 ASCII 안전모드) ====== */
async function makePdf(){
  const btn = document.getElementById("btnMake");
  const $status = document.getElementById("status");
  $status.textContent = "PDF 생성 중…";
  btn.disabled = true;

  try{
    const P = collectProfile();
    if(!P.name){ alert("이름을 입력하세요."); return; }

    const { PDFDocument, StandardFonts, rgb } = PDFLib;

    // 1) 새 문서
    const out = await PDFDocument.create();
    const helv = await out.embedFont(StandardFonts.Helvetica);

    // ⚠ 안전모드: 비-ASCII 문자 제거/대체 (폰트 미로딩 시 오류 방지)
    const toASCII = (s) => String(s ?? "")
      // 줄바꿈, 탭은 허용
      .replace(/[^\x09\x0A\x0D\x20-\x7E]/g, "?");

    // 2) 커버 페이지 (표시는 영어/ASCII 임시표기)
    const page = out.addPage([595.28, 841.89]); // A4
    const title = "Claim Cover (Auto-Fill)";
    const today = new Date();
    const y = today.getFullYear();
    const m = String(today.getMonth()+1).padStart(2,"0");
    const d = String(today.getDate()).padStart(2,"0");

    page.drawText(title, { x: 50, y: 790, size: 18, font: helv, color: rgb(0.1,0.1,0.2) });
    page.drawText(`Generated: ${y}-${m}-${d}`, { x: 50, y: 770, size: 11, font: helv, color: rgb(0.4,0.4,0.5) });

    page.drawRectangle({ x:40, y: 460, width: 515, height: 300, borderColor: rgb(0.85,0.87,0.92), borderWidth: 1, color: rgb(1,1,1) });

    const rows = [
      ["Name", P.name],
      ["RRN", P.rrn],
      ["Phone", P.phone],
      ["Address", P.address],
      ["Bank", P.bankName],
      ["Account No.", P.accountNumber],
      ["Employer/Job", P.employerJob]
    ];
    let yPos = 720;
    for(const [label, val] of rows){
      page.drawText(label, { x: 55, y: yPos, size: 11, font: helv, color: rgb(0.35,0.35,0.45) });
      page.drawText(toASCII(val), { x: 200, y: yPos, size: 13, font: helv, color: rgb(0,0,0) });
      yPos -= 32;
    }
    page.drawText("Note: Original insurer claim form is appended.", { x: 50, y: 440, size: 10, font: helv, color: rgb(0.4,0.4,0.5) });

    // 3) 원본 PDF 병합
    const srcPath = document.getElementById("pdfFile").value;
    if (srcPath) {
      try {
        const url = new URL(encodeURI(srcPath), location.origin).toString();
        const resp = await fetch(url, { cache: "no-store" });
        if (!resp.ok) throw new Error(`원본 PDF 응답오류(${resp.status})`);
        const bytes = await resp.arrayBuffer();
        const src = await PDFDocument.load(bytes, { ignoreEncryption: true });
        const pages = await out.copyPages(src, src.getPageIndices());
        pages.forEach(p => out.addPage(p));
      } catch (e) {
        console.error("병합 실패:", e);
        alert("원본 PDF 병합을 건너뛰고 커버만 저장합니다.\n사유: " + (e?.message || e));
      }
    }

    // 4) 저장
    const pdfBytes = await out.save();
    const blob = new Blob([pdfBytes], {type:"application/pdf"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `${(document.getElementById("carrier").value||"insurer")}_claim_autofill.pdf`;
    a.click();
    URL.revokeObjectURL(a.href);

    $status.textContent = "완료";
  }catch(err){
    console.error(err);
    alert("PDF 생성 실패: " + (err?.message||err));
    $status.textContent = "실패";
  }finally{
    document.getElementById("btnMake").disabled = false;
  }
}
window.makePdf = makePdf;

/* ====== 이벤트 ====== */
document.addEventListener("DOMContentLoaded", ()=>{
  initSelectors();
  document.getElementById("carrier").addEventListener("change", updatePdfOptions);
  document.getElementById("pdfFile").addEventListener("change", ()=>{ document.getElementById("btnViewRaw").href = document.getElementById("pdfFile").value || "#"; });

  document.getElementById("btnSample").addEventListener("click", fillSample);
  document.getElementById("btnSaveEnc").addEventListener("click", ()=>{ saveEncrypted().catch(e=>alert(e.message)); });
  document.getElementById("btnLoadEnc").addEventListener("click", ()=>{ loadEncrypted().catch(e=>alert(e.message)); });

  // 자동 이동/백스페이스
  $phone1.addEventListener("input", ()=>autoAdvance($phone1,"phone2",3));
  $phone2.addEventListener("input", ()=>autoAdvance($phone2,"phone3",4));
  $phone3.addEventListener("input", ()=>onlyDigits($phone3));
  $phone2.addEventListener("keydown", (e)=>autoBackspace(e,"phone1"));
  $phone3.addEventListener("keydown", (e)=>autoBackspace(e,"phone2"));

  $rrn1.addEventListener("input", ()=>autoAdvance($rrn1,"rrn2",6));
  $rrn2.addEventListener("input", ()=>onlyDigits($rrn2));
  $rrn2.addEventListener("keydown", (e)=>autoBackspace(e,"rrn1"));

  // 주소 검색 레이어
  $zip.addEventListener("click", openPostcode);
  $addr.addEventListener("click", openPostcode);
  $addrDetail.addEventListener("focus", ()=>{ if(!$addr.value) openPostcode(); });
});
</script>
</body>
</html>
