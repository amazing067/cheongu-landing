<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>보험금 청구서 자동기입 PDF 생성</title>
<meta name="format-detection" content="telephone=no" />
<style>
  :root{--bg:#f6f8fb;--card:#fff;--ink:#111827;--muted:#6b7280;--brand:#3a64ff;--line:#e5e7eb;--radius:16px;--shadow:0 10px 30px rgba(17,24,39,.08)}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:900px;margin:24px auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px 20px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input,select{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;background:#fff;font-size:14px}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:12px 16px;border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer}
  .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
  .muted{color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <h2 style="margin:0 0 12px 0">보험금 청구서 자동기입 PDF 생성</h2>
  <p class="muted" style="margin:0 0 16px 0">내 정보가 들어간 1쪽 커버를 만들고, 선택한 보험사의 원본 청구서 PDF와 병합해 내려받습니다.</p>

  <div class="card" style="margin-bottom:16px">
    <h3 style="margin:0 0 12px 0">내 기본정보</h3>
    <div class="row">
      <div><label>이름</label><input id="name"></div>
      <div><label>전화번호(숫자만)</label><input id="phone" inputmode="numeric"></div>
    </div>
    <div class="row" style="margin-top:12px">
      <div><label>주민등록번호(숫자만)</label><input id="rrn" inputmode="numeric"></div>
      <div><label>계좌번호(은행명 포함)</label><input id="account"></div>
    </div>
    <div class="row" style="margin-top:12px">
      <div><label>직장명</label><input id="employer"></div>
      <div><label>하는 일(직무)</label><input id="job"></div>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="btnSample">샘플 채우기</button>
      <button class="btn" id="btnSave">내 정보 저장</button>
      <button class="btn" id="btnLoad">불러오기</button>
      <span class="muted">브라우저 로컬 저장소에만 저장됩니다.</span>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 12px 0">보험사 선택 및 PDF 생성</h3>
    <div class="row">
      <div>
        <label>보험사</label>
        <select id="carrier"></select>
      </div>
      <div>
        <label>청구서 PDF</label>
        <select id="pdfFile"></select>
      </div>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn primary" id="btnMake" type="button" onclick="makePdf()">PDF 만들기</button>
      <a class="btn" id="btnViewRaw" target="_blank" rel="noopener">원본 PDF 보기</a>
    </div>
    <p class="muted" style="margin-top:8px">※ 다음 단계에서 각 보험사 PDF 내부 칸에 직접 적어넣는 “스탬프/폼채움”을 추가합니다.</p>
  </div>
</div>

<!-- pdf-lib (CDN) -->
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script>
/** 1) 리포지토리의 assets/pdf 파일 매핑
 *   좌측은 사용자에게 보일 이름, 우측은 실제 경로입니다.
 *   파일명이 다르면 우측 경로만 맞게 고치세요.
 */
const PDF_MAP = {
  "삼성화재": [
    ["보험금청구서", "/assets/pdf/삼성화재-보험금청구서.pdf"]
  ],
  "현대해상": [
    ["보험금청구서", "/assets/pdf/현대해상-보험금청구서.pdf"]
  ],
  "DB손해": [
    ["보험금청구서", "/assets/pdf/DB손해보험-보험금청구서.pdf"],
    ["치과치료확인서", "/assets/pdf/DB손해보험 치과치료확인서.pdf"]
  ],
  "KB손해": [
    ["보험금청구서", "/assets/pdf/KB손해보험-보험금청구서.pdf"]
  ],
  "KB라이프생명": [
    ["보험금청구서", "/assets/pdf/KB라이프생명 보험금청구서.pdf"]
  ],
  "AIA생명": [
    ["보험금청구서", "/assets/pdf/AIA생명-보험금청구서.pdf"],
    ["치과치료확인서", "/assets/pdf/AIA생명 치과치료확인서.pdf"]
  ],
  "ABL생명": [
    ["보험금청구서", "/assets/pdf/ABL생명-보험금청구서.pdf"],
    ["치과치료확인서", "/assets/pdf/ABL생명 치과치료확인서.pdf"]
  ],
  "AXA손해보험": [
    ["보험금청구서", "/assets/pdf/AXA손해보험.pdf"],
    ["치과치료확인서", "/assets/pdf/AXA손해보험 치과치료확인서.pdf"]
  ],
  "AIG손해보험": [
    ["치과치료확인서", "/assets/pdf/AIG손해보험 치과치료확인서.pdf"]
  ],
  "기타": [
    ["공란 커버만 생성", ""]
  ]
};

/** 2) 로컬 저장 */
const LS_KEY = "claim-autofill.profile.v2";

/** 3) DOM */
const el = (id)=>document.getElementById(id);
const $name=el("name"),$rrn=el("rrn"),$phone=el("phone"),$account=el("account"),$employer=el("employer"),$job=el("job");
const $carrier=el("carrier"),$pdfFile=el("pdfFile");
const $btnViewRaw=el("btnViewRaw");

/** 4) 초기화 */
function initSelectors(){
  $carrier.innerHTML="";
  Object.keys(PDF_MAP).forEach(k=>{
    const o=document.createElement("option");o.value=k;o.textContent=k;$carrier.appendChild(o);
  });
  updatePdfOptions();
}
function updatePdfOptions(){
  const list = PDF_MAP[$carrier.value] || [];
  $pdfFile.innerHTML="";
  list.forEach(([label, path])=>{
    const o=document.createElement("option");o.value=path;o.textContent=label;$pdfFile.appendChild(o);
  });
  const first = list[0]?.[1] || "";
  $btnViewRaw.href = first || "#";
}

/** 5) 프로필 load/save */
function loadProfile(){
  try{
    const obj=JSON.parse(localStorage.getItem(LS_KEY)||"{}");
    ["name","rrn","phone","account","employer","job"].forEach(k=>{
      el(k).value=obj[k]||"";
    });
  }catch(e){}
}
function saveProfile(){
  const obj={
    name:$name.value.trim(),
    rrn:$rrn.value.replace(/\D/g,""),
    phone:$phone.value.replace(/\D/g,""),
    account:$account.value.trim(),
    employer:$employer.value.trim(),
    job:$job.value.trim()
  };
  localStorage.setItem(LS_KEY, JSON.stringify(obj));
  alert("저장 완료");
}
function fillSample(){
  $name.value="홍길동"; $rrn.value="9001011234567"; $phone.value="01012345678";
  $account.value="국민은행 123-456-789012"; $employer.value="청구닷컴 주식회사"; $job.value="보험상담사";
}

/** 6) PDF 생성 로직
 *  - 커버 1쪽을 만들고, 선택한 보험사 PDF를 뒤에 병합
 *  - 다음 단계에서 보험사별 좌표/폼 채움(스탬프)을 추가 예정
 */
async function makePdf(){
  // 내 정보
  const P={
    name:$name.value.trim(),
    rrn:$rrn.value.replace(/\D/g,""),
    phone:$phone.value.replace(/\D/g,""),
    account:$account.value.trim(),
    employer:$employer.value.trim(),
    job:$job.value.trim()
  };
  if(!P.name){ alert("이름을 입력하세요."); return; }

  // 1) 빈 문서 + 커버 페이지
  const { PDFDocument, StandardFonts, rgb } = PDFLib;
  const out = await PDFDocument.create();
  const page = out.addPage([595.28, 841.89]); // A4 pt
  const font = await out.embedFont(StandardFonts.Helvetica);
  const titleSize=18, labelSize=11, valueSize=13;

  // 타이틀
  page.drawText("보험금 청구서 자동기입 커버", { x: 50, y: 790, size: titleSize, font, color: rgb(0.1,0.1,0.2) });
  const today = new Date(); const y=today.getFullYear(), m=String(today.getMonth()+1).padStart(2,"0"), d=String(today.getDate()).padStart(2,"0");
  page.drawText(`생성일: ${y}-${m}-${d}`, { x: 50, y: 770, size: labelSize, font, color: rgb(0.4,0.4,0.5) });

  // 박스
  const boxY = 720, boxH = 220;
  page.drawRectangle({ x:40, y: boxY-boxH, width: 515, height: boxH, borderColor: rgb(0.85,0.87,0.92), borderWidth: 1, color: rgb(1,1,1) });

  const rows = [
    ["피보험자 성명", P.name],
    ["주민등록번호", P.rrn],
    ["연락처", P.phone],
    ["보험금 수령계좌", P.account],
    ["직장명", P.employer],
    ["직무", P.job],
  ];
  let yPos = boxY - 24;
  rows.forEach(([label, value])=>{
    page.drawText(label, { x: 55, y: yPos, size: labelSize, font, color: rgb(0.35,0.35,0.45) });
    page.drawText(String(value||""), { x: 200, y: yPos, size: valueSize, font, color: rgb(0,0,0) });
    yPos -= 32;
  });

  // 안내
  page.drawText("※ 이 커버는 제출 편의를 위한 요약입니다. 다음 장부터는 선택한 보험사의 원본 청구서가 그대로 이어집니다.", { x: 50, y: 480, size: 10, font, color: rgb(0.4,0.4,0.5) });

  // 2) 원본 청구서 병합 (선택)
  const srcPath = $pdfFile.value;
  if(srcPath){
    try{
      const bytes = await fetch(srcPath, {cache:"no-store"}).then(r=>r.arrayBuffer());
      const src = await PDFDocument.load(bytes);
      const pages = await out.copyPages(src, src.getPageIndices());
      pages.forEach(p=>out.addPage(p));
    }catch(e){
      alert("원본 PDF 병합 실패: " + e.message + "\\n경로 또는 파일명을 확인하세요.");
    }
  }

  // 3) 저장
  const pdfBytes = await out.save();
  const blob = new Blob([pdfBytes], {type:"application/pdf"});
  const a = document.createElement("a");
  const carrier = $carrier.value || "보험사";
  a.href = URL.createObjectURL(blob);
  a.download = `${carrier}_청구서_자동기입.pdf`;
  a.click();
  URL.revokeObjectURL(a.href);
}

/** 이벤트 바인딩 */
document.addEventListener("DOMContentLoaded", ()=>{
  initSelectors(); loadProfile();
  $carrier.addEventListener("change", updatePdfOptions);
  $pdfFile.addEventListener("change", ()=>{ $btnViewRaw.href = $pdfFile.value || "#"; });
  el("btnMake").addEventListener("click", makePdf);
  el("btnSave").addEventListener("click", saveProfile);
  el("btnLoad").addEventListener("click", loadProfile);
  el("btnSample").addEventListener("click", fillSample);
  $btnViewRaw.addEventListener("click", (e)=>{ if(!$pdfFile.value) e.preventDefault(); });
});
</script>
</body>
</html>
