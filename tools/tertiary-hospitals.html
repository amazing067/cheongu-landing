<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>상급종합병원 목록 · 검색/필터 · 지도</title>
  <meta name="robots" content="noindex,nofollow" />
  <!-- Leaflet (no API key) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous">
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>
  <style>
    :root{
      --bg:#f7f9ff; --card:#ffffff; --ink:#182340; --muted:#5b6b8c; --line:#e6ecf7;
      --brand:#3a64ff; --brand-soft:#e8eeff; --accent:#00c2a8; --radius:16px; --shadow:0 10px 30px rgba(15,25,55,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(900px 500px at 10% -10%, #eef3ff 0, transparent 50%),linear-gradient(#f9fbff, #f3f7ff); color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Pretendard,Helvetica,Arial,sans-serif}
    .wrap{max-width:1100px;margin:0 auto;padding:20px 16px 28px}
    header{position:sticky;top:0;background:linear-gradient(#fff,rgba(255,255,255,.92));backdrop-filter:saturate(140%) blur(6px);z-index:10;border-bottom:1px solid var(--line)}
    header .h-inner{max-width:1100px;margin:0 auto;padding:14px 16px;display:flex;gap:10px;align-items:center;justify-content:space-between}
    h1{margin:0;font-size:18px;font-weight:800;letter-spacing:-.2px}
    .badge{font-size:12px;color:#2a4;background:#e7fbf2;border:1px solid #b9f1da;border-radius:999px;padding:5px 10px;margin-left:8px}
    .btn{appearance:none;border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer;box-shadow:0 1px 0 rgba(10,20,50,.04)}
    .btn:hover{border-color:#cfd8ee;background:#fafcff}
    .btn.brand{border-color:transparent;background:var(--brand);color:#fff}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
    .tools{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .search{display:flex;gap:8px;align-items:center}
    .search input,.search select{width:100%;padding:12px 14px;border:1px solid var(--line);border-radius:12px;background:#fff;font-size:14px}
    .help{font-size:12px;color:var(--muted);margin-top:8px}
    .table-wrap{overflow:auto;border-top:1px solid var(--line)}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);text-align:left;font-size:12px;color:var(--muted);padding:12px}
    tbody td{border-bottom:1px solid #eef2fb;padding:12px;vertical-align:top;font-size:14px}
    tbody tr:hover{background:#fbfdff}
    .name{font-weight:800}
    .addr{color:var(--muted);font-size:12px;margin-top:2px}
    .row-actions{display:flex;gap:6px;flex-wrap:wrap}
    .pill{font-size:12px;border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:6px}
    .pill:hover{background:#f7faff;border-color:#d7e1f7}
    .count{font-weight:700}
    footer{margin-top:14px;text-align:center;color:var(--muted);font-size:12px}
    .map{height:440px;border-top:1px dashed var(--line);border-bottom:1px dashed var(--line)}
    #map{height:100%;border-radius:0 0 var(--radius) var(--radius)}
    .map-tip{padding:10px;color:var(--muted);font-size:12px;border-bottom:1px dashed var(--line)}
    @media (max-width:900px){ .tools{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header>
    <div class="h-inner">
      <div style="display:flex;align-items:center">
        <h1>전국 상급종합병원<span class="badge">지도로 보기</span></h1>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn" id="btnRefresh" title="데이터 새로고침">새로고침</button>
        <button class="btn brand" id="btnClose" title="팝업 닫기">닫기</button>
      </div>
    </div>
  </header>

  <div class="wrap">
    <section class="card" style="padding:16px">
      <div class="tools">
        <div class="search">
          <input id="q" type="search" placeholder="병원명·지역·주소 검색 (예: 아산, 강남, 부산)" autocomplete="off" />
        </div>
        <div class="search">
          <select id="region">
            <option value="">지역 전체</option>
          </select>
        </div>
      </div>
      <div class="help">Tip: 검색/필터에 맞춰 지도도 자동으로 맞춰집니다. <span class="count" id="count">0</span>곳 표시 중</div>
    </section>

    <section class="card" style="margin-top:14px">
      <div class="map-tip" id="mapTip">대한민국 지도를 불러왔어요. 병원을 클릭하면 전화/길찾기/홈페이지 버튼이 뜹니다.</div>
      <div class="map"><div id="map" aria-label="대한민국 지도"></div></div>
      <div class="table-wrap">
        <table id="tbl">
          <thead>
            <tr>
              <th style="width:38%">병원명</th>
              <th style="width:42%">주소</th>
              <th style="width:20%">바로가기</th>
            </tr>
          </thead>
          <tbody id="tbody"><!-- rows --></tbody>
        </table>
      </div>
    </section>

    <footer>데이터 위치: <code>/data/tertiary-hospitals.json</code> (lat/lng 없으면 지도 표시는 생략되고 목록만 표시)</footer>
  </div>

  <script>
    // ===== 데이터 소스 =====
    const DATA_URL = '/data/tertiary-hospitals.json';

    // 내장 예시(최소 구동용). 실제 운영은 /data/tertiary-hospitals.json 사용.
    const FALLBACK = [
      { name:"서울아산병원", tel:"1688-7575", city:"서울", region:"서울특별시", address:"서울 송파구 올림픽로 43길 88", homepage:"https://www.amc.seoul.kr", lat:37.526, lng:127.107 },
      { name:"삼성서울병원", tel:"1599-3114", city:"서울", region:"서울특별시", address:"서울 강남구 일원로 81", homepage:"https://www.samsunghospital.com", lat:37.488, lng:127.087 },
      { name:"세브란스병원(신촌)", tel:"1599-1004", city:"서울", region:"서울특별시", address:"서울 서대문구 연세로 50", homepage:"https://sev.iseverance.com", lat:37.563, lng:126.936 },
      { name:"서울대학교병원", tel:"1588-5700", city:"서울", region:"서울특별시", address:"서울 종로구 대학로 101", homepage:"https://www.snuh.org", lat:37.579, lng:126.999 },
      { name:"부산대학교병원", tel:"051-240-7000", city:"부산", region:"부산광역시", address:"부산 서구 구덕로 179", homepage:"https://www.pnuh.or.kr", lat:35.105, lng:129.016 }
    ];

    let RAW = [];
    let FILTERED = [];

    const $ = (s, el=document)=>el.querySelector(s);

    const els = {
      q: $('#q'),
      region: $('#region'),
      tbody: $('#tbody'),
      count: $('#count'),
      mapTip: $('#mapTip'),
      btnClose: $('#btnClose'),
      btnRefresh: $('#btnRefresh')
    };

    // ===== 지도 =====
    const MAP_DEFAULT = { center:[36.5,127.9], zoom:7 };
    let map, markersLayer;
    function initMap(){
      if(map) return;
      map = L.map('map', { zoomControl:true }).setView(MAP_DEFAULT.center, MAP_DEFAULT.zoom);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);
      markersLayer = L.layerGroup().addTo(map);
    }

    // ===== 유틸 =====
    const telHref = v => v ? `tel:${v.replaceAll(/[^0-9]/g,'')}` : '';
    const nmap = (name, addr) => `https://map.naver.com/p/search/${encodeURIComponent(name + ' ' + (addr||''))}`;
    const kmap = (name, addr) => `https://map.kakao.com/?q=${encodeURIComponent(name + ' ' + (addr||''))}`;
    const norm = s => (s||'').toLowerCase().replace(/\s+/g,'').normalize('NFKD');

    // ===== 테이블 렌더 =====
    function renderRows(list){
      els.tbody.innerHTML = '';
      list.forEach(h=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>
            <div class="name">${h.name||''}</div>
            <div class="addr">${h.city||''} · ${h.region||''} · ☎ ${h.tel||'-'}</div>
          </td>
          <td><div>${h.address||''}</div></td>
          <td>
            <div class="row-actions">
              ${h.tel ? `<a class="pill" href="${telHref(h.tel)}" title="전화하기">전화</a>`:''}
              <a class="pill" href="${nmap(h.name,h.address)}" target="_blank" rel="noopener" title="네이버 지도">네이버지도</a>
              <a class="pill" href="${kmap(h.name,h.address)}" target="_blank" rel="noopener" title="카카오 지도">카카오지도</a>
              ${h.homepage ? `<a class="pill" href="${h.homepage}" target="_blank" rel="noopener" title="홈페이지">홈페이지</a>`:''}
              <button class="pill" data-copy="${h.address||''}" title="주소 복사">주소복사</button>
            </div>
          </td>`;
        tr.addEventListener('click', (e)=>{
          if(e.target.closest('a,button')) return;
          if(h.lat && h.lng && map){ map.setView([h.lat, h.lng], 15); }
        });
        els.tbody.appendChild(tr);
      });
      // 단발성 위임: 주소복사
      els.tbody.addEventListener('click', async (e)=>{
        const btn = e.target.closest('button[data-copy]');
        if(!btn) return;
        try{ await navigator.clipboard.writeText(btn.getAttribute('data-copy')); btn.textContent='복사됨'; setTimeout(()=>btn.textContent='주소복사',1200);}catch(err){ alert('클립보드 권한을 확인해주세요.'); }
      }, { once:true });
      (document.getElementById('count')||{}).textContent = list.length;
    }

    // ===== 마커 렌더 =====
    function renderMarkers(list){
      if(!map) return;
      markersLayer.clearLayers();
      const pts = [];
      list.forEach(h=>{
        if(!(h.lat && h.lng)) return;
        const m = L.marker([h.lat, h.lng]).addTo(markersLayer);
        m.bindPopup(`
          <div style="min-width:220px">
            <div style="font-weight:800;margin-bottom:6px">${h.name||''}</div>
            <div style="font-size:12px;color:#5b6b8c;margin-bottom:8px">${h.address||''}</div>
            <div style="display:flex;gap:6px;flex-wrap:wrap">
              ${h.tel?`<a class="pill" href="${telHref(h.tel)}">전화</a>`:''}
              <a class="pill" href="${nmap(h.name,h.address)}" target="_blank" rel="noopener">네이버지도</a>
              <a class="pill" href="${kmap(h.name,h.address)}" target="_blank" rel="noopener">카카오지도</a>
              ${h.homepage?`<a class="pill" href="${h.homepage}" target="_blank" rel="noopener">홈페이지</a>`:''}
            </div>
          </div>`);
        pts.push([h.lat, h.lng]);
      });
      if(pts.length){
        const b = L.latLngBounds(pts);
        map.fitBounds(b.pad(0.12));
        els.mapTip.textContent = `지도로 ${pts.length}곳을 표시했습니다.`;
      }else{
        map.setView(MAP_DEFAULT.center, MAP_DEFAULT.zoom);
        els.mapTip.textContent = '좌표가 없는 병원은 목록에만 표시됩니다.';
      }
    }

    function buildRegions(list){
      const regions = Array.from(new Set(list.map(x=>x.region).filter(Boolean))).sort((a,b)=>a.localeCompare(b,'ko'));
      document.getElementById('region').innerHTML =
        ['<option value="">지역 전체</option>'].concat(regions.map(r=>`<option value="${r}">${r}</option>`)).join('');
    }

    function applyFilter(){
      const q = norm(els.q.value);
      const r = els.region.value;
      FILTERED = RAW.filter(h=>{
        const byRegion = r ? (h.region===r) : true;
        const blob = norm([h.name,h.city,h.region,h.address].join(' '));
        const byQuery = q ? blob.includes(q) : true;
        return byRegion && byQuery;
      });
      renderRows(FILTERED);
      renderMarkers(FILTERED);
    }

    // ===== 초기화 =====
    async function load(){
      try{
        const res = await fetch(DATA_URL, { cache:'no-store' });
        if(!res.ok) throw new Error('no json');
        const json = await res.json();
        RAW = Array.isArray(json) ? json : (json.items || []);
      }catch(e){
        RAW = FALLBACK;
      }
      // 정규화
      RAW = RAW.map(x=>({
        name: x.name || x.병원명 || '',
        tel: x.tel || x.전화 || x.phone || '',
        city: x.city || x.도시 || '',
        region: x.region || x.시도 || x.광역 || '',
        address: x.address || x.주소 || '',
        homepage: x.homepage || x.url || x.link || '',
        lat: Number(x.lat ?? x.latitude ?? x.위도 ?? ''),
        lng: Number(x.lng ?? x.longitude ?? x.경도 ?? '')
      }));
      initMap();
      buildRegions(RAW);
      applyFilter();
    }

    // ===== 이벤트 =====
    els.q.addEventListener('input', applyFilter);
    els.region.addEventListener('change', applyFilter);
    els.btnClose.addEventListener('click', ()=>window.close());
    els.btnRefresh.addEventListener('click', load);
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') window.close(); });

    // 시작
    load();
  </script>
</body>
</html>
