<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>상급종합병원 목록 · 권역칩 · 지도 · 검색/필터</title>
  <meta name="robots" content="noindex,nofollow" />
  <!-- Leaflet (no API key) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous">
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>
  <style>
    :root{ --bg:#f7f9ff; --card:#ffffff; --ink:#182340; --muted:#5b6b8c; --line:#e6ecf7; --brand:#3a64ff; --brand-soft:#e8eeff; --accent:#00c2a8; --radius:16px; --shadow:0 10px 30px rgba(15,25,55,.08); }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(900px 500px at 10% -10%, #eef3ff 0, transparent 50%),linear-gradient(#f9fbff,#f3f7ff); color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Pretendard,Helvetica,Arial,sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:20px 16px 28px}
    header{position:sticky;top:0;background:linear-gradient(#fff,rgba(255,255,255,.92));backdrop-filter:saturate(140%) blur(6px);z-index:10;border-bottom:1px solid var(--line)}
    header .h-inner{max-width:980px;margin:0 auto;padding:14px 16px;display:flex;gap:10px;align-items:center;justify-content:space-between}
    h1{margin:0;font-size:18px;font-weight:800;letter-spacing:-.2px}
    .badge{font-size:12px;color:#2a4;background:#e7fbf2;border:1px solid #b9f1da;border-radius:999px;padding:5px 10px;margin-left:8px}
    .btn{appearance:none;border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer;box-shadow:0 1px 0 rgba(10,20,50,.04)}
    .btn:hover{border-color:#cfd8ee;background:#fafcff}
    .btn.brand{border-color:transparent;background:#3a64ff;color:#fff}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
    .tools{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .tools> *{min-width:0}
    .search{display:flex;gap:8px;align-items:center}
    .search input,.search select{width:100%;padding:12px 14px;border:1px solid var(--line);border-radius:12px;background:#fff;font-size:14px}
    .help{font-size:12px;color:var(--muted);margin-top:8px}
    .table-wrap{overflow:auto;border-top:1px solid var(--line)}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);text-align:left;font-size:12px;color:#5b6b8c;padding:12px}
    tbody td{border-bottom:1px solid #eef2fb;padding:12px;vertical-align:top;font-size:14px}
    tbody tr:hover{background:#fbfdff}
    .name{font-weight:800}
    .addr{color:#5b6b8c;font-size:12px;margin-top:2px}
    .row-actions{display:flex;gap:6px;flex-wrap:wrap}
    .pill{font-size:12px;border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:6px}
    .pill:hover{background:#f7faff;border-color:#d7e1f7}
    .count{font-weight:700}
    footer{margin-top:14px;text-align:center;color:#5b6b8c;font-size:12px}
    .map{height:420px;border-top:1px dashed var(--line);border-bottom:1px dashed var(--line)}
    #map{height:100%;border-radius:0 0 var(--radius) var(--radius)}
    .map-tip{padding:10px;color:#5b6b8c;font-size:12px;border-bottom:1px dashed var(--line)}
    @media (max-width:800px){ .tools{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header>
    <div class="h-inner">
      <div style="display:flex;align-items:center">
        <h1>전국 상급종합병원<span class="badge">권역칩 · 지도 · 검색/필터</span></h1>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn" id="btnRefresh" title="데이터 새로고침">새로고침</button>
        <button class="btn brand" id="btnClose" title="팝업 닫기">닫기</button>
      </div>
    </div>
  </header>

  <div class="wrap">
    <section class="card" style="padding:16px">
      <div class="tools">
        <div class="search">
          <input id="q" type="search" placeholder="병원명·지역·주소 검색 (예: 아산, 강남, 부산)" autocomplete="off" />
        </div>
        <div class="search">
          <select id="region">
            <option value="">지역 전체</option>
          </select>
        </div>
      </div>
      <div class="help">Tip: 아래 <b>진료권 칩</b>을 누르면 해당 권역만 필터링돼요. <span class="count" id="count">0</span>곳 표시 중</div>
      <div id="chips" style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap"></div>
    </section>

    <section class="card" style="margin-top:14px">
      <div class="map-tip" id="mapTip">대한민국 지도를 불러왔어요. 좌표가 없는 병원은 목록에만 표시됩니다.</div>
      <div class="map"><div id="map" aria-label="대한민국 지도"></div></div>
      <div class="table-wrap">
        <table id="tbl">
          <thead>
            <tr>
              <th style="width:38%">병원명</th>
              <th style="width:42%">주소</th>
              <th style="width:20%">바로가기</th>
            </tr>
          </thead>
          <tbody id="tbody"><!-- rows --></tbody>
        </table>
      </div>
    </section>

    <footer>데이터: <code>/data/tertiary-hospitals.json</code> (없으면 내장 47곳 사용)</footer>
  </div>

  <script>
    // ====== 데이터 소스 ======
    const DATA_URL = '/data/tertiary-hospitals.json';

    // ====== 5기 상급종합병원 47곳 (권역 포함, 연락처/주소는 비워둠) ======
    const FALLBACK_47 = [
      { name:"강북삼성병원", careArea:"서울권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },
      { name:"건국대학교병원", careArea:"서울권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },
      { name:"경희대학교병원", careArea:"서울권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },
      { name:"고려대학교의과대학부속구로병원", careArea:"서울권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },
      { name:"삼성서울병원", careArea:"서울권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },
      { name:"서울대학교병원", careArea:"서울권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },
      { name:"연세대학교의과대학강남세브란스병원", careArea:"서울권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },
      { name:"연세대학교의과대학세브란스병원", careArea:"서울권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },
      { name:"이화여자대학교의과대학부속목동병원", careArea:"서울권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },
      { name:"재단법인아산사회복지재단서울아산병원", careArea:"서울권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },
      { name:"중앙대학교병원", careArea:"서울권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },
      { name:"학교법인고려중앙학원고려대학교의과대학부속병원", careArea:"서울권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },
      { name:"학교법인가톨릭학원가톨릭대학교서울성모병원", careArea:"서울권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },
      { name:"한양대학교병원", careArea:"서울권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },

      { name:"가톨릭대학교인천성모병원", careArea:"서북부권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },
      { name:"순천향대학교부속부천병원", careArea:"서북부권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },
      { name:"의료법인길의료재단길병원", careArea:"서북부권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },
      { name:"인하대학교의과대학부속병원", careArea:"서북부권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },

      { name:"가톨릭대학교성빈센트병원", careArea:"남부권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },
      { name:"고려대학교의과대학부속안산병원", careArea:"남부권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },
      { name:"분당서울대학교병원", careArea:"남부권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },
      { name:"아주대학교병원", careArea:"남부권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },
      { name:"한림대학교성심병원", careArea:"남부권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },

      { name:"강릉아산병원", careArea:"강원권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },
      { name:"연세대학교원주세브란스기독병원", careArea:"강원권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },

      { name:"충북대학교병원", careArea:"충북권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },

      { name:"단국대학교의과대학부속병원", careArea:"충남권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },
      { name:"충남대학교병원", careArea:"충남권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },
      { name:"학교법인건양교육재단건양대학교병원", careArea:"충남권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },

      { name:"원광대학교병원", careArea:"전북권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },
      { name:"전북대학교병원", careArea:"전북권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },

      { name:"전남대학교병원", careArea:"전남권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },
      { name:"조선대학교병원", careArea:"전남권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },
      { name:"화순전남대학교병원", careArea:"전남권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },

      { name:"경북대학교병원", careArea:"경북권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },
      { name:"계명대학교동산병원", careArea:"경북권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },
      { name:"대구가톨릭대학교병원", careArea:"경북권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },
      { name:"영남대학교병원", careArea:"경북권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },
      { name:"칠곡경북대학교병원", careArea:"경북권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },

      { name:"고신대학교복음병원", careArea:"경남동부권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },
      { name:"동아대학교병원", careArea:"경남동부권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },
      { name:"부산대학교병원", careArea:"경남동부권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },
      { name:"양산부산대학교병원", careArea:"경남동부권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },
      { name:"인제대학교부산백병원", careArea:"경남동부권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },
      { name:"학교법인동의학원동의의료원부속부산한방병원", careArea:"경남동부권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },

      { name:"경상국립대학교병원", careArea:"경남서부권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null },
      { name:"학교법인웅산교육재단삼성창원병원", careArea:"경남서부권", tel:"", city:"", region:"", address:"", homepage:"", lat:null, lng:null }
    ];

    let RAW = [];      // 외부 JSON 있으면 사용, 없으면 47개 템플릿 사용
    let FILTERED = [];
    let selectedArea = '';

    const $ = (s, el=document)=>el.querySelector(s);
    const els = {
      q: $('#q'), region: $('#region'), chips: $('#chips'), tbody: $('#tbody'), count: $('#count'),
      mapTip: $('#mapTip'), btnClose: $('#btnClose'), btnRefresh: $('#btnRefresh')
    };

    // ===== 지도 =====
    const MAP_DEFAULT = { center:[36.5,127.9], zoom:7 };
    let map, markersLayer;
    function initMap(){
      if(map) return;
      map = L.map('map', { zoomControl:true }).setView(MAP_DEFAULT.center, MAP_DEFAULT.zoom);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);
      markersLayer = L.layerGroup().addTo(map);
    }

    // ===== 유틸 =====
    function telHref(v){ return v ? `tel:${String(v).replaceAll(/[^0-9]/g,'')}` : ''; }
    const nmap = (name, addr) => `https://map.naver.com/p/search/${encodeURIComponent(name + ' ' + (addr||''))}`;
    const kmap = (name, addr) => `https://map.kakao.com/?q=${encodeURIComponent(name + ' ' + (addr||''))}`;
    const norm = s => (s||'').toLowerCase().replace(/\s+/g,'').normalize('NFKD');
    const areaLabel = a => ({ '서북부권':'경기서부권', '남부권':'경기남부권' }[a] || a);

    // ===== 권역 칩 =====
    function renderChips(list){
      const counts = list.reduce((m,x)=>{ const a=x.careArea||'미분류'; m[a]=(m[a]||0)+1; return m; },{});
      const areas = Object.keys(counts).sort((a,b)=>areaLabel(a).localeCompare(areaLabel(b),'ko'));
      const html = ['<button class="pill" data-area="">전체 '+list.length+'</button>']
        .concat(areas.map(a=>`<button class="pill" data-area="${a}">${areaLabel(a)} ${counts[a]}</button>`)).join('');
      els.chips.innerHTML = html;
      els.chips.querySelectorAll('button.pill').forEach(btn=>{
        btn.addEventListener('click', ()=>{ selectedArea = btn.getAttribute('data-area'); applyFilter(); });
      });
    }

    // ===== 표 =====
    function renderRows(list){
      els.tbody.innerHTML = '';
      list.forEach(h=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>
            <div class="name">${h.name||''}</div>
            <div class="addr">${(h.careArea?areaLabel(h.careArea)+' · ':'')}${h.city||''} ${h.region?('· '+h.region):''} ${h.tel?('· ☎ '+h.tel):''}</div>
          </td>
          <td><div>${h.address||''}</div></td>
          <td>
            <div class="row-actions">
              ${h.tel ? `<a class="pill" href="${telHref(h.tel)}" title="전화하기">전화</a>`:''}
              <a class="pill" href="${nmap(h.name,h.address)}" target="_blank" rel="noopener">네이버지도</a>
              <a class="pill" href="${kmap(h.name,h.address)}" target="_blank" rel="noopener">카카오지도</a>
              ${h.homepage ? `<a class="pill" href="${h.homepage}" target="_blank" rel="noopener">홈페이지</a>`:''}
              ${h.address?`<button class="pill" data-copy="${h.address}">주소복사</button>`:''}
            </div>
          </td>`;
        els.tbody.appendChild(tr);
      });
      els.count.textContent = list.length;
      els.tbody.addEventListener('click', async (e)=>{
        const btn = e.target.closest('button[data-copy]');
        if(!btn) return;
        try{ await navigator.clipboard.writeText(btn.getAttribute('data-copy')); btn.textContent='복사됨'; setTimeout(()=>btn.textContent='주소복사',1200);}catch(err){ alert('클립보드 권한을 확인해주세요.'); }
      }, { once:true });
    }

    // ===== 지도 마커 =====
    function renderMarkers(list){
      if(!map) return;
      markersLayer.clearLayers();
      const pts = [];
      list.forEach(h=>{
        if(!(h.lat && h.lng)) return; // 좌표 없는 항목은 마커 생략
        const m = L.marker([h.lat, h.lng]).addTo(markersLayer);
        m.bindPopup(`
          <div style="min-width:220px">
            <div style="font-weight:800;margin-bottom:6px">${h.name||''}</div>
            <div style="font-size:12px;color:#5b6b8c;margin-bottom:8px">${h.address||''}</div>
            <div style="display:flex;gap:6px;flex-wrap:wrap">
              ${h.tel?`<a class="pill" href="${telHref(h.tel)}">전화</a>`:''}
              <a class="pill" href="${nmap(h.name,h.address)}" target="_blank" rel="noopener">네이버지도</a>
              <a class="pill" href="${kmap(h.name,h.address)}" target="_blank" rel="noopener">카카오지도</a>
              ${h.homepage?`<a class="pill" href="${h.homepage}" target="_blank" rel="noopener">홈페이지</a>`:''}
            </div>
          </div>`);
        pts.push([h.lat, h.lng]);
      });
      if(pts.length){
        const b = L.latLngBounds(pts);
        map.fitBounds(b.pad(0.12));
        document.getElementById('mapTip').textContent = `지도로 ${pts.length}곳을 표시했습니다.`;
      }else{
        map.setView([36.5,127.9], 7);
        document.getElementById('mapTip').textContent = '좌표가 없어 지도에는 표시되지 않습니다. 주소/좌표 입력 시 자동 반영됩니다.';
      }
    }

    function buildRegions(list){
      const regions = Array.from(new Set(list.map(x=>x.region).filter(Boolean))).sort((a,b)=>a.localeCompare(b,'ko'));
      document.getElementById('region').innerHTML = `<option value="">지역 전체</option>` + regions.map(r=>`<option value="${r}">${r}</option>`).join('');
    }

    function applyFilter(){
      const q = (document.getElementById('q').value||'').toLowerCase().replace(/\s+/g,'').normalize('NFKD');
      const r = document.getElementById('region').value;
      FILTERED = RAW.filter(h=>{
        const byRegion = r ? (h.region===r) : true;
        const byArea = selectedArea ? ((h.careArea||'')===selectedArea) : true;
        const blob = [h.name,h.city,h.region,h.address,h.careArea].join(' ').toLowerCase().replace(/\s+/g,'').normalize('NFKD');
        const byQuery = q ? blob.includes(q) : true;
        return byRegion && byArea && byQuery;
      });
      renderRows(FILTERED);
      renderMarkers(FILTERED);
    }

    // ===== 초기화 =====
    async function load(){
      try{
        const res = await fetch(DATA_URL, { cache:'no-store' });
        if(!res.ok) throw new Error('no json');
        const json = await res.json();
        RAW = Array.isArray(json) ? json : (json.items || []);
      }catch(e){
        RAW = FALLBACK_47; // 외부 JSON 없으면 47개 템플릿 사용
      }
      RAW = RAW.map(x=>({
        name: x.name || x.병원명 || '',
        tel: x.tel || x.전화 || x.phone || '',
        city: x.city || x.도시 || '',
        region: x.region || x.시도 || x.광역 || '',
        address: x.address || x.주소 || '',
        homepage: x.homepage || x.url || x.link || '',
        careArea: x.careArea || '',
        lat: (x.lat ?? null),
        lng: (x.lng ?? null)
      }));
      if(!map) initMap();
      buildRegions(RAW);
      renderChips(RAW);
      applyFilter();
    }

    // ===== 이벤트 =====
    document.getElementById('q').addEventListener('input', applyFilter);
    document.getElementById('region').addEventListener('change', applyFilter);
    document.getElementById('btnClose').addEventListener('click', ()=>window.close());
    document.getElementById('btnRefresh').addEventListener('click', load);
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') window.close(); });

    // 시작
    load();
  </script>
</body>
</html>
