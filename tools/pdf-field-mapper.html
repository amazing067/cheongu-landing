<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF í•„ë“œ ë§¤í•‘ ë„êµ¬ (AcroFormìš©) - ì²­êµ¬ë‹·ì»´</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Pretendard', -apple-system, sans-serif; background: #f6f8fb; padding: 20px; }
        .container { max-width: 1600px; margin: 0 auto; }
        
        .header { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        h1 { font-size: 24px; color: #111827; margin-bottom: 8px; }
        .subtitle { color: #6b7280; font-size: 14px; }
        
        .tools { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
        .tools input[type="file"] { display: none; }
        .tools label, .tools button, .tools select, .tools input[type="text"] { padding: 10px 16px; border-radius: 8px; border: 1px solid #e5e7eb; background: white; font-weight: 600; font-size: 14px; transition: all 0.2s; }
        .tools label { cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .tools button { cursor: pointer; }
        .tools label:hover, .tools button:hover { background: #f9fafb; border-color: #3a64ff; }
        .tools button.primary { background: #3a64ff; color: white; border-color: #3a64ff; }
        .tools button.primary:hover { background: #2d50cc; }
        .tools input[type="text"] { font-weight: 400; }
        
        .workspace { display: grid; grid-template-columns: 1fr 400px; gap: 20px; }
        
        .canvas-wrapper { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: relative; overflow: auto; max-height: calc(100vh - 300px); }
        .canvas-container { position: relative; display: inline-block; }
        #pdf-canvas { border: 2px solid #e5e7eb; cursor: crosshair; display: block; }
        
        .crosshair { position: absolute; pointer-events: none; z-index: 10; }
        .crosshair-h { width: 100%; height: 1px; background: #3a64ff; opacity: 0.6; }
        .crosshair-v { height: 100%; width: 1px; background: #3a64ff; opacity: 0.6; }
        
        .marker { position: absolute; transform: translate(-50%, -50%); pointer-events: none; z-index: 20; }
        .marker-dot { width: 12px; height: 12px; background: #ef4444; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        .marker-label { position: absolute; top: -25px; left: 10px; background: rgba(0,0,0,0.85); color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; white-space: nowrap; }
        
        .coord-display { position: sticky; top: 10px; right: 10px; float: right; background: rgba(0,0,0,0.85); color: white; padding: 10px 14px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 13px; z-index: 30; margin-bottom: 10px; }
        
        .panel { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-height: calc(100vh - 300px); overflow-y: auto; }
        .panel h2 { font-size: 18px; margin-bottom: 16px; color: #111827; padding-bottom: 12px; border-bottom: 2px solid #e5e7eb; }
        
        .quick-fields { margin-bottom: 20px; padding: 16px; background: #f0f9ff; border-radius: 8px; border: 1px solid #bae6fd; }
        .quick-fields h3 { font-size: 14px; margin-bottom: 10px; color: #0c4a6e; }
        .quick-btn-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; }
        .quick-btn { padding: 8px 10px; border-radius: 6px; border: 1px solid #0ea5e9; background: white; color: #0369a1; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.15s; }
        .quick-btn:hover { background: #0ea5e9; color: white; }
        
        .field-list { display: flex; flex-direction: column; gap: 8px; margin-top: 16px; }
        .field-item { display: grid; grid-template-columns: auto 1fr auto auto; gap: 8px; padding: 10px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb; align-items: center; }
        .field-item.waiting { background: #fef3c7; border-color: #fbbf24; }
        .field-item.complete { background: #d1fae5; border-color: #10b981; }
        .field-item .index { width: 24px; height: 24px; background: #6b7280; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; }
        .field-item.waiting .index { background: #f59e0b; }
        .field-item.complete .index { background: #10b981; }
        .field-item .info { display: flex; flex-direction: column; gap: 2px; }
        .field-item .name { font-weight: 700; color: #111827; font-size: 13px; }
        .field-item .coords { color: #6b7280; font-family: 'Courier New', monospace; font-size: 11px; }
        .field-item button { padding: 6px 10px; border-radius: 6px; border: 1px solid #e5e7eb; background: white; cursor: pointer; font-size: 11px; font-weight: 600; transition: all 0.15s; }
        .field-item button.edit { color: #3b82f6; border-color: #3b82f6; }
        .field-item button.edit:hover { background: #3b82f6; color: white; }
        .field-item button.delete { color: #ef4444; border-color: #ef4444; }
        .field-item button.delete:hover { background: #ef4444; color: white; }
        
        .export-section { margin-top: 20px; padding-top: 20px; border-top: 2px solid #e5e7eb; }
        .export-section h3 { font-size: 16px; margin-bottom: 12px; color: #111827; }
        .export-section textarea { width: 100%; height: 250px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 11px; resize: vertical; background: #f9fafb; }
        .export-section .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        .export-section button { width: 100%; padding: 12px; background: #3a64ff; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 14px; }
        .export-section button:hover { background: #2d50cc; }
        .export-section button.secondary { background: #10b981; }
        .export-section button.secondary:hover { background: #059669; }
        
        .instructions { background: #fffbeb; border: 1px solid #fde68a; padding: 16px; border-radius: 8px; margin-bottom: 20px; }
        .instructions h3 { font-size: 16px; color: #92400e; margin-bottom: 10px; }
        .instructions ol { margin-left: 20px; color: #78350f; line-height: 1.8; }
        .instructions ol li { margin: 4px 0; font-size: 14px; }
        .instructions strong { color: #92400e; }
        
        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 16px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); text-align: center; }
        .stat-card .value { font-size: 28px; font-weight: 800; color: #3a64ff; }
        .stat-card .label { font-size: 12px; color: #6b7280; margin-top: 4px; }
        
        @media (max-width: 1400px) {
            .workspace { grid-template-columns: 1fr; }
            .panel { max-height: 500px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“‹ PDF í•„ë“œ ë§¤í•‘ ë„êµ¬ (AcroFormìš©)</h1>
            <p class="subtitle">ë³´í—˜ê¸ˆ ì²­êµ¬ì„œì— ìë™ìœ¼ë¡œ ì…ë ¥ë  í•„ë“œë¥¼ í´ë¦­ìœ¼ë¡œ ê°„í¸í•˜ê²Œ ì„¤ì •í•˜ì„¸ìš”</p>
        </div>
        
        <div class="instructions">
            <h3>ğŸ¯ ì‚¬ìš© ë°©ë²•</h3>
            <ol>
                <li><strong>PDF ì—…ë¡œë“œ:</strong> ë³´í—˜ì‚¬ ì²­êµ¬ì„œ PDF íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.</li>
                <li><strong>ë³´í—˜ì‚¬ í‚¤ ì…ë ¥:</strong> ì˜ë¬¸ ë³´í—˜ì‚¬ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: HYUNDAI_MARINE, DB_INSURANCE).</li>
                <li><strong>ë¹ ë¥¸ í•„ë“œ ì¶”ê°€:</strong> ìš°ì¸¡ "ë¹ ë¥¸ ì¶”ê°€" ë²„íŠ¼ìœ¼ë¡œ ìì£¼ ì‚¬ìš©í•˜ëŠ” í•„ë“œë¥¼ í•œë²ˆì— ì¶”ê°€í•˜ì„¸ìš”.</li>
                <li><strong>ì¢Œí‘œ í´ë¦­:</strong> ë…¸ë€ìƒ‰ìœ¼ë¡œ í‘œì‹œëœ "ëŒ€ê¸° ì¤‘" í•„ë“œë¥¼ í´ë¦­í•˜ê³ , PDFì˜ ì…ë ¥ë€ ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ì„¸ìš”.</li>
                <li><strong>ì½”ë“œ ìƒì„±:</strong> ëª¨ë“  í•„ë“œë¥¼ ì„¤ì •í•˜ë©´ ìë™ìœ¼ë¡œ JavaScript ì½”ë“œê°€ ìƒì„±ë©ë‹ˆë‹¤.</li>
                <li><strong>ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰:</strong> "ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ ì €ì¥" ë²„íŠ¼ìœ¼ë¡œ ì‹¤í–‰ ê°€ëŠ¥í•œ JS íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”.</li>
            </ol>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="value" id="stat-total">0</div>
                <div class="label">ì „ì²´ í•„ë“œ</div>
            </div>
            <div class="stat-card">
                <div class="value" id="stat-waiting">0</div>
                <div class="label">ëŒ€ê¸° ì¤‘</div>
            </div>
            <div class="stat-card">
                <div class="value" id="stat-complete">0</div>
                <div class="label">ì™„ë£Œ</div>
            </div>
        </div>
        
        <div class="tools">
            <label for="pdf-upload" style="background: #3a64ff; color: white; border-color: #3a64ff;">
                ğŸ“„ PDF ì—…ë¡œë“œ
                <input type="file" id="pdf-upload" accept="application/pdf">
            </label>
            
            <input type="text" id="carrier-key" placeholder="ë³´í—˜ì‚¬ í‚¤ (ì˜ˆ: HYUNDAI_MARINE)" />
            
            <select id="page-select" disabled>
                <option>í˜ì´ì§€ ì„ íƒ...</option>
            </select>
            
            <select id="scale-select">
                <option value="1">100%</option>
                <option value="1.5" selected>150%</option>
                <option value="2">200%</option>
            </select>
            
            <button id="clear-all" disabled>ğŸ—‘ï¸ ì „ì²´ ì´ˆê¸°í™”</button>
        </div>
        
        <div class="workspace">
            <div class="canvas-wrapper">
                <div class="coord-display" id="coord-display" style="display: none;">
                    <div>Canvas: <span id="coord-canvas">X: 0, Y: 0</span></div>
                    <div>PDF: <span id="coord-pdf">X: 0, Y: 0</span></div>
                </div>
                <div class="canvas-container">
                    <canvas id="pdf-canvas"></canvas>
                    <div class="crosshair crosshair-h" id="crosshair-h" style="display: none;"></div>
                    <div class="crosshair crosshair-v" id="crosshair-v" style="display: none;"></div>
                </div>
            </div>
            
            <div class="panel">
                <h2>í•„ë“œ ì„¤ì •</h2>
                
                <div class="quick-fields">
                    <h3>âš¡ ë¹ ë¥¸ ì¶”ê°€ (í´ë¦­ í•œë²ˆì— ì—¬ëŸ¬ í•„ë“œ ì¶”ê°€)</h3>
                    <div class="quick-btn-grid">
                        <button class="quick-btn" onclick="addQuickFields('basic')">ê¸°ë³¸ ì •ë³´</button>
                        <button class="quick-btn" onclick="addQuickFields('subscriber')">ê³„ì•½ì</button>
                        <button class="quick-btn" onclick="addQuickFields('insured')">í”¼ë³´í—˜ì</button>
                        <button class="quick-btn" onclick="addQuickFields('address')">ì£¼ì†Œ</button>
                        <button class="quick-btn" onclick="addQuickFields('bank')">ê³„ì¢Œ</button>
                        <button class="quick-btn" onclick="addQuickFields('accident')">ì‚¬ê³ ì •ë³´</button>
                        <button class="quick-btn" onclick="addQuickFields('date')">ì²­êµ¬ì¼</button>
                        <button class="quick-btn" onclick="addQuickFields('all')">ğŸ“¦ ì „ì²´</button>
                    </div>
                </div>
                
                <div class="field-list" id="field-list">
                    <p style="text-align: center; color: #6b7280; padding: 20px;">ìœ„ "ë¹ ë¥¸ ì¶”ê°€" ë²„íŠ¼ì„ ëˆŒëŸ¬ í•„ë“œë¥¼ ì¶”ê°€í•˜ì„¸ìš”</p>
                </div>
                
                <div class="export-section">
                    <h3>ğŸ“¤ ìƒì„±ëœ ì½”ë“œ</h3>
                    <textarea id="export-code" readonly placeholder="í•„ë“œ ì¢Œí‘œë¥¼ ì„¤ì •í•˜ë©´ ìë™ìœ¼ë¡œ ì½”ë“œê°€ ìƒì„±ë©ë‹ˆë‹¤..."></textarea>
                    <div class="btn-group">
                        <button onclick="copyCode()">ğŸ“‹ ì½”ë“œ ë³µì‚¬</button>
                        <button class="secondary" onclick="downloadScript()">ğŸ’¾ ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ ì €ì¥</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let pdfDoc = null;
        let currentPage = 1;
        let scale = 1.5;
        let waitingFieldIndex = -1;
        let fields = [];
        let fileName = '';

        const canvas = document.getElementById('pdf-canvas');
        const ctx = canvas.getContext('2d');

        // ============== ë¹ ë¥¸ í•„ë“œ ì •ì˜ ==============
        const QUICK_FIELD_SETS = {
            basic: [
                { name: 'ins_name', label: 'í”¼ë³´í—˜ì ì´ë¦„', type: 'text', width: 200, height: 30, fontSize: 12 },
                { name: 'sub_name', label: 'ê³„ì•½ì ì´ë¦„', type: 'text', width: 200, height: 30, fontSize: 12 },
            ],
            subscriber: [
                { name: 'sub_name', label: 'ê³„ì•½ì ì´ë¦„', type: 'text', width: 200, height: 30, fontSize: 12 },
                { name: 'sub_rrn1', label: 'ê³„ì•½ì ì£¼ë¯¼ë²ˆí˜¸ ì•', type: 'text', width: 80, height: 30, fontSize: 11 },
                { name: 'sub_rrn2', label: 'ê³„ì•½ì ì£¼ë¯¼ë²ˆí˜¸ ë’¤', type: 'text', width: 100, height: 30, fontSize: 11 },
                { name: 'sub_full_phone', label: 'ê³„ì•½ì ì „í™”ë²ˆí˜¸', type: 'text', width: 150, height: 30, fontSize: 11 },
            ],
            insured: [
                { name: 'ins_name', label: 'í”¼ë³´í—˜ì ì´ë¦„', type: 'text', width: 200, height: 30, fontSize: 12 },
                { name: 'ins_rrn1', label: 'í”¼ë³´í—˜ì ì£¼ë¯¼ë²ˆí˜¸ ì•', type: 'text', width: 80, height: 30, fontSize: 11 },
                { name: 'ins_rrn2', label: 'í”¼ë³´í—˜ì ì£¼ë¯¼ë²ˆí˜¸ ë’¤', type: 'text', width: 100, height: 30, fontSize: 11 },
                { name: 'ins_full_phone', label: 'í”¼ë³´í—˜ì ì „í™”ë²ˆí˜¸', type: 'text', width: 150, height: 30, fontSize: 11 },
            ],
            address: [
                { name: 'zip', label: 'ìš°í¸ë²ˆí˜¸', type: 'text', width: 80, height: 30, fontSize: 11 },
                { name: 'addr', label: 'ë„ë¡œëª…ì£¼ì†Œ', type: 'text', width: 400, height: 30, fontSize: 10 },
                { name: 'addr_detail', label: 'ìƒì„¸ì£¼ì†Œ', type: 'text', width: 400, height: 30, fontSize: 10 },
            ],
            bank: [
                { name: 'bank_name', label: 'ì€í–‰ëª…', type: 'text', width: 150, height: 30, fontSize: 11 },
                { name: 'bank_account', label: 'ê³„ì¢Œë²ˆí˜¸', type: 'text', width: 200, height: 30, fontSize: 11 },
                { name: 'bank_depositor', label: 'ì˜ˆê¸ˆì£¼', type: 'text', width: 150, height: 30, fontSize: 11 },
            ],
            accident: [
                { name: 'accident_date', label: 'ì‚¬ê³ ì¼/ë°œë³‘ì¼', type: 'text', width: 150, height: 30, fontSize: 11 },
                { name: 'diagnosis', label: 'ì§„ë‹¨ëª…', type: 'text', width: 300, height: 30, fontSize: 11 },
                { name: 'hospital_name', label: 'ë³‘ì›ëª…', type: 'text', width: 250, height: 30, fontSize: 11 },
                { name: 'accident_detail', label: 'ì‚¬ê³  ê²½ìœ„', type: 'text', width: 350, height: 40, fontSize: 10 },
            ],
            date: [
                { name: 'date_y_full', label: 'ì²­êµ¬ì¼ ì—°ë„(4ì)', type: 'text', width: 50, height: 25, fontSize: 11 },
                { name: 'date_y_short', label: 'ì²­êµ¬ì¼ ì—°ë„(2ì)', type: 'text', width: 35, height: 25, fontSize: 11 },
                { name: 'date_m', label: 'ì²­êµ¬ì¼ ì›”', type: 'text', width: 35, height: 25, fontSize: 11 },
                { name: 'date_d', label: 'ì²­êµ¬ì¼ ì¼', type: 'text', width: 35, height: 25, fontSize: 11 },
            ],
            all: [] // ì•„ë˜ì—ì„œ ì¡°í•©
        };

        // 'all'ì€ ëª¨ë“  í•„ë“œ ì¡°í•©
        QUICK_FIELD_SETS.all = [
            ...QUICK_FIELD_SETS.insured,
            ...QUICK_FIELD_SETS.subscriber,
            ...QUICK_FIELD_SETS.address,
            ...QUICK_FIELD_SETS.bank,
            ...QUICK_FIELD_SETS.accident,
            ...QUICK_FIELD_SETS.date,
            { name: 'employer_job', label: 'ì§ì¥/ì§ë¬´', type: 'text', width: 250, height: 30, fontSize: 11 },
            { name: 'claim_type_sickness', label: 'ì§ˆë³‘ ì²´í¬', type: 'checkbox', width: 15, height: 15 },
            { name: 'claim_type_injury', label: 'ìƒí•´ ì²´í¬', type: 'checkbox', width: 15, height: 15 },
            { name: 'claim_detail_hospital', label: 'ì…ì› ì²´í¬', type: 'checkbox', width: 15, height: 15 },
            { name: 'claim_detail_outpatient', label: 'í†µì› ì²´í¬', type: 'checkbox', width: 15, height: 15 },
            { name: 'claim_detail_surgery', label: 'ìˆ˜ìˆ  ì²´í¬', type: 'checkbox', width: 15, height: 15 },
        ];

        // ============== ë¹ ë¥¸ í•„ë“œ ì¶”ê°€ ==============
        window.addQuickFields = function(setName) {
            const set = QUICK_FIELD_SETS[setName];
            if (!set) return;
            
            // ì¤‘ë³µ ì²´í¬
            const existingNames = new Set(fields.map(f => f.name));
            const newFields = set.filter(f => !existingNames.has(f.name));
            
            if (newFields.length === 0) {
                alert('ì„ íƒí•œ í•„ë“œë“¤ì´ ì´ë¯¸ ëª¨ë‘ ì¶”ê°€ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            newFields.forEach(fieldDef => {
                fields.push({
                    ...fieldDef,
                    x: null,
                    y: null,
                    pdfX: null,
                    pdfY: null,
                    page: null
                });
            });
            
            updateFieldList();
            updateStats();
            
            alert(`âœ… ${newFields.length}ê°œ í•„ë“œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.\në…¸ë€ìƒ‰ í•„ë“œë¥¼ í´ë¦­í•˜ê³  PDFì—ì„œ ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ì„¸ìš”.`);
        };

        // ============== PDF ì—…ë¡œë“œ ==============
        document.getElementById('pdf-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            fileName = file.name;
            const fileReader = new FileReader();
            
            fileReader.onload = async (event) => {
                const typedArray = new Uint8Array(event.target.result);
                pdfDoc = await pdfjsLib.getDocument(typedArray).promise;
                
                // í˜ì´ì§€ ì„ íƒ í™œì„±í™”
                const pageSelect = document.getElementById('page-select');
                pageSelect.disabled = false;
                pageSelect.innerHTML = '';
                for (let i = 1; i <= pdfDoc.numPages; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `í˜ì´ì§€ ${i}`;
                    pageSelect.appendChild(option);
                }
                
                document.getElementById('clear-all').disabled = false;
                
                renderPage(currentPage);
            };
            
            fileReader.readAsArrayBuffer(file);
        });

        // ============== í˜ì´ì§€/ìŠ¤ì¼€ì¼ ë³€ê²½ ==============
        document.getElementById('page-select').addEventListener('change', (e) => {
            currentPage = parseInt(e.target.value);
            renderPage(currentPage);
        });

        document.getElementById('scale-select').addEventListener('change', (e) => {
            scale = parseFloat(e.target.value);
            renderPage(currentPage);
        });

        // ============== PDF ë Œë”ë§ ==============
        async function renderPage(pageNum) {
            if (!pdfDoc) return;
            
            const page = await pdfDoc.getPage(pageNum);
            const viewport = page.getViewport({ scale });
            
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            
            const renderContext = {
                canvasContext: ctx,
                viewport: viewport
            };
            
            await page.render(renderContext).promise;
            drawMarkers();
        }

        // ============== ë§ˆì»¤ ê·¸ë¦¬ê¸° ==============
        function drawMarkers() {
            document.querySelectorAll('.marker').forEach(m => m.remove());
            
            fields.forEach((field, idx) => {
                if (field.x !== null && field.y !== null && field.page === currentPage) {
                    const marker = document.createElement('div');
                    marker.className = 'marker';
                    marker.style.left = field.x + 'px';
                    marker.style.top = field.y + 'px';
                    
                    marker.innerHTML = `
                        <div class="marker-dot"></div>
                        <div class="marker-label">${idx + 1}. ${field.label}</div>
                    `;
                    
                    document.querySelector('.canvas-container').appendChild(marker);
                }
            });
        }

        // ============== ë§ˆìš°ìŠ¤ ì´ë™ ==============
        canvas.addEventListener('mousemove', (e) => {
            if (!pdfDoc) return;
            
            const rect = canvas.getBoundingClientRect();
            const canvasX = Math.round(e.clientX - rect.left);
            const canvasY = Math.round(e.clientY - rect.top);
            const pdfX = Math.round(canvasX / scale);
            const pdfY = Math.round((canvas.height - canvasY) / scale);
            
            document.getElementById('crosshair-h').style.top = canvasY + 'px';
            document.getElementById('crosshair-h').style.display = 'block';
            document.getElementById('crosshair-v').style.left = canvasX + 'px';
            document.getElementById('crosshair-v').style.display = 'block';
            
            document.getElementById('coord-canvas').textContent = `X: ${canvasX}, Y: ${canvasY}`;
            document.getElementById('coord-pdf').textContent = `X: ${pdfX}, Y: ${pdfY}`;
            document.getElementById('coord-display').style.display = 'block';
        });

        canvas.addEventListener('mouseleave', () => {
            document.getElementById('crosshair-h').style.display = 'none';
            document.getElementById('crosshair-v').style.display = 'none';
            document.getElementById('coord-display').style.display = 'none';
        });

        // ============== ìº”ë²„ìŠ¤ í´ë¦­ ==============
        canvas.addEventListener('click', (e) => {
            if (waitingFieldIndex === -1) {
                alert('ë¨¼ì € í•„ë“œ ëª©ë¡ì—ì„œ ë…¸ë€ìƒ‰ í•„ë“œë¥¼ í´ë¦­í•˜ì„¸ìš”!');
                return;
            }
            
            const rect = canvas.getBoundingClientRect();
            const canvasX = e.clientX - rect.left;
            const canvasY = e.clientY - rect.top;
            const pdfX = Math.round(canvasX / scale);
            const pdfY = Math.round((canvas.height - canvasY) / scale);
            
            fields[waitingFieldIndex].x = canvasX;
            fields[waitingFieldIndex].y = canvasY;
            fields[waitingFieldIndex].pdfX = pdfX;
            fields[waitingFieldIndex].pdfY = pdfY;
            fields[waitingFieldIndex].page = currentPage;
            
            // ë‹¤ìŒ ëŒ€ê¸° í•„ë“œ ìë™ ì„ íƒ
            waitingFieldIndex = -1;
            const nextWaitingIdx = fields.findIndex(f => f.pdfX === null);
            if (nextWaitingIdx !== -1) {
                waitingFieldIndex = nextWaitingIdx;
            }
            
            updateFieldList();
            updateStats();
            updateExportCode();
            drawMarkers();
        });

        // ============== í•„ë“œ ëª©ë¡ ì—…ë°ì´íŠ¸ ==============
        function updateFieldList() {
            const container = document.getElementById('field-list');
            
            if (fields.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">ìœ„ "ë¹ ë¥¸ ì¶”ê°€" ë²„íŠ¼ì„ ëˆŒëŸ¬ í•„ë“œë¥¼ ì¶”ê°€í•˜ì„¸ìš”</p>';
                return;
            }
            
            container.innerHTML = '';
            fields.forEach((field, idx) => {
                const isWaiting = idx === waitingFieldIndex;
                const isComplete = field.pdfX !== null;
                
                const item = document.createElement('div');
                item.className = 'field-item';
                if (isWaiting) item.classList.add('waiting');
                if (isComplete) item.classList.add('complete');
                
                const status = isComplete ? 
                    `P${field.page} (${field.pdfX}, ${field.pdfY})` : 
                    isWaiting ? 'ğŸ‘† í´ë¦­ ëŒ€ê¸° ì¤‘...' : 'ëŒ€ê¸°';
                
                item.innerHTML = `
                    <div class="index">${idx + 1}</div>
                    <div class="info">
                        <div class="name">${field.label} [${field.type}]</div>
                        <div class="coords">${status}</div>
                    </div>
                    <button class="edit" onclick="setWaitingField(${idx})">ğŸ“ ì„¤ì •</button>
                    <button class="delete" onclick="deleteField(${idx})">ğŸ—‘ï¸</button>
                `;
                
                container.appendChild(item);
            });
        }

        window.setWaitingField = function(idx) {
            waitingFieldIndex = idx;
            updateFieldList();
        };

        window.deleteField = function(idx) {
            fields.splice(idx, 1);
            if (waitingFieldIndex === idx) waitingFieldIndex = -1;
            else if (waitingFieldIndex > idx) waitingFieldIndex--;
            updateFieldList();
            updateStats();
            updateExportCode();
            drawMarkers();
        };

        // ============== í†µê³„ ì—…ë°ì´íŠ¸ ==============
        function updateStats() {
            const total = fields.length;
            const complete = fields.filter(f => f.pdfX !== null).length;
            const waiting = total - complete;
            
            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-waiting').textContent = waiting;
            document.getElementById('stat-complete').textContent = complete;
        }

        // ============== ì½”ë“œ ìƒì„± ==============
        function updateExportCode() {
            const carrierKey = document.getElementById('carrier-key').value.trim() || 'CARRIER_KEY';
            const completeFields = fields.filter(f => f.pdfX !== null);
            
            if (completeFields.length === 0) {
                document.getElementById('export-code').value = '// í•„ë“œ ì¢Œí‘œë¥¼ ì„¤ì •í•˜ì„¸ìš”';
                return;
            }
            
            const fieldLines = completeFields.map((f, idx) => {
                const typeComment = f.type === 'checkbox' ? ' // ì²´í¬ë°•ìŠ¤' : f.type === 'radio' ? ' // ë¼ë””ì˜¤' : '';
                return `      { name: '${f.name}', type: '${f.type}', page: ${f.page - 1}, x: ${f.pdfX}, y: ${f.pdfY}, width: ${f.width}, height: ${f.height}, fontSize: ${f.fontSize || 11} }${typeComment}`;
            }).join(',\n');
            
            const code = `// ${carrierKey} AcroForm í•„ë“œ ì •ì˜
// íŒŒì¼: ${fileName}
// ìƒì„±ì¼: ${new Date().toLocaleString('ko-KR')}

const FIELD_DEFINITIONS = {
  ${carrierKey}: {
    inputFile: 'assets/pdf-templates/${carrierKey}-template.pdf',
    outputFile: 'assets/pdf-templates/${carrierKey}-template-acroform.pdf',
    fields: [
${fieldLines}
    ]
  }
};

// create-acroform-template.js ìŠ¤í¬ë¦½íŠ¸ì— ìœ„ ì½”ë“œë¥¼ ì¶”ê°€í•˜ì„¸ìš”!`;
            
            document.getElementById('export-code').value = code;
        }

        // ============== ì½”ë“œ ë³µì‚¬ ==============
        window.copyCode = function() {
            const textarea = document.getElementById('export-code');
            textarea.select();
            document.execCommand('copy');
            
            alert('âœ… ì½”ë“œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        };

        // ============== ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ==============
        window.downloadScript = function() {
            const carrierKey = document.getElementById('carrier-key').value.trim() || 'CARRIER_KEY';
            const code = document.getElementById('export-code').value;
            
            const blob = new Blob([code], { type: 'text/javascript' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${carrierKey}-fields.js`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert(`âœ… ${carrierKey}-fields.js íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!`);
        };

        // ============== ì´ˆê¸°í™” ==============
        document.getElementById('clear-all').addEventListener('click', () => {
            if (!confirm('ëª¨ë“  í•„ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            fields = [];
            waitingFieldIndex = -1;
            
            updateFieldList();
            updateStats();
            updateExportCode();
            drawMarkers();
        });

        // ============== ì´ˆê¸° ìƒíƒœ ==============
        updateFieldList();
        updateStats();
        updateExportCode();
    </script>
</body>
</html>

